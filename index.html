<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SB3 Call Tool</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/shoelace.js"></script>
    <style>
        :root {
            --dark-bg-primary: #1e1e1e;
            --dark-bg-secondary: #2c2c2c;
            --dark-bg-tertiary: #383838;
            --dark-text-primary: #e0e0e0;
            --dark-text-secondary: #b0b0b0;
            --accent-green: #4CAF50;
            --accent-green-darker: #388E3C;
            --border-color-dark: #444444;
            --utility-button-bg: #5a5a5a;
            --utility-button-hover-bg: #4a4a4a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 25px;
            background-color: var(--dark-bg-secondary);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--accent-green);
        }
        header h1 {
            color: var(--accent-green);
            margin: 0 0 5px 0;
            font-size: 2.2em;
        }
        .version-number {
            display: block;
            font-size: 0.8em;
            color: var(--dark-text-secondary);
            margin-bottom: 10px;
        }

        header p {
            color: var(--dark-text-secondary);
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .report-problem-link {
            font-size: 0.85em;
            color: var(--dark-text-secondary);
        }
        .report-problem-link a {
            color: var(--accent-green-darker);
        }
        .report-problem-link a:hover {
            color: var(--accent-green);
        }


        .controls, .email-template-section {
            margin-bottom: 25px;
            padding: 15px;
            background-color: var(--dark-bg-tertiary);
            border-radius: 6px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .email-template-section {
            flex-direction: column;
            align-items: flex-start;
        }

        .email-template-section label {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--dark-text-primary);
        }
        
        .email-template-section input[type="text"],
        .email-template-section textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color-dark);
            border-radius: 4px;
            font-size: 0.95em;
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }
        .email-template-section input[type="text"]:focus,
        .email-template-section textarea:focus {
            border-color: var(--accent-green);
            outline: none;
        }
        
        .email-template-section textarea {
            min-height: 120px; 
            resize: vertical;
        }
        .email-template-section small {
            color: var(--dark-text-secondary);
        }

        /* Toggle Switch Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            flex-shrink: 0;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-green);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .toggle-label {
            margin-right: 10px;
            font-weight: bold;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Hamburger Menu & Sidenav */
        .sidenav {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1001;
            top: 0;
            left: 0;
            background-color: var(--dark-bg-secondary);
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
        }
        .sidenav a, .sidenav .toggle-container, .sidenav .sidenav-link {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 1.1em;
            color: var(--dark-text-primary);
            display: block;
            transition: 0.3s;
            cursor: pointer;
        }
        .sidenav a:hover, .sidenav .sidenav-link:hover {
            color: var(--accent-green);
        }
        .sidenav .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }
        .hamburger-btn {
            cursor: pointer;
            color: var(--dark-text-primary);
            background-color: var(--utility-button-bg);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .hamburger-btn sl-icon {
            font-size: 24px;
        }
        .hamburger-btn:hover {
            background-color: var(--utility-button-hover-bg);
        }
        .floating-hamburger-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        /* Scroll-to-top button */
        #scrollTopBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: var(--accent-green);
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            font-size: 18px;
            width: 50px;
            height: 50px;
        }
        #scrollTopBtn:hover {
            background-color: var(--accent-green-darker);
        }


        .controls button, .controls label.button-like {
            padding: 10px 15px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .table-container {
            overflow-x: auto; 
            overflow-y: auto;
            max-height: 600px;
            margin-bottom: 20px; 
            border: 1px solid var(--border-color-dark);
            border-radius: 4px;
            position: relative;
            /* Force scrollbar to always show on desktop */
            overflow-y: scroll !important;
            /* Ensure minimum height for scrollbar visibility */
            min-height: 200px;
        }
        
        /* Custom scrollbar styling for table containers */
        .table-container::-webkit-scrollbar {
            width: 16px; /* Increased from 12px */
            height: 16px; /* Increased from 12px */
        }
        
        .table-container::-webkit-scrollbar-track {
            background: var(--dark-bg-tertiary);
            border: 1px solid var(--border-color-dark);
            border-radius: 8px;
            box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.3);
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: var(--accent-green);
            border-radius: 8px;
            border: 2px solid var(--accent-green-darker);
            box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.2);
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--accent-green-darker);
            box-shadow: 0 0 4px 2px rgba(76, 175, 80, 0.6);
        }
        
        /* Firefox scrollbar styling */
        .table-container {
            scrollbar-width: thick;
            scrollbar-color: var(--accent-green) var(--dark-bg-tertiary);
        }
        
        /* Ensure scrollbar corner is visible */
        .table-container::-webkit-scrollbar-corner {
            background: var(--dark-bg-tertiary);
        }
        
        /* Add a visual indicator when content is scrollable */
        .table-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 16px; /* Account for scrollbar width */
            height: 30px;
            background: linear-gradient(to bottom, transparent, rgba(30, 30, 30, 0.9));
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 2;
        }
        
        .table-container.has-scroll::after {
            opacity: 1;
        }
        
        /* Add a scroll indicator message */
        .scroll-indicator-message {
            position: absolute;
            bottom: 5px;
            right: 25px;
            background-color: var(--accent-green);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            z-index: 3;
            display: none;
            animation: pulse 2s infinite;
        }
        
        .table-container.has-scroll .scroll-indicator-message {
            display: block;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }

        table {
            width: 100%; 
            border-collapse: collapse;
            table-layout: fixed; 
        }

        th, td {
            padding: 12px 8px; 
            text-align: left;
            border-bottom: 1px solid var(--border-color-dark);
            vertical-align: middle;
            word-break: break-word; 
            overflow-wrap: break-word;
        }
        
        /* Collapsible list styles */
        .list-section {
            margin-bottom: 40px;
            border: 1px solid var(--border-color-dark);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background-color: var(--dark-bg-tertiary);
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s ease;
        }
        
        .list-header:hover {
            background-color: #404040;
        }
        
        .list-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 0;
            color: var(--accent-green);
            font-size: 1.5em;
        }
        
        .collapse-icon {
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }
        
        .list-section.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        
        .rep-count {
            font-size: 0.8em;
            color: var(--dark-text-secondary);
            font-weight: normal;
        }
        
        .list-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .list-section.collapsed .list-content {
            max-height: 0;
        }
        
        /* Sortable column styles */
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 30px;
            white-space: normal; /* Allow text wrapping */
            overflow: visible; /* Show all content */
            min-width: 60px;
        }
        
        th.sortable:hover {
            background-color: var(--accent-green-darker);
        }
        
        .sort-indicator {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.9);
            width: 20px;
            text-align: center;
        }
        
        th.sort-asc .sort-indicator::after {
            content: '▲';
            color: white;
        }
        
        th.sort-desc .sort-indicator::after {
            content: '▼';
            color: white;
        }
        
        th.sortable:not(.sort-asc):not(.sort-desc) .sort-indicator::after {
            content: '⇅';
            opacity: 0.5;
        }
        
        td a { 
            word-break: break-all;
            overflow-wrap: break-word; 
        }

        th {
            background-color: var(--accent-green);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1;
            font-size: 0.9em;
            height: 45px;
        }
        
        th:nth-child(1), td:nth-child(1) { width: 6%; }  /* Called */
        th:nth-child(2), td:nth-child(2) { width: 6%; }  /* Emailed */
        th:nth-child(3), td:nth-child(3) { width: 6%; }  /* District */
        th:nth-child(4), td:nth-child(4) { width: 18%; } /* Representative */
        th:nth-child(5), td:nth-child(5) { width: 5%; }  /* Party */
        th:nth-child(6), td:nth-child(6) { width: 20%; } /* Email */
        th:nth-child(7), td:nth-child(7) { width: 14%; } /* Phone */
        th:nth-child(8), td:nth-child(8) { width: 25%; } /* Response Summary */


        tr:nth-child(even) {
            background-color: var(--dark-bg-tertiary); 
        }

        tr:hover {
            background-color: #404040; 
        }

        input[type="checkbox"] {
            transform: scale(1.2); 
            margin-right: 3px; 
            cursor: pointer;
            vertical-align: middle;
        }
        
        a { 
            color: var(--accent-green);
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
            color: var(--accent-green-darker);
        }
        
        .footer-actions {
            margin-top: 30px;
            text-align: right;
            min-height: 40px; /* Ensure space even if button is removed */
        }
         .footer-actions button { 
            margin-left: 10px;
            background-color: var(--accent-green);
            color: white; 
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
         }
         .footer-actions button:hover {
            background-color: var(--accent-green-darker);
         }

        .response-summary-cell {
            font-size: 0.85em;
            color: var(--dark-text-secondary);
            line-height: 1.4;
        }
        .response-summary-cell i {
            color: #888;
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.7); 
            padding-top: 40px;
        }

        .modal-content {
            background-color: var(--dark-bg-secondary);
            margin: 5% auto; 
            padding: 25px;
            border: 1px solid var(--border-color-dark);
            width: 80%; 
            max-width: 600px; 
            border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.4),0 6px 20px 0 rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-content h2, .modal-content h3 {
            margin-top: 0;
            color: var(--accent-green);
        }
        .modal-content h4 { 
            color: var(--accent-green-darker);
            margin-top: 1.2em;
            margin-bottom: 0.5em;
        }

        .modal-content label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark-text-primary);
        }
        .modal-content input[type="text"], 
        .modal-content select, 
        .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color-dark);
            border-radius: 4px;
            font-size: 1em;
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }
        .modal-content input[type="text"]:focus, 
        .modal-content select:focus, 
        .modal-content textarea:focus {
            border-color: var(--accent-green);
            outline: none;
        }
        .modal-content select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e0e0e0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
            padding-right: 2em;
        }
        .modal-content textarea {
            min-height: 100px;
            resize: vertical;
        }
        .modal-content button { 
            background-color: var(--accent-green);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
            margin-right: 10px;
        }
        .modal-content button:hover {
            background-color: var(--accent-green-darker);
        }
        .modal-content button.button-outline { 
            background-color: transparent;
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }
        .modal-content button.button-outline:hover {
            background-color: rgba(76, 175, 80, 0.1); 
        }
        .modal-content ul {
            padding-left: 20px;
            margin-top: 0.5em;
        }
        .modal-content li {
            margin-bottom: 0.5em;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        
        /* New styles for multi-step modal */
        .modal-step { display: none; }
        .modal-step.active { display: block; }
        .modal-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .modal-navigation button {
            padding: 10px 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        .form-group input[type="text"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color-dark);
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .radio-group label,
        .checkbox-group label {
            font-weight: normal;
            display: block;
            margin-bottom: 5px;
        }
        .radio-group input,
        .checkbox-group input {
            margin-right: 10px;
        }
        .caveat-section {
            margin-left: 25px;
            margin-top: 5px;
        }
        .caveat-section input {
            width: calc(100% - 80px);
            display: inline-block;
        }
        .add-caveat-btn {
            font-size: 0.8em;
            padding: 4px 8px;
            margin-left: 10px;
            background-color: var(--utility-button-bg);
            display: none; /* Hidden by default */
        }
        .hidden {
            display: none !important;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--dark-text-primary);
            text-decoration: none;
            cursor: pointer;
        }

        @media screen and (max-width: 768px) {
            .container { 
                width: 98%; 
                padding: 10px; 
                margin-top: 10px;
                border-radius: 4px;
            }
            header h1 { font-size: 1.8em; }
            header p { font-size: 1em; }
            .controls { 
                flex-direction: column;
                gap: 8px;
            }
            .controls button, .controls label.button-like { 
                width: 100%; 
                padding: 12px 20px;
                font-size: 1em;
            }

            /* List content scrolling on mobile */
            .list-content {
                max-height: 500px; /* Set a reasonable height for mobile */
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
                position: relative;
            }

            /* Cards container scrolling */
            .cards-container {
                max-height: 500px;
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                padding: 10px 0;
                scroll-behavior: smooth;
            }

            /* Table container adjustments for mobile */
            .table-container {
                max-height: none; /* Remove height restriction on mobile */
                border-radius: 0;
                margin: -10px; /* Extend to edges */
                border-left: none;
                border-right: none;
            }

            /* Table adjustments */
            table {
                table-layout: auto; /* Let content determine width */
                min-width: 700px; /* Ensure table has minimum width for scrolling */
            }

            th, td { 
                padding: 10px 8px; 
                font-size: 0.875em; /* Minimum readable size */
                white-space: normal; /* Allow text wrapping */
            }
            
            /* Remove fixed widths - let content determine */
            th:nth-child(1), td:nth-child(1), 
            th:nth-child(2), td:nth-child(2) { 
                width: auto;
                min-width: 50px;
            }
            th:nth-child(3), td:nth-child(3) { 
                width: auto;
                min-width: 60px;
            }
            th:nth-child(4), td:nth-child(4) { 
                width: auto;
                min-width: 150px;
            }
            th:nth-child(5), td:nth-child(5) { 
                width: auto;
                min-width: 40px;
            }
            th:nth-child(6), td:nth-child(6), 
            th:nth-child(7), td:nth-child(7) { 
                width: auto;
                min-width: 120px;
            }
            th:nth-child(8), td:nth-child(8) { 
                width: auto;
                min-width: 150px;
            }

            /* Larger touch targets */
            input[type="checkbox"] {
                transform: scale(1.5);
                margin: 5px;
            }

            /* Modal adjustments */
            .modal-content { 
                width: 95%; 
                margin: 5% auto; 
                padding: 15px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* List header adjustments */
            .list-header {
                padding: 15px;
            }
            
            .list-title {
                font-size: 1.2em;
                flex-wrap: wrap;
            }
            
            .rep-count {
                display: block;
                margin-top: 5px;
            }
        }
        
        @media screen and (max-width: 480px) {
            header h1 { font-size: 1.5em; }
            .version-number { font-size: 0.8em; }
            .report-problem-link { font-size: 0.85em; }

            /* Ensure minimum readable font size */
            th, td { 
                padding: 8px 6px; 
                font-size: 0.8125em; /* ~13px minimum */
            }
            
            /* All columns remain visible - no hiding */
            th, td { 
                display: table-cell !important; 
            }
            
            /* Ensure table scrolls horizontally on very small screens */
            .table-container {
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            }
            
            /* Better button sizing for small screens */
            .controls button, .controls label.button-like { 
                padding: 14px 20px;
                font-size: 0.95em;
            }
            
            /* Email template section on mobile */
            .email-template-section {
                padding: 10px;
            }
            
            .email-template-section textarea {
                min-height: 100px;
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            .email-template-section input[type="text"] {
                font-size: 16px; /* Prevent zoom on iOS */
            }
         }

        /* Loader Styles */
        #loader {
            position: fixed;
            left: 50%;
            top: 50%;
            z-index: 1001;
            width: 120px;
            height: 120px;
            margin: -76px 0 0 -76px;
            border: 16px solid var(--dark-bg-tertiary);
            border-radius: 50%;
            border-top: 16px solid var(--accent-green);
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Email Generation Spinner */
        .email-gen-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--accent-green);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        /* Email Rating Styles */
        .email-rating-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-top: -10px;
            margin-bottom: 15px;
            padding: 0;
            width: 100%;
        }

        /* Icon-only buttons with absolutely no background */
        .icon-btn {
            background: transparent !important;
            background-color: transparent !important;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 5px;
            flex: 1;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .icon-btn:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        .icon-btn span {
            font-size: 1em;
            filter: grayscale(100%) sepia(100%) hue-rotate(80deg) saturate(2);
            transition: all 0.3s ease;
            display: inline-block;
        }

        .icon-btn:hover span {
            transform: scale(1.15);
            filter: grayscale(100%) sepia(100%) hue-rotate(80deg) saturate(3) brightness(1.2);
        }

        .icon-btn:active span {
            transform: scale(0.95);
        }

        .icon-btn.selected span {
            transform: scale(1.1);
            filter: grayscale(100%) sepia(100%) hue-rotate(80deg) saturate(3) brightness(1.3);
        }

        .icon-btn.thumbs-down.selected span {
            filter: grayscale(100%) sepia(100%) hue-rotate(0deg) saturate(3) brightness(1.2);
        }

        .icon-btn small {
            font-size: 0.7em;
            color: var(--dark-text-secondary);
            text-align: center;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Feedback notification */
        .feedback-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--accent-green);
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1002;
        }

        .feedback-toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        @media screen and (max-width: 768px) {
            .email-rating-container {
                gap: 10px;
            }
            
            .rating-btn, .new-draft-btn {
                padding: 10px 15px;
                font-size: 0.95em;
                min-width: 100px;
            }
        }

        @media screen and (max-width: 480px) {
            .email-rating-container {
                gap: 8px;
            }
            
            .rating-btn, .new-draft-btn {
                padding: 8px 12px;
                font-size: 0.9em;
                min-width: 90px;
            }

            .rating-btn span, .new-draft-btn span {
                font-size: 1.1em;
            }
        }

        /* Shoelace copy button styles */
        .form-group.with-copy {
            position: relative;
        }

        .form-group.with-copy sl-copy-button {
            position: absolute;
            bottom: 25px;
            right: 8px;
            --sl-color-neutral-600: rgba(128, 128, 128, 0.8);
            --sl-color-primary-600: var(--accent-green);
        }

        .form-group.with-copy input[type="text"],
        .form-group.with-copy textarea {
            padding-right: 50px;
        }
        
        /* Mobile card layout */
        .cards-container {
            display: none;
            padding: 10px 0;
            position: relative;
        }
        
        /* Mobile scrollbar styling for cards container */
        .cards-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .cards-container::-webkit-scrollbar-track {
            background: var(--dark-bg-secondary);
            border-radius: 4px;
        }
        
        .cards-container::-webkit-scrollbar-thumb {
            background: var(--accent-green);
            border-radius: 4px;
        }
        
        .cards-container::-webkit-scrollbar-thumb:hover {
            background: var(--accent-green-darker);
        }
        
        .rep-card {
            background-color: var(--dark-bg-tertiary);
            border: 1px solid var(--border-color-dark);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .rep-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background-color: #404040;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color-dark);
        }
        
        .card-checkboxes {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .card-checkbox-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            color: var(--dark-text-secondary);
        }
        
        .card-district-party {
            font-size: 0.9em;
            color: var(--accent-green);
        }
        
        .card-name {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--dark-text-primary);
            margin-bottom: 10px;
        }
        
        .card-contact {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .card-contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-contact-item sl-icon {
            color: var(--accent-green);
            font-size: 1.1em;
        }
        
        .card-contact-item a {
            color: var(--accent-green);
            text-decoration: none;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .card-response {
            background-color: var(--dark-bg-secondary);
            padding: 10px;
            border-radius: 4px;
            font-size: 0.85em;
            color: var(--dark-text-secondary);
        }
        
        .card-response strong {
            color: var(--dark-text-primary);
        }
        
        @media screen and (max-width: 768px) {
            .table-container {
                display: none;
            }
            
            .cards-container {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div id="loader"></div>
    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" id="closeNavBtn"><sl-icon name="x-lg"></sl-icon></a>
        <a href="#" id="sideNavGuide">User Guide</a>
        <a href="#" id="sideNavExport">Export Progress</a>
        <label for="sideNavImportFile" class="sidenav-link">Import Progress</label>
        <input type="file" id="sideNavImportFile" accept=".json" style="display: none;">
        <a href="#" id="sideNavEditInfo">Edit My Info</a>
        <a href="#" id="sideNavReset">Reset All Data</a>
        <div class="toggle-container">
            <span class="toggle-label">AI Email Writing Assistance</span>
            <label class="switch">
                <input type="checkbox" id="llmToggle" checked>
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <button class="hamburger-btn floating-hamburger-btn" id="floatingNavBtn"><sl-icon name="list"></sl-icon></button>

    <div class="container">
        <header>
            <div>
                <h1>SB3 Call Tool</h1>
                <span class="version-number">v2.0 (IntelliDraft)</span>
                <p>Track your calls and emails to representatives, their responses, and your notes. Progress is saved automatically to your device and backed up to a secure cloud database.</p>
                <div id="homepageDistrictInfo" class="hidden" style="background-color: var(--dark-bg-primary); padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <div id="homepageDistrictDetails" style="color: var(--accent-green); font-size: 0.9em; line-height: 1.4;"></div>
                </div>
                <div class="report-problem-link">
                    <a href="mailto:hayden@delta8denton.com?subject=Problem Report - SB3 Call Tracker v1.1">Report Problems</a>
                </div>
            </div>
            <button class="hamburger-btn" id="openNavBtn"><sl-icon name="list"></sl-icon></button>
        </header>

        <div class="controls">
        </div>

        <div class="email-template-section hidden" id="emailTemplateSection">
            <label for="emailSubjectTemplate">Template Subject:</label>
            <input type="text" id="emailSubjectTemplate">
            <label for="emailBodyTemplate">Template Body:</label>
            <textarea id="emailBodyTemplate"></textarea>
            <small>Use placeholders: {repName}, {userName}, {userIdentity}</small>
        </div>

        <div id="your-representatives-container" class="hidden"></div>
        <div id="dynamic-tables-container"></div>

         <div class="footer-actions">
            <!-- Save All Changes button removed due to auto-save implementation -->
        </div>
    </div>

    <button id="scrollTopBtn" title="Go to top"><sl-icon name="arrow-up"></sl-icon></button>

    <div id="onboardingModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" id="closeOnboardingModal"><sl-icon name="x-lg"></sl-icon></span>
            <h2>Create Your Communications Profile</h2>
            <p>This optional info helps generate more personalized, effective messages. Your answers are saved to your device and backed up securely.</p>

            <!-- Step 1: Basic Info -->
            <div id="modalStep1" class="modal-step active">
                <h3>Step 1: About You</h3>
                <div class="form-group">
                    <label for="onboardingUserName">Your Full Name (for email signature):</label>
                    <input type="text" id="onboardingUserName" placeholder="e.g., Jane Doe">
                </div>
                <div class="form-group">
                    <label for="onboardingUserLocation">Your City/Town (e.g., "Austin resident"):</label>
                    <input type="text" id="onboardingUserLocation" placeholder="e.g., Austin, TX or concerned Texan">
                </div>
                <div class="form-group">
                    <label for="onboardingZipCode">What is your Zip Code?</label>
                    <input type="text" id="onboardingZipCode" placeholder="e.g., 78701">
                </div>
                <div id="districtInfo" class="form-group hidden" style="background-color: var(--dark-bg-primary); padding: 15px; border-radius: 5px; margin-top: 15px;">
                    <label style="color: var(--accent-green); margin-bottom: 10px; display: block;">Your Legislative Districts:</label>
                    <div id="districtDetails" style="color: var(--dark-text-secondary); line-height: 1.6;"></div>
                </div>
                <div class="form-group">
                    <label>Do you work in the Hemp Industry?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="hempIndustry" value="yes"> Yes</label>
                        <label><input type="radio" name="hempIndustry" value="no"> No</label>
                    </div>
                </div>
                <div class="form-group hidden" id="occupationGroup">
                    <label for="onboardingOccupation">What do you do?</label>
                    <input type="text" id="onboardingOccupation" placeholder="e.g., Teacher, Engineer, etc.">
                </div>
            </div>

            <!-- Step 2: Tone & Personality -->
            <div id="modalStep2" class="modal-step">
                <h3>Step 2: Your Voice</h3>
                <div class="form-group">
                    <label for="primaryToneSelect">Select your Primary Tone:</label>
                    <select id="primaryToneSelect"></select>
                </div>
                <div class="form-group">
                    <label>Select up to two supporting Personality Elements:</label>
                    <div id="personalityElementsContainer" class="checkbox-group"></div>
                </div>
            </div>

            <!-- Step 3: Personal Impact -->
            <div id="modalStep3" class="modal-step">
                <h3>Step 3: Your Story</h3>
                <div class="form-group">
                    <label for="banImpactStatement">What specifically would a THC ban mean to you?</label>
                    <textarea id="banImpactStatement" placeholder="Share your personal story or perspective."></textarea>
                </div>
                <div class="form-group">
                    <label for="additionalComments">Do you have any personal points or comments you would like to ensure are conveyed?</label>
                    <textarea id="additionalComments" placeholder="Add any other key points."></textarea>
                </div>
            </div>

            <!-- Step 4: Regulations SUPPORT -->
            <div id="modalStep4" class="modal-step">
                <h3>Step 4: Regulation Preferences (SUPPORT)</h3>
                <div class="form-group">
                    <label>Select which regulations you SUPPORT:</label>
                    <div id="supportedRegulationsContainer" class="checkbox-group"></div>
                </div>
            </div>

            <!-- Step 5: Regulations OPPOSE -->
            <div id="modalStep5" class="modal-step">
                <h3>Step 5: Regulation Preferences (OPPOSE)</h3>
                <div class="form-group">
                    <label>Select which regulations you would NOT want to see:</label>
                    <div id="opposedRegulationsContainer" class="checkbox-group"></div>
                </div>
            </div>

            <!-- Step 6: Email Drafting Preference -->
            <div id="modalStep6" class="modal-step">
                <h3>Step 6: Email Drafting Preference</h3>
                <div class="form-group">
                    <label>How would you like to draft your emails?</label>
                    <div class="radio-group" style="margin-top: 20px;">
                        <label style="padding: 15px; border: 1px solid var(--border-color-dark); border-radius: 5px; margin-bottom: 15px; display: block; cursor: pointer;">
                            <input type="radio" name="emailDraftingPreference" value="ai" checked>
                            <strong>AI-Assisted Drafting (Recommended)</strong>
                            <p style="margin: 10px 0 0 25px; color: var(--dark-text-secondary); font-size: 0.9em;">
                                • Creates unique, personalized emails for each representative<br>
                                • Helps avoid the "flooding effect" where reps ignore identical messages<br>
                                • Takes a few extra seconds but produces more effective communications<br>
                                • Uses your profile to craft compelling, varied messages
                            </p>
                        </label>
                        <label style="padding: 15px; border: 1px solid var(--border-color-dark); border-radius: 5px; display: block; cursor: pointer;">
                            <input type="radio" name="emailDraftingPreference" value="template">
                            <strong>Template-Based Drafting</strong>
                            <p style="margin: 10px 0 0 25px; color: var(--dark-text-secondary); font-size: 0.9em;">
                                • Uses a standard template with your information filled in<br>
                                • Faster, but all emails will be very similar<br>
                                • May be less effective if many people send identical messages<br>
                                • Good for quick communication when time is critical
                            </p>
                        </label>
                    </div>
                    <p style="margin-top: 15px; font-size: 0.85em; color: var(--dark-text-secondary); font-style: italic;">
                        Note: You can always change this preference later using the toggle in the menu.
                    </p>
                </div>
            </div>

            <div class="modal-navigation">
                <button id="modalPrevBtn" class="button-outline">Previous</button>
                <button id="modalNextBtn">Next</button>
                <button id="saveOnboardingInfo" class="hidden">Save Profile</button>
                <button id="saveOnboardingInfoAnytime" class="button-primary" style="margin-left: auto;">
                    <sl-icon name="save" style="margin-right: 5px;"></sl-icon>
                    Save & Exit
                </button>
            </div>
        </div>
    </div>

    <div id="responseModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeResponseModal"><sl-icon name="x-lg"></sl-icon></span>
            <h3 id="responseModalTitle">Log Call Response</h3>
            <input type="hidden" id="currentRepIdForModal">
            <input type="hidden" id="currentListIdentifierForModal">
            <label for="modalResponseSelect">Response:</label>
            <select id="modalResponseSelect"></select>
            <label for="modalNotesTextarea">Notes (e.g., staffer name, key points discussed):</label>
            <textarea id="modalNotesTextarea" placeholder="Enter notes here..."></textarea>
            <button id="saveResponseModal">Save Response</button>
            <button id="cancelResponseModal" class="button-outline">Cancel</button>
        </div>
    </div>

    <div id="emailGenerationModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeEmailGenerationModal"><sl-icon name="x-lg"></sl-icon></span>
            <h3 id="emailGenModalTitle">Your Personalized Email Draft</h3>
            <div id="emailGenSpinner" class="hidden" style="text-align: center;">
                <div class="email-gen-spinner"></div>
                <p>Generating your personalized draft...</p>
            </div>
            <div id="emailGenContent" class="hidden">
                <div class="form-group with-copy">
                    <label for="generatedSubject">Subject:</label>
                    <input type="text" id="generatedSubject" oninput="updateCopyButton('subject', this.value)">
                    <sl-copy-button id="copySubjectBtn" value="" style="position: absolute; bottom: 25px; right: 8px;"></sl-copy-button>
                </div>
                <div class="form-group with-copy">
                    <label for="generatedBody">Body:</label>
                    <textarea id="generatedBody" style="min-height: 250px;" oninput="updateCopyButton('body', this.value)"></textarea>
                    <sl-copy-button id="copyBodyBtn" value="" style="position: absolute; bottom: 25px; right: 8px;"></sl-copy-button>
                </div>
                <div class="email-rating-container">
                    <button id="thumbsUpBtn" class="icon-btn thumbs-up" data-rating="positive">
                        <span><sl-icon name="hand-thumbs-up"></sl-icon></span>
                        <small>Good</small>
                    </button>
                    <button id="thumbsDownBtn" class="icon-btn thumbs-down" data-rating="negative">
                        <span><sl-icon name="hand-thumbs-down"></sl-icon></span>
                        <small>Needs Work</small>
                    </button>
                    <button id="newDraftBtn" class="icon-btn">
                        <span><sl-icon name="arrow-repeat"></sl-icon></span>
                        <small>New Draft</small>
                    </button>
                </div>
                <div id="draftNavigationContainer" class="hidden" style="justify-content: center; align-items: center; gap: 15px; margin-top: 10px;">
                    <button id="prevDraftBtn" class="icon-btn" style="padding: 8px 12px;">
                        <span><sl-icon name="arrow-left"></sl-icon></span>
                        <small>Previous</small>
                    </button>
                    <span id="draftCounter" style="color: var(--dark-text-secondary); font-size: 0.9em;">Draft 1 of 1</span>
                    <button id="nextDraftBtn" class="icon-btn" style="padding: 8px 12px;">
                        <span><sl-icon name="arrow-right"></sl-icon></span>
                        <small>Next</small>
                    </button>
                </div>
                <div id="ratingNoteContainer" class="hidden" style="margin-top: 10px;">
                    <input type="text" id="ratingNote" placeholder="What's good/bad about this draft? (optional)" style="width: 100%; padding: 8px; background-color: var(--dark-bg-primary); color: var(--dark-text-primary); border: 1px solid var(--border-color-dark); border-radius: 4px;">
                </div>
                <div class="modal-navigation">
                    <button id="approveAndSendEmail" class="button-primary">Approve & Send</button>
                    <button id="cancelEmailGeneration" class="button-outline">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="guideModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeGuideModal"><sl-icon name="x-lg"></sl-icon></span>
            <h2>SB3 Call Tracker - Easy Mobile Guide (v1.1 - Firebase Beta)</h2>
            <p>This tool helps you contact lawmakers. Your progress is saved automatically to this device and backed up to a secure cloud database (Firebase) linked to this device only.</p>
            <h4>1. First Time Opening? (Quick Setup):</h4>
            <ul>
                <li>A "Welcome" box will pop up.</li>
                <li>Type in your <strong>Full Name</strong> and <strong>City/Town</strong>.</li>
                <li>Tap "Save and Continue." This info is saved to your device and backed up.</li>
                <li><em>Need to change it later? Tap "Edit My Info."</em></li>
            </ul>
            <h4>2. Sending Emails:</h4>
            <ul>
                <li>Email templates are provided. You can edit them on the main screen.</li>
                <li>Changes to templates are saved automatically.</li>
            </ul>
            <h4>3. Contacting Lawmakers:</h4>
            <ul>
                <li><strong>To Call:</strong> Tap the phone number. After, check "Called." A box appears to log the response and notes. Tap "Save Response."</li>
                <li><strong>To Email:</strong> Tap the email address. Your email app opens. After sending, the "Emailed" box is checked automatically.</li>
                <li>All these actions are saved automatically.</li>
            </ul>
            <h4>4. Your Progress:</h4>
            <ul>
                <li><strong>Auto-Save:</strong> All changes (checkboxes, notes, templates, user info) are saved automatically to your device and backed up. The "Save All Changes" button has been removed.</li>
                <li><strong>Export/Import:</strong> Still available for manual backups or transferring to a *new* device if needed (though Firebase aims to make this less necessary for the same device).</li>
                <li><strong>Reset All Data:</strong> Clears data from *this device's local storage and its Firebase backup*. Use with caution!</li>
            </ul>
            <button id="dismissGuideModal" class="button-outline" style="margin-top: 20px;">Dismiss</button>
        </div>
    </div>

    <!-- Feedback Toast Notification -->
    <div id="feedbackToast" class="feedback-toast"></div>

    <script>
        // Global error handler
        window.onerror = function(message, source, lineno, colno, error) {
            const errorDetails = `CRITICAL SCRIPT ERROR:\nMessage: ${message}\nSource: ${source}\nLine: ${lineno}\nColumn: ${colno}\nError: ${error ? JSON.stringify(error) : 'N/A'}`;
            alert(errorDetails);
            console.error("GLOBAL ERROR:", message, source, lineno, colno, error);
            return true;
        };

        try {
            document.addEventListener('DOMContentLoaded', function() {
                console.log("DOMContentLoaded event fired.");

                // --- Constants and Config ---
                const firebaseConfig = {
                    apiKey: "AIzaSyAm-QMDte5ytPN7Z8Cz7VaDe7hUVGsTE-8",
                    authDomain: "sb3calltool.firebaseapp.com",
                    projectId: "sb3calltool",
                    storageBucket: "sb3calltool.firebasestorage.app",
                    messagingSenderId: "834566220861",
                    appId: "1:834566220861:web:6475e1ddf50c00e54b0e54",
                    measurementId: "G-BC4Z144B00",
                    databaseURL: "https://sb3calltool-default-rtdb.firebaseio.com"
                };

                const TONE_AND_PERSONALITY_DATA = {
                  "primary_tones": [{"code":"PROF_FORMAL","name":"Professional‑Formal","how_it_feels":"Polite, businesslike, courteous","best_for":"First contact; complex policy issues"}, {"code":"FRIEND_PRO","name":"Friendly‑Professional","how_it_feels":"Warm but business‑appropriate","best_for":"Community matters; local projects"}, {"code":"POLICY_ANALYTICAL","name":"Policy‑Analytical","how_it_feels":"Data‑driven, objective","best_for":"Budget, economic, or technical topics"}, {"code":"PERSONAL_NARR","name":"Personal Narrative","how_it_feels":"Brief personal story, heartfelt","best_for":"Health, education, human‑impact issues"}, {"code":"SOLUTION_ORIENT","name":"Solution‑Oriented","how_it_feels":"Constructive, next‑step focused","best_for":"Suggesting specific legislation or amendments"}, {"code":"CIVIC_PATRIOTIC","name":"Civic Duty / Patriotic","how_it_feels":"Shared values and service","best_for":"Voting rights, veterans’ issues"}, {"code":"INSPIRATIONAL","name":"Inspirational / Hopeful","how_it_feels":"Uplifting, forward‑looking","best_for":"Climate, youth, visionary initiatives"}, {"code":"URGENT_RESPECT","name":"Urgent‑Yet‑Respectful","how_it_feels":"Time‑sensitive without aggression","best_for":"Imminent votes; impending deadlines"}, {"code":"BIPARTISAN","name":"Bipartisan‑Bridge‑Building","how_it_feels":"Common‑ground, non‑partisan","best_for":"Cross‑aisle support"}],
                  "personality_elements": [{"code":"EMPATHETIC","name":"Empathetic","short_descriptor":"Expresses understanding","adds":"Human connection"}, {"code":"CONCISE","name":"Concise","short_descriptor":"Brief, no tangents","adds":"Clarity & time respect"}, {"code":"DETAILED","name":"Detailed / Source‑Citing","short_descriptor":"References bills or data","adds":"Credibility"}, {"code":"STORY_DRIVEN","name":"Story‑Driven","short_descriptor":"Uses one vivid anecdote","adds":"Emotional resonance"}, {"code":"CONFIDENT","name":"Confident","short_descriptor":"Steady conviction","adds":"Persuasiveness"}, {"code":"HUMBLE","name":"Humble / Collaborative","short_descriptor":"Acknowledges limits","adds":"Approachability"}, {"code":"OPTIMISTIC","name":"Optimistic","short_descriptor":"Highlights gains","adds":"Positive framing"}, {"code":"CONCERNED","name":"Concerned / Cautious","short_descriptor":"Polite worry or risk","adds":"Gravity"}, {"code":"FORWARD_THINK","name":"Forward‑Thinking","short_descriptor":"Long‑term benefits","adds":"Strategic view"}, {"code":"GRATITUDE","name":"Gratitude‑Focused","short_descriptor":"Thanks legislator","adds":"Goodwill"}, {"code":"COMMUNITY_VOICE","name":"Constituent‑Community Voice","short_descriptor":"Inclusive “we”, local refs","adds":"Grass‑roots solidarity"}, {"code":"DATA_SAVVY","name":"Data‑Savvy","short_descriptor":"Links to charts or facts","adds":"Depth for evidence‑minded"}, {"code":"SOLUTION_SEEK","name":"Solution‑Seeking","short_descriptor":"Invites feedback","adds":"Two‑way dialogue"}]
                };

                const REGULATION_OPTIONS = ["Age & Access Control – No sales to minors; retail areas must be 21+ only and display clear danger/warning signs.", "Location Limits – Stores or kiosks may not operate near schools, churches, parks, playgrounds, or similar child‑focused venues.", "Packaging & Marketing – Containers must be child‑resistant, tamper‑evident, resealable, and not designed to appeal to children.", "Product Purity – THC items cannot be combined with other psychoactive substances (alcohol, tobacco, kratom, etc.).", "Testing & Tracking – Mandatory testing at every production stage; seed‑to‑sale manifests/lab reports must be accurate (forgery is a felony).", "Facility & Operator Permits – Growers, processors, and retailers need state permits, follow food‑safety rules, and pay fees that fund enforcement by TABC and partner agencies.", "Local Control – Cities and counties may ban or restrict THC retail outlets.", "Sales Window & Quantity Caps – Transactions allowed only 10 a.m.–9 p.m., never on Sundays; per‑product THC limits and purchase limits per customer apply.", "Labeling – Packages must show a surgeon‑general–style warning, full ingredient list, THC content, and a scannable QR/barcode linking to test results.", "Public‑Use Ban – Public consumption, use on retail premises, and open containers in vehicles are criminal offenses.", "Enforcement Powers – Attorney General, DAs, and county attorneys may pursue violations under the Deceptive Trade Practices Act.", "Taxes & Funding – Excise taxes plus dedicated state funds must cover oversight, with extra resources earmarked for law‑enforcement operations."];

                // --- Firebase Initialization ---
                firebase.initializeApp(firebaseConfig);
                firebase.analytics();
                const auth = firebase.auth();
                const db = firebase.database();
                const functions = firebase.functions();
                const firestore = firebase.firestore();
                
                // Connect to emulators
                if (window.location.hostname === "127.0.0.1") {
                    console.log("Connecting to local emulators.");
                    db.useEmulator("127.0.0.1", 9000);
                    functions.useEmulator("127.0.0.1", 5001);
                }

                let currentUser = null;
                let deviceId = localStorage.getItem('sb3CallToolDeviceId');
                if (!deviceId) {
                    deviceId = 'device-' + Math.random().toString(36).substr(2, 16) + Date.now().toString(36);
                    localStorage.setItem('sb3CallToolDeviceId', deviceId);
                }

                // --- State Variables ---
                let contactLists = new Map();
                let userProfile = {};
                let currentModalStep = 1;
                let currentEmailData = null; // Store current email data for rating
                let subjectLineQueue = []; // Pre-generated subject lines
                let isGeneratingSubjects = false; // Prevent duplicate generation calls
                
                // Email pre-generation cache system
                const emailCache = {
                    cache: new Map(), // Max 10 entries: rep.id -> {subject, body, generatedAt, repData}
                    currentlyGenerating: null, // Rep currently being generated
                    nextInQueue: null, // Next rep to generate
                    generationPromise: null, // Current generation promise
                    cacheOrder: [], // Track order for LRU eviction
                    maxCacheSize: 10,
                    cacheExpiryDays: 30
                };
                
                // Session-based draft storage for multiple regenerations
                const draftHistory = {
                    drafts: new Map(), // rep.id -> array of {subject, body, timestamp}
                    currentIndex: new Map(), // rep.id -> current draft index
                    maxDraftsPerRep: 5
                };
                
                // Generation controller to prevent runaway scenarios
                const generationController = {
                    // Concurrent generation control (technical limit, not usage limit)
                    maxConcurrent: 2,
                    activeGenerations: new Map(), // repId -> promise
                    
                    // Error tracking (for stability, not limiting)
                    consecutiveErrors: 0,
                    maxConsecutiveErrors: 5,
                    
                    // Queue safety (prevent infinite loops from bugs)
                    processedInCycle: new Set(),
                    cycleStartTime: Date.now(),
                    
                    // State tracking (for debugging and user info)
                    stats: {
                        totalGenerated: 0,
                        cacheHits: 0,
                        totalRequests: 0,
                        lastGenerationTime: 0
                    },
                    
                    // Background generation control
                    isPaused: false,
                    pauseReason: null,
                    lastUserActivity: Date.now()
                };
                
                // Cache management functions
                function getUserProfileHash() {
                    // Create a hash of user profile to detect changes
                    return JSON.stringify({
                        userFullName: userProfile.userFullName,
                        userLocation: userProfile.userLocation,
                        intelligentDraftingProfile: userProfile.intelligentDraftingProfile,
                        assignedDistricts: userProfile.assignedDistricts
                    });
                }
                
                function isEmailCacheValid(cachedEmail) {
                    if (!cachedEmail || !cachedEmail.generatedAt) return false;
                    
                    const generatedDate = new Date(cachedEmail.generatedAt);
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() - emailCache.cacheExpiryDays);
                    
                    return generatedDate > expiryDate;
                }
                
                async function loadEmailCache() {
                    // Load from local storage first
                    try {
                        const keys = Object.keys(localStorage).filter(k => k.startsWith('sb3EmailCache_'));
                        keys.forEach(key => {
                            const repId = key.replace('sb3EmailCache_', '');
                            const cachedData = JSON.parse(localStorage.getItem(key));
                            if (isEmailCacheValid(cachedData)) {
                                emailCache.cache.set(repId, cachedData);
                                emailCache.cacheOrder.push(repId);
                            } else {
                                localStorage.removeItem(key); // Clean up expired entries
                            }
                        });
                    } catch (error) {
                        console.error('Error loading email cache from localStorage:', error);
                    }
                    
                    // Then sync with Firebase
                    if (currentUser && deviceId) {
                        try {
                            const snapshot = await db.ref(`devices/${deviceId}/emailCache/emails`).once('value');
                            const firebaseCache = snapshot.val() || {};
                            
                            Object.entries(firebaseCache).forEach(([repId, cachedData]) => {
                                if (isEmailCacheValid(cachedData) && cachedData.userProfileHash === getUserProfileHash()) {
                                    emailCache.cache.set(repId, cachedData);
                                    if (!emailCache.cacheOrder.includes(repId)) {
                                        emailCache.cacheOrder.push(repId);
                                    }
                                    // Update local storage
                                    localStorage.setItem(`sb3EmailCache_${repId}`, JSON.stringify(cachedData));
                                }
                            });
                            
                            // Enforce cache size limit
                            while (emailCache.cache.size > emailCache.maxCacheSize) {
                                const oldestKey = emailCache.cacheOrder.shift();
                                emailCache.cache.delete(oldestKey);
                                localStorage.removeItem(`sb3EmailCache_${oldestKey}`);
                                if (currentUser && deviceId) {
                                    db.ref(`devices/${deviceId}/emailCache/emails/${oldestKey}`).remove();
                                }
                            }
                        } catch (error) {
                            console.error('Error loading email cache from Firebase:', error);
                        }
                    }
                }
                
                async function saveEmailToCache(repId, emailData) {
                    const cacheEntry = {
                        ...emailData,
                        generatedAt: new Date().toISOString(),
                        userProfileHash: getUserProfileHash()
                    };
                    
                    // Check cache size and evict if necessary
                    if (emailCache.cache.size >= emailCache.maxCacheSize && !emailCache.cache.has(repId)) {
                        const oldestKey = emailCache.cacheOrder.shift();
                        emailCache.cache.delete(oldestKey);
                        localStorage.removeItem(`sb3EmailCache_${oldestKey}`);
                        if (currentUser && deviceId) {
                            db.ref(`devices/${deviceId}/emailCache/emails/${oldestKey}`).remove();
                        }
                    }
                    
                    // Add to cache
                    emailCache.cache.set(repId, cacheEntry);
                    if (!emailCache.cacheOrder.includes(repId)) {
                        emailCache.cacheOrder.push(repId);
                    } else {
                        // Move to end (most recently used)
                        emailCache.cacheOrder = emailCache.cacheOrder.filter(id => id !== repId);
                        emailCache.cacheOrder.push(repId);
                    }
                    
                    // Save to local storage
                    localStorage.setItem(`sb3EmailCache_${repId}`, JSON.stringify(cacheEntry));
                    
                    // Save to Firebase
                    if (currentUser && deviceId) {
                        try {
                            await db.ref(`devices/${deviceId}/emailCache/emails/${repId}`).set(cacheEntry);
                            await db.ref(`devices/${deviceId}/emailCache/metadata`).set({
                                lastUpdated: firebase.database.ServerValue.TIMESTAMP,
                                cacheVersion: 1
                            });
                        } catch (error) {
                            console.error('Error saving email to Firebase cache:', error);
                        }
                    }
                }
                
                function clearEmailCache() {
                    emailCache.cache.clear();
                    emailCache.cacheOrder = [];
                    emailCache.currentlyGenerating = null;
                    emailCache.generationPromise = null;
                    
                    // Clear local storage
                    const keys = Object.keys(localStorage).filter(k => k.startsWith('sb3EmailCache_'));
                    keys.forEach(key => localStorage.removeItem(key));
                    
                    // Clear Firebase
                    if (currentUser && deviceId) {
                        db.ref(`devices/${deviceId}/emailCache`).remove();
                    }
                }
                
                function determineNextRep(currentRep, listIdentifier) {
                    const currentList = contactLists.get(listIdentifier);
                    if (!currentList) return null;
                    
                    const currentIndex = currentList.reps.findIndex(r => r.id === currentRep.id);
                    if (currentIndex === -1) return null;
                    
                    // Find next rep with email in same list
                    for (let i = currentIndex + 1; i < currentList.reps.length; i++) {
                        if (currentList.reps[i].email) {
                            return { rep: currentList.reps[i], listId: listIdentifier };
                        }
                    }
                    
                    // Loop back to beginning of current list
                    for (let i = 0; i < currentIndex; i++) {
                        if (currentList.reps[i].email) {
                            return { rep: currentList.reps[i], listId: listIdentifier };
                        }
                    }
                    
                    return null; // No more reps in this list
                }
                
                async function generateEmailInBackground(rep, listId) {
                    if (!llmToggle.checked || !userProfile.onboardingComplete) return;
                    
                    // Check if paused
                    if (generationController.isPaused) {
                        console.log('Background generation is paused:', generationController.pauseReason);
                        return;
                    }
                    
                    // Duplicate prevention - check if already generating for this rep
                    if (generationController.activeGenerations.has(rep.id)) {
                        return generationController.activeGenerations.get(rep.id);
                    }
                    
                    // Check concurrent limit
                    if (generationController.activeGenerations.size >= generationController.maxConcurrent) {
                        console.log('Max concurrent generations reached, skipping for now');
                        return;
                    }
                    
                    // Queue safety - prevent infinite loops
                    if (generationController.processedInCycle.has(rep.id)) {
                        console.log('Already processed this rep in current cycle, skipping');
                        return;
                    }
                    
                    // Update user activity
                    generationController.lastUserActivity = Date.now();
                    
                    const promise = (async () => {
                        try {
                            // Mark as processing
                            generationController.processedInCycle.add(rep.id);
                            generationController.stats.totalRequests++;
                            
                            const generateEmail = functions.httpsCallable('generateEmail');
                            const result = await generateEmail({ userProfile, representative: rep });
                            
                            await saveEmailToCache(rep.id, {
                                subject: result.data.subject,
                                body: result.data.body,
                                repData: rep
                            });
                            
                            // Success - reset consecutive errors
                            generationController.consecutiveErrors = 0;
                            generationController.stats.totalGenerated++;
                            generationController.stats.lastGenerationTime = Date.now();
                            
                            console.log(`Pre-generated email for ${rep.representative_name} (Total: ${generationController.stats.totalGenerated})`);
                            
                            // Queue next rep if still active
                            const next = determineNextRep(rep, listId);
                            if (next) {
                                // Check if we've completed a full cycle
                                const cycleAge = Date.now() - generationController.cycleStartTime;
                                if (cycleAge > 3600000) { // 1 hour
                                    console.log('Starting new generation cycle');
                                    generationController.processedInCycle.clear();
                                    generationController.cycleStartTime = Date.now();
                                }
                                
                                // Check if user is still active (within last 5 minutes)
                                const timeSinceActivity = Date.now() - generationController.lastUserActivity;
                                if (timeSinceActivity > 300000) { // 5 minutes
                                    console.log('User inactive, pausing background generation');
                                    generationController.isPaused = true;
                                    generationController.pauseReason = 'User inactive';
                                    return result.data;
                                }
                                
                                // Schedule next generation
                                setTimeout(() => {
                                    if (!generationController.isPaused) {
                                        generateEmailInBackground(next.rep, next.listId);
                                    }
                                }, 1000);
                            }
                            
                            return result.data;
                        } catch (error) {
                            console.error('Error generating email in background:', error);
                            
                            // Track consecutive errors
                            generationController.consecutiveErrors++;
                            
                            if (generationController.consecutiveErrors >= generationController.maxConsecutiveErrors) {
                                console.log('Too many consecutive errors, pausing background generation');
                                generationController.isPaused = true;
                                generationController.pauseReason = 'Too many errors';
                                showFeedbackToast('⚠️ Background pre-generation paused due to errors. You can still generate emails on-demand.');
                            }
                            
                            return null;
                        } finally {
                            // Clean up
                            generationController.activeGenerations.delete(rep.id);
                            if (emailCache.currentlyGenerating === rep.id) {
                                emailCache.currentlyGenerating = null;
                                emailCache.generationPromise = null;
                            }
                        }
                    })();
                    
                    // Set the promise in activeGenerations AFTER it's created
                    generationController.activeGenerations.set(rep.id, promise);
                    
                    // Track this generation
                    emailCache.currentlyGenerating = rep.id;
                    emailCache.generationPromise = promise;
                    
                    return promise;
                }
                
                // Resume background generation when user is active
                function resumeBackgroundGeneration() {
                    if (generationController.isPaused && generationController.pauseReason === 'User inactive') {
                        generationController.isPaused = false;
                        generationController.pauseReason = null;
                        generationController.lastUserActivity = Date.now();
                        console.log('Resuming background generation - user active');
                        // Start generating if there's a queued rep
                        if (emailCache.nextInQueue) {
                            generateEmailInBackground(emailCache.nextInQueue.rep, emailCache.nextInQueue.listId);
                        }
                    }
                }
                
                // Track user activity
                document.addEventListener('click', () => {
                    generationController.lastUserActivity = Date.now();
                    resumeBackgroundGeneration();
                });
                
                document.addEventListener('keypress', () => {
                    generationController.lastUserActivity = Date.now();
                    resumeBackgroundGeneration();
                });
                
                // Pause when tab is hidden
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        generationController.isPaused = true;
                        generationController.pauseReason = 'Tab hidden';
                        console.log('Pausing background generation - tab hidden');
                    } else {
                        generationController.isPaused = false;
                        generationController.pauseReason = null;
                        generationController.lastUserActivity = Date.now();
                        console.log('Resuming background generation - tab visible');
                        if (emailCache.nextInQueue) {
                            generateEmailInBackground(emailCache.nextInQueue.rep, emailCache.nextInQueue.listId);
                        }
                    }
                });
                
                function startPreGeneration() {
                    if (!llmToggle.checked || !userProfile.onboardingComplete) return;
                    
                    // Find the first rep with email in visible lists
                    for (const [listId, list] of contactLists) {
                        for (const rep of list.reps) {
                            if (rep.email) {
                                generateEmailInBackground(rep, listId);
                                return;
                            }
                        }
                    }
                }

                // --- DOM Element Caching ---
                const dynamicTablesContainer = document.getElementById('dynamic-tables-container');
                
                // Sidenav & Controls
                const openNavBtn = document.getElementById('openNavBtn');
                const floatingNavBtn = document.getElementById('floatingNavBtn');
                const closeNavBtn = document.getElementById('closeNavBtn');
                const sideNavGuideBtn = document.getElementById('sideNavGuide');
                const sideNavExportBtn = document.getElementById('sideNavExport');
                const sideNavImportInput = document.getElementById('sideNavImportFile');
                const sideNavEditInfoBtn = document.getElementById('sideNavEditInfo');
                const sideNavResetBtn = document.getElementById('sideNavReset');
                const llmToggle = document.getElementById('llmToggle');
                const scrollTopBtn = document.getElementById('scrollTopBtn');

                // Onboarding Modal Elements
                const onboardingModal = document.getElementById('onboardingModal');
                const closeOnboardingModalBtn = document.getElementById('closeOnboardingModal');
                const emailTemplateSection = document.getElementById('emailTemplateSection');
                const emailSubjectTemplateInput = document.getElementById('emailSubjectTemplate');
                const emailBodyTemplateInput = document.getElementById('emailBodyTemplate');
                const onboardingUserNameInput = document.getElementById('onboardingUserName');
                const onboardingUserLocationInput = document.getElementById('onboardingUserLocation');
                const onboardingZipCodeInput = document.getElementById('onboardingZipCode');
                const occupationGroup = document.getElementById('occupationGroup');
                const onboardingOccupationInput = document.getElementById('onboardingOccupation');
                const primaryToneSelect = document.getElementById('primaryToneSelect');
                const personalityElementsContainer = document.getElementById('personalityElementsContainer');
                const banImpactStatementInput = document.getElementById('banImpactStatement');
                const additionalCommentsInput = document.getElementById('additionalComments');
                const supportedRegulationsContainer = document.getElementById('supportedRegulationsContainer');
                const opposedRegulationsContainer = document.getElementById('opposedRegulationsContainer');
                const modalPrevBtn = document.getElementById('modalPrevBtn');
                const modalNextBtn = document.getElementById('modalNextBtn');
                const saveOnboardingInfoBtn = document.getElementById('saveOnboardingInfo');

                // Other Modals
                const responseModal = document.getElementById('responseModal');
                const guideModal = document.getElementById('guideModal');

                // --- Main Logic ---
                
                async function generateSubjectLines() {
                    if (isGeneratingSubjects || !userProfile.onboardingComplete) return;
                    
                    isGeneratingSubjects = true;
                    console.log('Generating subject lines...');
                    
                    try {
                        const generateSubjectLines = functions.httpsCallable('generateSubjectLines');
                        const result = await generateSubjectLines({ userProfile });
                        
                        if (result.data && result.data.subjects) {
                            subjectLineQueue.push(...result.data.subjects);
                            console.log(`Generated ${result.data.subjects.length} subject lines. Queue size: ${subjectLineQueue.length}`);
                        }
                    } catch (error) {
                        console.error("Error generating subject lines:", error);
                    } finally {
                        isGeneratingSubjects = false;
                    }
                }
                
                function getNextSubjectLine() {
                    // Get the next subject line from the queue
                    const subject = subjectLineQueue.shift() || "Support Common-Sense Hemp Regulation - Not Prohibition";
                    
                    // Check if we need to generate more (when down to 3 or less)
                    if (subjectLineQueue.length <= 3 && !isGeneratingSubjects) {
                        generateSubjectLines(); // Generate more in the background
                    }
                    
                    return subject;
                }
                
                async function initializeApp() {
                    // Synchronous setup parts
                    populateToneAndPersonality();
                    populateRegulations();
                    setupModalListeners();
                    
                    // Load saved AI toggle state
                    const savedToggleState = localStorage.getItem('sb3LlmToggleState');
                    if (savedToggleState !== null) {
                        llmToggle.checked = savedToggleState === 'true';
                        emailTemplateSection.classList.toggle('hidden', llmToggle.checked);
                    }
                    
                    // Asynchronous part that should be awaited
                    await loadEmailTemplate();

                    // The main async logic wrapped in a promise
                    return new Promise((resolve, reject) => {
                        // Use onAuthStateChanged, but only for the initial check.
                        const unsubscribe = auth.onAuthStateChanged(async user => {
                            unsubscribe(); // Unsubscribe to avoid re-running this on auth changes.
                            try {
                                if (user) {
                                    currentUser = user;
                                } else {
                                    // If no user, sign in anonymously.
                                    const userCredential = await auth.signInAnonymously();
                                    currentUser = userCredential.user;
                                }

                                // Now that we have a user, ensure deviceId is correct.
                                if (deviceId !== currentUser.uid) {
                                    deviceId = currentUser.uid;
                                    localStorage.setItem('sb3CallToolDeviceId', deviceId);
                                }

                    // Load all necessary data.
                    await loadContactLists();
                    await loadDataFromAllSources();
                    await displayYourReps();

                    // Render the UI.
                    renderAllTables();
                    displayHomepageDistrictInfo(); // Display districts on homepage
                    document.getElementById('loader').style.display = 'none';
                    
                    // Load email cache and start pre-generation if appropriate
                    if (userProfile.onboardingComplete) {
                        await loadEmailCache();
                        generateSubjectLines();
                        // Start pre-generation if AI mode is enabled
                        if (llmToggle.checked) {
                            setTimeout(startPreGeneration, 2000); // Start after a short delay
                        }
                    }

                                resolve(); // Signal that initialization is complete.
                            } catch (error) {
                                // If anything fails, reject the promise.
                                console.error("Error during app initialization:", error);
                                alert("A critical error occurred during startup. Please refresh the page.");
                                reject(error);
                            }
                        });
                    });
                }

                function setupModalListeners() {
                    sideNavEditInfoBtn.addEventListener('click', () => {
                        populateOnboardingForm();
                        onboardingModal.style.display = 'block';
                        currentModalStep = 1;
                        updateModalStepVisibility();
                        closeNav();
                    });

                    sideNavGuideBtn.addEventListener('click', () => {
                        guideModal.style.display = 'block';
                        closeNav();
                    });

                    closeOnboardingModalBtn.onclick = () => onboardingModal.style.display = 'none';
                    
                    document.querySelectorAll('input[name="hempIndustry"]').forEach(radio => {
                        radio.addEventListener('change', (e) => {
                            occupationGroup.classList.toggle('hidden', e.target.value !== 'no');
                        });
                    });
                    
                    // Add listener for zip code changes to fetch and display districts
                    onboardingZipCodeInput.addEventListener('input', async (e) => {
                        const zipCode = e.target.value.trim();
                        
                        // Only fetch if we have a valid 5-digit zip code
                        if (zipCode.match(/^\d{5}$/)) {
                            try {
                                // Fetch representatives for this zip code
                                const docRef = firestore.collection('texas_representatives').doc(zipCode);
                                const doc = await docRef.get();
                                
                                if (doc.exists) {
                                    const zipData = doc.data();
                                    const texasLegislators = zipData.representatives.filter(rep => 
                                        rep.type === 'Texas Senate' || 
                                        rep.type === 'Texas House' || 
                                        rep.type === 'Texas House (from multi)'
                                    );
                                    
                                    if (texasLegislators.length > 0) {
                                        // Detect districts for this zip code
                                        const detectedDistricts = detectUserDistricts(texasLegislators);
                                        
                                        // Temporarily update the user profile to show districts
                                        userProfile.assignedDistricts = {
                                            ...detectedDistricts,
                                            zipCode: zipCode,
                                            detectedAt: new Date().toISOString()
                                        };
                                        
                                        // Display the districts
                                        displayDistrictInfo();
                                    } else {
                                        // No Texas legislators found
                                        document.getElementById('districtInfo').classList.add('hidden');
                                    }
                                } else {
                                    // Invalid zip code
                                    document.getElementById('districtInfo').classList.add('hidden');
                                }
                            } catch (error) {
                                console.error('Error fetching districts:', error);
                                document.getElementById('districtInfo').classList.add('hidden');
                            }
                        } else {
                            // Hide district info if zip code is not valid
                            document.getElementById('districtInfo').classList.add('hidden');
                        }
                    });

                    modalNextBtn.addEventListener('click', () => navigateModal(1));
                    modalPrevBtn.addEventListener('click', () => navigateModal(-1));
                    saveOnboardingInfoBtn.addEventListener('click', saveAndCloseOnboarding);
                    document.getElementById('saveOnboardingInfoAnytime').addEventListener('click', saveAndCloseOnboarding);

                llmToggle.addEventListener('change', () => {
                    emailTemplateSection.classList.toggle('hidden', llmToggle.checked);
                    // Save the toggle state
                    localStorage.setItem('sb3LlmToggleState', llmToggle.checked);
                    
                    // Clear cache when toggling AI mode
                    clearEmailCache();
                    
                    // Start pre-generation if AI mode is enabled
                    if (llmToggle.checked && userProfile.onboardingComplete) {
                        setTimeout(startPreGeneration, 1000);
                    }
                });

                    // Email Generation Modal buttons
                    document.getElementById('closeEmailGenerationModal').addEventListener('click', () => {
                        document.getElementById('emailGenerationModal').style.display = 'none';
                        document.getElementById('ratingNoteContainer').classList.add('hidden');
                        document.getElementById('ratingNote').value = '';
                        currentEmailData = null;
                    });
                    document.getElementById('cancelEmailGeneration').addEventListener('click', () => {
                        document.getElementById('emailGenerationModal').style.display = 'none';
                        document.getElementById('ratingNoteContainer').classList.add('hidden');
                        document.getElementById('ratingNote').value = '';
                        currentEmailData = null;
                    });

                    // Email rating buttons
                    document.getElementById('thumbsUpBtn').addEventListener('click', () => handleEmailRating('positive'));
                    document.getElementById('thumbsDownBtn').addEventListener('click', () => handleEmailRating('negative'));
                    document.getElementById('newDraftBtn').addEventListener('click', handleNewDraft);
                    
                    // Draft navigation buttons
                    document.getElementById('prevDraftBtn').addEventListener('click', () => navigateDrafts(-1));
                    document.getElementById('nextDraftBtn').addEventListener('click', () => navigateDrafts(1));

                    // Sidenav listeners
                    openNavBtn.addEventListener('click', openNav);
                    floatingNavBtn.addEventListener('click', openNav);
                    closeNavBtn.addEventListener('click', closeNav);

                    // Scroll-to-top listener
                    window.onscroll = function() {scrollFunction()};
                    scrollTopBtn.addEventListener('click', topFunction);

                    // Wire up sidenav buttons to original functions
                    sideNavExportBtn.addEventListener('click', exportDataHandler);
                    sideNavImportInput.addEventListener('change', importDataHandler);
                    sideNavResetBtn.addEventListener('click', resetDataHandler);
                }

                function openNav() {
                    document.getElementById("mySidenav").style.width = "250px";
                }

                function closeNav() {
                    document.getElementById("mySidenav").style.width = "0";
                }

                function scrollFunction() {
                    const shouldShow = document.body.scrollTop > 20 || document.documentElement.scrollTop > 20;
                    scrollTopBtn.style.display = shouldShow ? "block" : "none";
                    floatingNavBtn.style.display = shouldShow ? "block" : "none";
                }

                function topFunction() {
                    document.body.scrollTop = 0; // For Safari
                    document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
                }

                function toProperCase(str) {
                    if (!str) return '';
                    return str.replace(/\w\S*/g, function(txt) {
                        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                    });
                }

                function formatRepName(name) {
                    if (!name) return '';
                    // Check if name is in "Lastname, Firstname" format
                    if (name.includes(',')) {
                        const parts = name.split(',').map(part => part.trim());
                        if (parts.length === 2) {
                            // Reorder to "Firstname Lastname" and apply proper case
                            return toProperCase(`${parts[1]} ${parts[0]}`);
                        }
                    }
                    // If not in comma format, just apply proper case
                    return toProperCase(name);
                }

                function updateCopyButton(type, value) {
                    const buttonId = type === 'subject' ? 'copySubjectBtn' : 'copyBodyBtn';
                    const button = document.getElementById(buttonId);
                    if (button) {
                        button.value = value;
                    }
                }

                function showFeedbackToast(message, duration = 3000) {
                    const toast = document.getElementById('feedbackToast');
                    toast.textContent = message;
                    toast.classList.add('show');
                    
                    setTimeout(() => {
                        toast.classList.remove('show');
                    }, duration);
                }

                function handleEmailRating(rating) {
                    if (!currentEmailData) return;

                    // Visual feedback - update button states
                    const thumbsUpBtn = document.getElementById('thumbsUpBtn');
                    const thumbsDownBtn = document.getElementById('thumbsDownBtn');
                    const ratingNoteContainer = document.getElementById('ratingNoteContainer');
                    const ratingNoteInput = document.getElementById('ratingNote');
                    
                    // Reset both buttons
                    thumbsUpBtn.classList.remove('selected');
                    thumbsDownBtn.classList.remove('selected');
                    
                    // Set the selected button
                    if (rating === 'positive') {
                        thumbsUpBtn.classList.add('selected');
                    } else if (rating === 'negative') {
                        thumbsDownBtn.classList.add('selected');
                    }

                    // Show the note input
                    ratingNoteContainer.classList.remove('hidden');

                    // Save the rating to Firebase
                    if (!userProfile.ratedEmails) {
                        userProfile.ratedEmails = [];
                    }

                    // Check if this email was already rated and update it
                    const existingIndex = userProfile.ratedEmails.findIndex(
                        email => email.subject === currentEmailData.subject && 
                                email.body === currentEmailData.body
                    );

                    const ratedEmail = {
                        repName: currentEmailData.repName,
                        subject: currentEmailData.subject,
                        body: currentEmailData.body,
                        rating: rating,
                        note: ratingNoteInput.value.trim(),
                        timestamp: new Date().toISOString()
                    };

                    if (existingIndex >= 0) {
                        userProfile.ratedEmails[existingIndex] = ratedEmail;
                    } else {
                        userProfile.ratedEmails.push(ratedEmail);
                    }

                    // Save whenever the note changes
                    if (!ratingNoteInput.hasListener) {
                        ratingNoteInput.hasListener = true;
                        ratingNoteInput.addEventListener('input', () => {
                            const idx = userProfile.ratedEmails.findIndex(
                                email => email.subject === currentEmailData.subject && 
                                        email.body === currentEmailData.body
                            );
                            if (idx >= 0) {
                                userProfile.ratedEmails[idx].note = ratingNoteInput.value.trim();
                                saveDataToAllStorages();
                            }
                        });
                    }

                    saveDataToAllStorages();
                    
                    // Show feedback
                    showFeedbackToast(rating === 'positive' ? '👍 Marked as Good!' : '👎 Marked as Needs Work');
                }

                async function handleNewDraft() {
                    if (!currentEmailData || !currentEmailData.rep) return;
                    
                    const repId = currentEmailData.rep.id;
                    
                    // Initialize draft history for this rep if not exists
                    if (!draftHistory.drafts.has(repId)) {
                        draftHistory.drafts.set(repId, [{
                            subject: currentEmailData.subject,
                            body: currentEmailData.body,
                            timestamp: new Date().toISOString()
                        }]);
                        draftHistory.currentIndex.set(repId, 0);
                    }
                    
                    const drafts = draftHistory.drafts.get(repId);
                    
                    // Check if we've reached the limit
                    if (drafts.length >= draftHistory.maxDraftsPerRep) {
                        showFeedbackToast('⚠️ Maximum 5 drafts per representative reached');
                        return;
                    }

                    const spinner = document.getElementById('emailGenSpinner');
                    const content = document.getElementById('emailGenContent');
                    const ratingNoteContainer = document.getElementById('ratingNoteContainer');
                    const ratingNoteInput = document.getElementById('ratingNote');
                    
                    // Reset rating buttons and note
                    document.getElementById('thumbsUpBtn').classList.remove('selected');
                    document.getElementById('thumbsDownBtn').classList.remove('selected');
                    ratingNoteContainer.classList.add('hidden');
                    ratingNoteInput.value = '';
                    
                    spinner.classList.remove('hidden');
                    content.classList.add('hidden');

                    try {
                        const generateEmail = functions.httpsCallable('generateEmail');
                        const result = await generateEmail({ 
                            userProfile, 
                            representative: currentEmailData.rep 
                        });
                        
                        // Add new draft to history
                        const newDraft = {
                            subject: result.data.subject,
                            body: result.data.body,
                            timestamp: new Date().toISOString()
                        };
                        
                        drafts.push(newDraft);
                        draftHistory.currentIndex.set(repId, drafts.length - 1);
                        
                        // Update UI
                        updateDraftDisplay(result.data.subject, result.data.body);
                        updateDraftNavigation(repId);
                        
                        // Update current email data
                        currentEmailData.subject = result.data.subject;
                        currentEmailData.body = result.data.body;

                        spinner.classList.add('hidden');
                        content.classList.remove('hidden');
                        
                        // Show feedback
                        showFeedbackToast(`🔄 New draft generated! (${drafts.length}/${draftHistory.maxDraftsPerRep})`);
                    } catch (error) {
                        console.error("Error generating new draft:", error);
                        alert("Failed to generate new draft. Please try again.");
                        spinner.classList.add('hidden');
                        content.classList.remove('hidden');
                    }
                }
                
                function updateDraftDisplay(subject, body) {
                    document.getElementById('generatedSubject').value = subject;
                    document.getElementById('generatedBody').value = body;
                    
                    // Update copy button values
                    updateCopyButton('subject', subject);
                    updateCopyButton('body', body);
                }
                
                function updateDraftNavigation(repId) {
                    const navContainer = document.getElementById('draftNavigationContainer');
                    const drafts = draftHistory.drafts.get(repId) || [];
                    const currentIndex = draftHistory.currentIndex.get(repId) || 0;
                    
                    if (drafts.length > 1) {
                        navContainer.classList.remove('hidden');
                        navContainer.style.display = 'flex'; // Ensure it's visible
                        
                        // Update counter
                        document.getElementById('draftCounter').textContent = `Draft ${currentIndex + 1} of ${drafts.length}`;
                        
                        // Update button states
                        document.getElementById('prevDraftBtn').disabled = currentIndex === 0;
                        document.getElementById('nextDraftBtn').disabled = currentIndex === drafts.length - 1;
                    } else {
                        navContainer.classList.add('hidden');
                        navContainer.style.display = 'none';
                    }
                }
                
                function navigateDrafts(direction) {
                    if (!currentEmailData || !currentEmailData.rep) return;
                    
                    const repId = currentEmailData.rep.id;
                    const drafts = draftHistory.drafts.get(repId);
                    if (!drafts || drafts.length <= 1) return;
                    
                    let currentIndex = draftHistory.currentIndex.get(repId) || 0;
                    currentIndex += direction;
                    
                    // Ensure index is within bounds
                    currentIndex = Math.max(0, Math.min(currentIndex, drafts.length - 1));
                    draftHistory.currentIndex.set(repId, currentIndex);
                    
                    // Update display
                    const draft = drafts[currentIndex];
                    updateDraftDisplay(draft.subject, draft.body);
                    updateDraftNavigation(repId);
                    
                    // Update current email data
                    currentEmailData.subject = draft.subject;
                    currentEmailData.body = draft.body;
                    
                    // Reset rating for this draft
                    const thumbsUpBtn = document.getElementById('thumbsUpBtn');
                    const thumbsDownBtn = document.getElementById('thumbsDownBtn');
                    const ratingNoteContainer = document.getElementById('ratingNoteContainer');
                    const ratingNoteInput = document.getElementById('ratingNote');
                    
                    thumbsUpBtn.classList.remove('selected');
                    thumbsDownBtn.classList.remove('selected');
                    ratingNoteContainer.classList.add('hidden');
                    ratingNoteInput.value = '';
                }

                async function loadEmailTemplate() {
                    try {
                        const response = await fetch('email_template.json');
                        const template = await response.json();
                        emailSubjectTemplateInput.value = template.subject;
                        emailBodyTemplateInput.value = template.body;
                    } catch (error) {
                        console.error("Error loading email template:", error);
                        emailSubjectTemplateInput.value = "Regarding THC Regulation";
                        emailBodyTemplateInput.value = "Dear Representative {repName},\n\n...";
                    }
                }

                function navigateModal(direction) {
                    currentModalStep += direction;
                    updateModalStepVisibility();
                }

                function updateModalStepVisibility() {
                    document.querySelectorAll('.modal-step').forEach((step, index) => {
                        step.classList.toggle('active', (index + 1) === currentModalStep);
                    });
                    modalPrevBtn.classList.toggle('hidden', currentModalStep === 1);
                    modalNextBtn.classList.toggle('hidden', currentModalStep === 6);
                    saveOnboardingInfoBtn.classList.toggle('hidden', currentModalStep !== 6);
                }

                async function saveAndCloseOnboarding() {
                    // Gather data from form
                    const supportedRegulations = [];
                    document.querySelectorAll('#supportedRegulationsContainer input[type="checkbox"]:checked').forEach(cb => {
                        const caveatInput = document.getElementById(`caveat-sup-${cb.dataset.index}`);
                        supportedRegulations.push({
                            regulation: cb.value,
                            caveat: caveatInput ? caveatInput.value.trim() : ''
                        });
                    });

                    const opposedRegulations = [];
                    document.querySelectorAll('#opposedRegulationsContainer input[type="checkbox"]:checked').forEach(cb => {
                        const caveatInput = document.getElementById(`caveat-opp-${cb.dataset.index}`);
                        opposedRegulations.push({
                            regulation: cb.value,
                            caveat: caveatInput ? caveatInput.value.trim() : ''
                        });
                    });

                    const selectedPersonalityElements = Array.from(document.querySelectorAll('#personalityElementsContainer input[type="checkbox"]:checked')).map(cb => cb.value);

                    const newZipCode = onboardingZipCodeInput.value.trim();
                    const zipCodeChanged = userProfile.zipCode !== newZipCode;
                    
                    // Get email drafting preference
                    const emailDraftingPreference = document.querySelector('input[name="emailDraftingPreference"]:checked').value;

                    userProfile.userFullName = onboardingUserNameInput.value.trim();
                    userProfile.userLocation = onboardingUserLocationInput.value.trim();
                    userProfile.zipCode = newZipCode;
                    userProfile.onboardingComplete = true;
                    userProfile.intelligentDraftingProfile = {
                        worksInHempIndustry: document.querySelector('input[name="hempIndustry"]:checked').value === 'yes',
                        occupation: document.querySelector('input[name="hempIndustry"]:checked').value === 'no' ? onboardingOccupationInput.value.trim() : null,
                        banImpactStatement: banImpactStatementInput.value.trim(),
                        additionalComments: additionalCommentsInput.value.trim(),
                        communicationTone: {
                            primaryTone: primaryToneSelect.value,
                            personalityElements: selectedPersonalityElements
                        },
                        supportedRegulations: supportedRegulations,
                        opposedRegulations: opposedRegulations,
                        emailDraftingPreference: emailDraftingPreference
                    };
                    
                    // Update the AI toggle based on user preference
                    llmToggle.checked = (emailDraftingPreference === 'ai');
                    localStorage.setItem('sb3LlmToggleState', llmToggle.checked);
                    emailTemplateSection.classList.toggle('hidden', llmToggle.checked);
                    
                    // If zip code changed, clear the assigned districts to force re-detection
                    if (zipCodeChanged && userProfile.assignedDistricts) {
                        userProfile.assignedDistricts = null;
                    }
                    
                    onboardingModal.style.display = 'none';
                    alert('Your Communications Profile has been saved.');
                    
                    // Clear email cache since profile changed
                    clearEmailCache();
                    
                    saveDataToAllStorages();
                    await displayYourReps(); // Refresh the representatives display and detect districts
                    displayHomepageDistrictInfo(); // Update the homepage district display
                    
                    // Generate subject lines now that we have a complete profile
                    generateSubjectLines();
                    
                    // Start pre-generation if AI mode is enabled
                    if (llmToggle.checked) {
                        setTimeout(startPreGeneration, 2000);
                    }
                }

                function displayDistrictInfo() {
                    const districtInfoDiv = document.getElementById('districtInfo');
                    const districtDetailsDiv = document.getElementById('districtDetails');
                    
                    if (!userProfile.assignedDistricts || !userProfile.zipCode) {
                        districtInfoDiv.classList.add('hidden');
                        return;
                    }
                    
                    const districts = userProfile.assignedDistricts;
                    let html = '';
                    
                    // House Districts
                    if (districts.houseDistricts && districts.houseDistricts.length > 0) {
                        html += `<div style="margin-bottom: 8px;">
                            <strong>Texas House District${districts.multipleHouseDistricts ? 's' : ''}:</strong> 
                            ${districts.houseDistricts.join(', ')}
                        </div>`;
                    }
                    
                    // Senate Districts
                    if (districts.senateDistricts && districts.senateDistricts.length > 0) {
                        html += `<div style="margin-bottom: 8px;">
                            <strong>Texas Senate District${districts.multipleSenateDistricts ? 's' : ''}:</strong> 
                            ${districts.senateDistricts.join(', ')}
                        </div>`;
                    }
                    
                    // Note about multiple districts
                    if (districts.multipleHouseDistricts || districts.multipleSenateDistricts) {
                        html += `<small style="color: var(--dark-text-secondary); font-style: italic;">
                            Note: Your zip code spans multiple districts.
                        </small>`;
                    }
                    
                    districtDetailsDiv.innerHTML = html;
                    districtInfoDiv.classList.remove('hidden');
                }
                
                function displayHomepageDistrictInfo() {
                    const homepageDistrictInfoDiv = document.getElementById('homepageDistrictInfo');
                    const homepageDistrictDetailsDiv = document.getElementById('homepageDistrictDetails');
                    
                    if (!userProfile.assignedDistricts || !userProfile.zipCode) {
                        homepageDistrictInfoDiv.classList.add('hidden');
                        return;
                    }
                    
                    const districts = userProfile.assignedDistricts;
                    let html = '';
                    
                    // Build compact district display
                    const districtParts = [];
                    
                    if (districts.houseDistricts && districts.houseDistricts.length > 0) {
                        districtParts.push(`House: ${districts.houseDistricts.join(', ')}`);
                    }
                    
                    if (districts.senateDistricts && districts.senateDistricts.length > 0) {
                        districtParts.push(`Senate: ${districts.senateDistricts.join(', ')}`);
                    }
                    
                    if (districtParts.length > 0) {
                        html = `<strong>Your Districts (${userProfile.zipCode}):</strong> ${districtParts.join(' | ')}`;
                    }
                    
                    homepageDistrictDetailsDiv.innerHTML = html;
                    homepageDistrictInfoDiv.classList.remove('hidden');
                }
                
                function populateOnboardingForm() {
                    const profile = userProfile.intelligentDraftingProfile || {};
                    const tone = profile.communicationTone || {};

                    onboardingUserNameInput.value = userProfile.userFullName || '';
                    onboardingUserLocationInput.value = userProfile.userLocation || '';
                    onboardingZipCodeInput.value = userProfile.zipCode || '';
                    
                    // Display district info if available
                    displayDistrictInfo();
                    
                    const worksInHemp = profile.worksInHempIndustry;
                    const hempRadio = document.querySelector(`input[name="hempIndustry"][value="${worksInHemp ? 'yes' : 'no'}"]`);
                    if (hempRadio) {
                        hempRadio.checked = true;
                    }
                    occupationGroup.classList.toggle('hidden', worksInHemp !== false);
                    onboardingOccupationInput.value = profile.occupation || '';

                    primaryToneSelect.value = tone.primaryTone || 'PROF_FORMAL';
                    document.querySelectorAll('#personalityElementsContainer input[type="checkbox"]').forEach(cb => {
                        cb.checked = (tone.personalityElements || []).includes(cb.value);
                    });

                    banImpactStatementInput.value = profile.banImpactStatement || '';
                    additionalCommentsInput.value = profile.additionalComments || '';

                    populateRegulationCheckboxes(supportedRegulationsContainer, profile.supportedRegulations || [], 'sup');
                    populateRegulationCheckboxes(opposedRegulationsContainer, profile.opposedRegulations || [], 'opp');
                    
                    // Populate email drafting preference
                    const emailPref = profile.emailDraftingPreference || 'ai';
                    const emailPrefRadio = document.querySelector(`input[name="emailDraftingPreference"][value="${emailPref}"]`);
                    if (emailPrefRadio) {
                        emailPrefRadio.checked = true;
                    }
                }
                
                function populateRegulationCheckboxes(container, savedData, prefix) {
                    container.querySelectorAll('input[type="checkbox"][data-prefix]').forEach(cb => {
                        const savedReg = savedData.find(r => r.regulation === cb.value);
                        const index = cb.dataset.index;
                        const caveatBtn = document.querySelector(`.add-caveat-btn[data-index="${index}"][data-prefix="${prefix}"]`);
                        const caveatSection = document.getElementById(`caveat-section-${prefix}-${index}`);
                        const caveatInput = document.getElementById(`caveat-${prefix}-${index}`);

                        cb.checked = !!savedReg;

                        if (cb.checked) {
                            caveatBtn.style.display = 'inline-block';
                        } else {
                            caveatBtn.style.display = 'none';
                        }

                        if (savedReg && savedReg.caveat) {
                            caveatSection.classList.remove('hidden');
                            caveatInput.value = savedReg.caveat;
                        } else {
                            caveatSection.classList.add('hidden');
                            caveatInput.value = '';
                        }
                    });
                }

                function populateToneAndPersonality() {
                    TONE_AND_PERSONALITY_DATA.primary_tones.forEach(tone => {
                        const option = document.createElement('option');
                        option.value = tone.code;
                        option.textContent = `${tone.name} (${tone.how_it_feels})`;
                        primaryToneSelect.appendChild(option);
                    });

                    personalityElementsContainer.innerHTML = '';
                    TONE_AND_PERSONALITY_DATA.personality_elements.forEach(p => {
                        const label = document.createElement('label');
                        label.innerHTML = `<input type="checkbox" value="${p.code}"> ${p.name} - <i>${p.short_descriptor}</i>`;
                        personalityElementsContainer.appendChild(label);
                    });
                }

                function populateRegulations() {
                    const createRegulationHTML = (container, prefix) => {
                        container.innerHTML = '';
                        REGULATION_OPTIONS.forEach((reg, index) => {
                            const div = document.createElement('div');
                            div.innerHTML = `
                                <label>
                                    <input type="checkbox" value="${reg}" data-index="${index}" data-prefix="${prefix}"> ${reg}
                                    <button type="button" class="add-caveat-btn" data-prefix="${prefix}" data-index="${index}">Add Caveat</button>
                                </label>
                                <div class="caveat-section hidden" id="caveat-section-${prefix}-${index}">
                                    <input type="text" id="caveat-${prefix}-${index}" placeholder="Your modification...">
                                </div>
                            `;
                            container.appendChild(div);
                        });
                    };
                    createRegulationHTML(supportedRegulationsContainer, 'sup');
                    createRegulationHTML(opposedRegulationsContainer, 'opp');
                    
                    // Add event listeners for showing/hiding caveat buttons and sections
                    document.querySelectorAll('.checkbox-group input[type="checkbox"][data-prefix]').forEach(checkbox => {
                        const index = checkbox.dataset.index;
                        const prefix = checkbox.dataset.prefix;
                        const caveatBtn = document.querySelector(`.add-caveat-btn[data-index="${index}"][data-prefix="${prefix}"]`);
                        const caveatSection = document.getElementById(`caveat-section-${prefix}-${index}`);
                        const caveatInput = document.getElementById(`caveat-${prefix}-${index}`);

                        checkbox.addEventListener('change', (e) => {
                            if (e.target.checked) {
                                caveatBtn.style.display = 'inline-block';
                            } else {
                                caveatBtn.style.display = 'none';
                                caveatSection.classList.add('hidden');
                                caveatInput.value = '';
                            }
                        });
                    });

                    document.querySelectorAll('.add-caveat-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            const section = document.getElementById(`caveat-section-${e.target.dataset.prefix}-${e.target.dataset.index}`);
                            section.classList.toggle('hidden');
                        });
                    });
                }

                // Create a separate map for all contact lists (used for matching)
                let allContactLists = new Map();
                
                async function loadContactLists() {
                    try {
                        // First, load visibility settings
                        const visibilitySnapshot = await firestore.collection('contact_list_settings').get();
                        const visibilitySettings = {};
                        visibilitySnapshot.forEach(doc => {
                            visibilitySettings[doc.id] = doc.data();
                        });
                        
                        // Then, load ALL contact lists
                        const snapshot = await firestore.collection('contact_lists').get();
                        snapshot.forEach(doc => {
                            const listId = doc.id;
                            const listData = doc.data();
                            
                            const match = listId.match(/^(\d+)_(.+)$/);
                            if (match) {
                                const priority = parseInt(match[1], 10);
                                const title = match[2].replace(/_/g, ' ');
                                // Add unique IDs to each representative
                                const repsWithIds = listData.reps.map((rep, index) => ({
                                    ...rep,
                                    id: `${listId}-${index}-${rep.district || index}`
                                }));
                                
                                const listInfo = { priority, title, reps: repsWithIds };
                                
                                // Add to allContactLists for matching purposes
                                allContactLists.set(listId, listInfo);
                                
                                // Check visibility setting (default to true if not set)
                                const isVisible = visibilitySettings[listId]?.visible !== false;
                                
                                // Only add visible lists to the main contactLists
                                if (isVisible) {
                                    contactLists.set(listId, listInfo);
                                }
                            }
                        });
                        
                        // Sort both maps by priority
                        contactLists = new Map([...contactLists.entries()].sort((a, b) => a[1].priority - b[1].priority));
                        allContactLists = new Map([...allContactLists.entries()].sort((a, b) => a[1].priority - b[1].priority));
                    } catch (error) {
                        console.error("Error loading contact lists from Firestore:", error);
                        alert("Failed to load contact lists from the database. Please check your internet connection and refresh.");
                        document.getElementById('loader').style.display = 'none';
                    }
                }

                async function loadDataFromAllSources() {
                    if (currentUser) {
                        const snapshot = await db.ref(`devices/${deviceId}/latest`).once('value');
                        const firebaseData = snapshot.val();
                        if (firebaseData) {
                            console.log("Loading data from Firebase.");
                            userProfile = firebaseData.userProfile || {};
                            // Merge user interaction data with current contact lists from Firestore
                            mergeUserDataWithContactLists(firebaseData.contactLists);
                            localStorage.setItem('sb3UserData', JSON.stringify(firebaseData));
                            return;
                        }
                    }
                    
                    console.log("Loading data from Local Storage.");
                    const localData = JSON.parse(localStorage.getItem('sb3UserData') || '{}');
                    userProfile = localData.userProfile || { onboardingComplete: false };
                    // Merge user interaction data with current contact lists from Firestore
                    mergeUserDataWithContactLists(localData.contactLists);

                    if (!userProfile.onboardingComplete) {
                        onboardingModal.style.display = 'block';
                        updateModalStepVisibility();
                    }
                }
                
                function mergeUserDataWithContactLists(savedContactLists) {
                    if (!savedContactLists) return;
                    
                    contactLists.forEach((list, key) => {
                        const savedList = savedContactLists[key];
                        if (!savedList || !savedList.reps) return;
                        
                        // Create a map of saved user interactions by rep ID
                        const savedDataMap = new Map();
                        savedList.reps.forEach(savedRep => {
                            if (savedRep.id) {
                                savedDataMap.set(savedRep.id, {
                                    called: savedRep.called || false,
                                    emailed: savedRep.emailed || false,
                                    response: savedRep.response || 'not_selected',
                                    notes: savedRep.notes || ''
                                });
                            }
                        });
                        
                        // Apply saved user interactions to current reps from Firestore
                        list.reps = list.reps.map(rep => {
                            const savedData = savedDataMap.get(rep.id);
                            if (savedData) {
                                return {
                                    ...rep,
                                    called: savedData.called,
                                    emailed: savedData.emailed,
                                    response: savedData.response,
                                    notes: savedData.notes
                                };
                            }
                            return {
                                ...rep,
                                called: false,
                                emailed: false,
                                response: 'not_selected',
                                notes: ''
                            };
                        });
                    });
                }

                function saveDataToAllStorages() {
                    const dataToSave = {
                        userProfile: userProfile,
                        contactLists: Object.fromEntries(contactLists),
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    // Debug logging to see what's being saved
                    console.log("Saving data to Firebase - userProfile:", JSON.stringify(userProfile, null, 2));
                    console.log("Full dataToSave object:", JSON.stringify(dataToSave, null, 2));

                    localStorage.setItem('sb3UserData', JSON.stringify(dataToSave));
                    console.log("Data saved to Local Storage.");

                    if (currentUser && deviceId) {
                        db.ref(`devices/${deviceId}/latest`).set(dataToSave)
                            .then(() => console.log("Data saved to Firebase (latest)."))
                            .catch(error => console.error("Error saving 'latest' data to Firebase:", error));
                        db.ref(`devices/${deviceId}/history`).push(dataToSave);
                    }
                }
                
                const responseOptions = ['', 'For', 'Against', 'Not Advised/Neutral', 'No Stance Yet', 'Left Voicemail', 'Other'];
                const modalResponseSelect = document.getElementById('modalResponseSelect');
                responseOptions.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/^$/, 'not_selected');
                    option.textContent = val || 'Select Response...';
                    modalResponseSelect.appendChild(option);
                });

                // --- Event Listeners for Modals and Buttons ---
                document.getElementById('closeResponseModal').onclick = () => responseModal.style.display = 'none';
                document.getElementById('cancelResponseModal').onclick = () => responseModal.style.display = 'none';
                document.getElementById('saveResponseModal').onclick = function() {
                    const repId = document.getElementById('currentRepIdForModal').value;
                    const listIdentifier = document.getElementById('currentListIdentifierForModal').value;
                    if (!repId || !listIdentifier) return;
                    const currentList = getRepresentativeListByIdentifier(listIdentifier);
                    const repIndex = currentList.findIndex(r => r.id === repId);
                    if (repIndex === -1) return;
                    currentList[repIndex].response = modalResponseSelect.value;
                    currentList[repIndex].notes = document.getElementById('modalNotesTextarea').value;
                    const table = document.getElementById(`repsTable-${listIdentifier}`);
                    if (table) {
                        const tableBody = table.getElementsByTagName('tbody')[0];
                        const row = tableBody.querySelector(`tr[data-id="${repId}"]`);
                        if (row) updateResponseSummaryCell(row.cells[row.cells.length - 1], currentList[repIndex]);
                    }
                    responseModal.style.display = 'none';
                    saveDataToAllStorages();
                };

                document.getElementById('closeGuideModal').onclick = () => guideModal.style.display = 'none';
                document.getElementById('dismissGuideModal').onclick = () => guideModal.style.display = 'none';

                window.onclick = function(event) {
                    if (event.target == responseModal) responseModal.style.display = 'none';
                    if (event.target == onboardingModal) onboardingModal.style.display = 'none';
                    if (event.target == guideModal) guideModal.style.display = 'none';
                    if (event.target == document.getElementById('emailGenerationModal')) {
                        document.getElementById('emailGenerationModal').style.display = 'none';
                        document.getElementById('ratingNoteContainer').classList.add('hidden');
                        document.getElementById('ratingNote').value = '';
                        currentEmailData = null;
                    }
                };

                function exportDataHandler() {
                    saveDataToAllStorages(); 
                    const dataStr = JSON.stringify({
                        userProfile,
                        contactLists: Object.fromEntries(contactLists),
                        emailSubject: emailSubjectTemplateInput.value,
                        emailBody: emailBodyTemplateInput.value
                    }, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', 'sb3_call_tracker_progress.json');
                    linkElement.click();
                    linkElement.remove();
                    closeNav();
                }

                function importDataHandler(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            userProfile = importedData.userProfile || { onboardingComplete: false };
                            
                            // Re-hydrate the map from the imported object
                            if (importedData.contactLists) {
                                for (const key in importedData.contactLists) {
                                    if (contactLists.has(key)) {
                                        const existingList = contactLists.get(key);
                                        existingList.reps = importedData.contactLists[key].reps;
                                    }
                                }
                            }

                            emailSubjectTemplateInput.value = importedData.emailSubject || "";
                            emailBodyTemplateInput.value = importedData.emailBody || "";
                            
                            saveDataToAllStorages();
                            renderAllTables();
                            populateOnboardingForm();
                            alert('Progress imported successfully!');
                        } catch (error) {
                            alert('Error importing file.');
                            console.error('Import Error:', error);
                        }
                        sideNavImportInput.value = '';
                    };
                    reader.readAsText(file);
                    closeNav();
                }

                function resetDataHandler() {
                    if (confirm('Are you sure you want to reset all data? This will clear local storage and attempt to clear Firebase data for this device. This cannot be undone.')) {
                        localStorage.clear();
                        if (currentUser && deviceId) {
                            db.ref(`devices/${deviceId}`).remove();
                        }
                        deviceId = null;
                        localStorage.removeItem('sb3CallToolDeviceId');
                        window.location.reload();
                    }
                    closeNav();
                }

                async function displayYourReps() {
                    const container = document.getElementById('your-representatives-container');
                    
                    // Check if user has a zip code
                    if (!userProfile.zipCode) {
                        container.classList.add('hidden');
                        return;
                    }
                    
                    try {
                        // Fetch representatives for the user's zip code
                        const docRef = firestore.collection('texas_representatives').doc(userProfile.zipCode);
                        const doc = await docRef.get();
                        
                        if (!doc.exists) {
                            container.innerHTML = '<p style="text-align: center; color: var(--dark-text-secondary);">No representatives found for your zip code.</p>';
                            container.classList.remove('hidden');
                            return;
                        }
                        
                        const zipData = doc.data();
                        
                        // Filter for Texas House and Senate representatives only
                        const texasLegislators = zipData.representatives.filter(rep => 
                            rep.type === 'Texas Senate' || 
                            rep.type === 'Texas House' || 
                            rep.type === 'Texas House (from multi)'
                        );
                        
                        if (texasLegislators.length === 0) {
                            container.classList.add('hidden');
                            return;
                        }
                        
                        // Detect and save districts if not already saved or if zip code changed
                        if (!userProfile.assignedDistricts || userProfile.assignedDistricts.zipCode !== userProfile.zipCode) {
                            const detectedDistricts = detectUserDistricts(texasLegislators);
                            
                            userProfile.assignedDistricts = {
                                ...detectedDistricts,
                                zipCode: userProfile.zipCode,
                                detectedAt: new Date().toISOString()
                            };
                            
                            console.log('Districts detected and saved:', userProfile.assignedDistricts);
                            saveDataToAllStorages();
                        }
                        
                        // Process each legislator and find their matching contact list representative
                        const yourRepsData = [];
                        for (const rep of texasLegislators) {
                            const matchedRep = findRepInContactLists(rep);
                            
                            if (matchedRep) {
                                // Use the existing representative object to ensure data syncing
                                yourRepsData.push(matchedRep.rep);
                            } else {
                                // Create a new representative object if not found in contact lists
                                const chamber = rep.type.includes('Senate') ? 'Senate' : 'House';
                                const districtMatch = rep.district.match(/\d+/);
                                const districtNumber = districtMatch ? districtMatch[0] : rep.district;
                                
                                yourRepsData.push({
                                    id: `yourReps-${Date.now()}-${districtNumber}`,
                                    district: districtNumber,
                                    representative_name: rep.name,
                                    party: 'Unknown', // We don't have party info in the zip code data
                                    email: null,
                                    phone_number: null,
                                    called: false,
                                    emailed: false,
                                    response: 'not_selected',
                                    notes: ''
                                });
                            }
                        }
                        
                        // Create a collapsible section for Your Texas Representatives
                        const yourRepsList = {
                            title: `Your Texas Representatives (Zip: ${userProfile.zipCode})`,
                            reps: yourRepsData
                        };
                        
                        // Store in contactLists for sorting functionality
                        contactLists.set('yourReps', yourRepsList);
                        
                        // Create the collapsible section
                        const section = createCollapsibleListSection(yourRepsList, 'yourReps');
                        container.innerHTML = '';
                        container.appendChild(section);
                        
                        // Get the table body element and render
                        const tableBody = container.querySelector('tbody');
                        renderTable(tableBody, yourRepsData, 'yourReps');
                        
                        container.classList.remove('hidden');
                        
                    } catch (error) {
                        console.error("Error loading representatives:", error);
                        container.innerHTML = '<p style="text-align: center; color: var(--dark-text-secondary);">Error loading representatives. Please try again later.</p>';
                        container.classList.remove('hidden');
                    }
                }
                
                function detectUserDistricts(texasLegislators) {
                    const districts = {
                        houseDistricts: [],
                        senateDistricts: [],
                        multipleHouseDistricts: false,
                        multipleSenateDistricts: false
                    };
                    
                    texasLegislators.forEach(rep => {
                        // Extract district number from the district string
                        const districtMatch = rep.district.match(/\d+/);
                        const districtNumber = districtMatch ? districtMatch[0] : null;
                        
                        if (!districtNumber) return;
                        
                        // Determine if it's House or Senate based on the type
                        if (rep.type === 'Texas Senate') {
                            if (!districts.senateDistricts.includes(districtNumber)) {
                                districts.senateDistricts.push(districtNumber);
                            }
                        } else if (rep.type === 'Texas House' || rep.type === 'Texas House (from multi)') {
                            if (!districts.houseDistricts.includes(districtNumber)) {
                                districts.houseDistricts.push(districtNumber);
                            }
                        }
                    });
                    
                    // Check for multiple districts (zip code spans boundaries)
                    districts.multipleHouseDistricts = districts.houseDistricts.length > 1;
                    districts.multipleSenateDistricts = districts.senateDistricts.length > 1;
                    
                    // Sort districts for consistency
                    districts.houseDistricts.sort((a, b) => parseInt(a) - parseInt(b));
                    districts.senateDistricts.sort((a, b) => parseInt(a) - parseInt(b));
                    
                    console.log('Districts detected:', districts);
                    
                    return districts;
                }
                
                function isUserConstituentOf(rep) {
                    // Check if user is a constituent of the given representative
                    if (!userProfile.assignedDistricts || !rep.district) {
                        return false;
                    }
                    
                    const repDistrict = String(rep.district);
                    const districts = userProfile.assignedDistricts;
                    
                    // Check if it's a House or Senate member based on available data
                    // If we have party info, we can assume House vs Senate
                    // Otherwise, check both lists
                    
                    if (districts.houseDistricts && districts.houseDistricts.includes(repDistrict)) {
                        return true;
                    }
                    
                    if (districts.senateDistricts && districts.senateDistricts.includes(repDistrict)) {
                        return true;
                    }
                    
                    return false;
                }
                
                function findRepInContactLists(zipRep) {
                    // Helper function to normalize names for matching
                    const normalizeName = (name) => {
                        if (!name) return '';
                        // Remove titles
                        name = name.replace(/^(Senator|Representative|Congressman|Congresswoman|Rep\.|Sen\.|Mr\.|Ms\.|Mrs\.)\s+/i, '');
                        // Remove suffixes like Jr., Sr., III, etc.
                        name = name.replace(/\s+(Jr\.?|Sr\.?|III|II|IV|PhD|MD|JD)$/i, '');
                        // Convert to uppercase and remove extra spaces
                        return name.toUpperCase().replace(/\s+/g, ' ').trim();
                    };
                    
                    // Parse name from the rep data (e.g., "Senator Tan Parker" -> "TAN PARKER")
                    const repNameNormalized = normalizeName(zipRep.name);
                    
                    // Search through ALL contact lists (including hidden ones)
                    let foundMatch = null;
                    
                    allContactLists.forEach((list, listId) => {
                        if (!foundMatch) {
                            const match = list.reps.find(contact => {
                                // Handle "LASTNAME, FIRSTNAME" format
                                let contactName = contact.representative_name || contact.name || '';
                                
                                if (contactName.includes(',')) {
                                    // Convert "PARKER, Tan" to "TAN PARKER"
                                    const parts = contactName.split(',').map(p => p.trim());
                                    if (parts.length === 2) {
                                        contactName = `${parts[1]} ${parts[0]}`;
                                    }
                                }
                                
                                const contactNameNormalized = normalizeName(contactName);
                                
                                // Check if names match
                                return contactNameNormalized === repNameNormalized ||
                                       // Also try matching if one name contains the other
                                       contactNameNormalized.includes(repNameNormalized) ||
                                       repNameNormalized.includes(contactNameNormalized);
                            });
                            
                            if (match) {
                                foundMatch = {
                                    rep: match,
                                    listId: listId
                                };
                            }
                        }
                    });
                    
                    return foundMatch;
                }
                
                function findRepContactInfo(rep) {
                    // Helper function to normalize names for matching
                    const normalizeName = (name) => {
                        if (!name) return '';
                        // Remove titles
                        name = name.replace(/^(Senator|Representative|Congressman|Congresswoman|Rep\.|Sen\.|Mr\.|Ms\.|Mrs\.)\s+/i, '');
                        // Convert to uppercase and remove extra spaces
                        return name.toUpperCase().replace(/\s+/g, ' ').trim();
                    };
                    
                    // Parse name from the rep data (e.g., "Senator Tan Parker" -> "TAN PARKER")
                    const repNameNormalized = normalizeName(rep.name);
                    
                    // Search through all contact lists
                    let foundContact = null;
                    
                    contactLists.forEach((list) => {
                        if (!foundContact) {
                            const match = list.reps.find(contact => {
                                // Handle "LASTNAME, FIRSTNAME" format
                                let contactName = contact.representative_name || contact.name || '';
                                
                                if (contactName.includes(',')) {
                                    // Convert "PARKER, Tan" to "TAN PARKER"
                                    const parts = contactName.split(',').map(p => p.trim());
                                    if (parts.length === 2) {
                                        contactName = `${parts[1]} ${parts[0]}`;
                                    }
                                }
                                
                                const contactNameNormalized = normalizeName(contactName);
                                
                                // Check if names match
                                return contactNameNormalized === repNameNormalized ||
                                       // Also try matching if one name contains the other
                                       contactNameNormalized.includes(repNameNormalized) ||
                                       repNameNormalized.includes(contactNameNormalized);
                            });
                            
                            if (match) {
                                foundContact = match;
                            }
                        }
                    });
                    
                    return {
                        email: foundContact?.email || null,
                        phone: foundContact?.phone_number || foundContact?.phone || null
                    };
                }

                function renderAllTables() {
                    dynamicTablesContainer.innerHTML = '';
                    contactLists.forEach((list, listIdentifier) => {
                        // Skip "yourReps" as it's already displayed at the top
                        if (listIdentifier === 'yourReps') return;
                        
                        const listSection = createCollapsibleListSection(list, listIdentifier);
                        dynamicTablesContainer.appendChild(listSection);
                        const tableBody = listSection.querySelector('tbody');
                        renderTable(tableBody, list.reps, listIdentifier);
                    });
                }
                
                function createCollapsibleListSection(list, listIdentifier) {
                    const section = document.createElement('div');
                    section.className = 'list-section';
                    section.id = `section-${listIdentifier}`;
                    
                    // Check saved collapse state
                    const isCollapsed = localStorage.getItem(`collapse-${listIdentifier}`) === 'true';
                    if (isCollapsed) section.classList.add('collapsed');
                    
                    section.innerHTML = `
                        <div class="list-header" data-list-id="${listIdentifier}">
                            <h2 class="list-title">
                                <span class="collapse-icon"><sl-icon name="chevron-down"></sl-icon></span>
                                ${list.title}
                                <span class="rep-count">(${list.reps.length} representatives)</span>
                            </h2>
                        </div>
                        <div class="list-content">
                            <div class="table-container">
                                <table id="repsTable-${listIdentifier}">
                                    <thead>
                                        <tr>
                                            <th class="sortable" data-sort="called" title="Called"><sl-icon name="telephone-fill" style="color: white; font-size: 1.1em;"></sl-icon><span class="sort-indicator"></span></th>
                                            <th class="sortable" data-sort="emailed" title="Emailed"><sl-icon name="envelope-fill" style="color: white; font-size: 1.1em;"></sl-icon><span class="sort-indicator"></span></th>
                                            <th class="sortable" data-sort="district">District<span class="sort-indicator"></span></th>
                                            <th class="sortable" data-sort="representative_name">Representative<span class="sort-indicator"></span></th>
                                            <th class="sortable" data-sort="party" title="Party">D/R<span class="sort-indicator"></span></th>
                                            <th class="sortable" data-sort="email">Email<span class="sort-indicator"></span></th>
                                            <th class="sortable" data-sort="phone_number">Phone<span class="sort-indicator"></span></th>
                                            <th class="sortable" data-sort="response">Response<span class="sort-indicator"></span></th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="cards-container" id="cards-${listIdentifier}"></div>
                        </div>
                    `;
                    
                    // Add collapse/expand listener
                    const header = section.querySelector('.list-header');
                    header.addEventListener('click', () => toggleListCollapse(listIdentifier));
                    
                    // Add sort listeners
                    section.querySelectorAll('th.sortable').forEach(th => {
                        th.addEventListener('click', () => handleSort(listIdentifier, th.dataset.sort));
                    });
                    
                    return section;
                }
                
                function toggleListCollapse(listIdentifier) {
                    const section = document.getElementById(`section-${listIdentifier}`);
                    const isCollapsed = section.classList.toggle('collapsed');
                    localStorage.setItem(`collapse-${listIdentifier}`, isCollapsed);
                }
                
                let sortState = {}; // Track sort state for each list and column
                
                function handleSort(listIdentifier, column) {
                    const list = contactLists.get(listIdentifier);
                    if (!list) return;
                    
                    // Get current sort state
                    const stateKey = `${listIdentifier}-${column}`;
                    if (!sortState[stateKey]) sortState[stateKey] = 'none';
                    
                    // Cycle through: none -> asc -> desc -> none
                    const states = ['none', 'asc', 'desc'];
                    const currentIndex = states.indexOf(sortState[stateKey]);
                    sortState[stateKey] = states[(currentIndex + 1) % states.length];
                    
                    // Clear other column sorts for this list
                    Object.keys(sortState).forEach(key => {
                        if (key.startsWith(listIdentifier) && key !== stateKey) {
                            sortState[key] = 'none';
                        }
                    });
                    
                    // Sort the data
                    const sortedReps = [...list.reps];
                    if (sortState[stateKey] !== 'none') {
                        sortedReps.sort((a, b) => {
                            let aVal = a[column];
                            let bVal = b[column];
                            
                            // Special handling for different column types
                            if (column === 'district') {
                                aVal = parseInt(aVal) || 0;
                                bVal = parseInt(bVal) || 0;
                            } else if (column === 'called' || column === 'emailed') {
                                aVal = aVal ? 1 : 0;
                                bVal = bVal ? 1 : 0;
                            } else if (column === 'response') {
                                aVal = a.called ? (a.response || 'zzz') : 'zzzz';
                                bVal = b.called ? (b.response || 'zzz') : 'zzzz';
                            } else {
                                aVal = (aVal || '').toString().toLowerCase();
                                bVal = (bVal || '').toString().toLowerCase();
                            }
                            
                            if (aVal < bVal) return sortState[stateKey] === 'asc' ? -1 : 1;
                            if (aVal > bVal) return sortState[stateKey] === 'asc' ? 1 : -1;
                            return 0;
                        });
                    }
                    
                    // Update UI
                    const table = document.getElementById(`repsTable-${listIdentifier}`);
                    const headers = table.querySelectorAll('th.sortable');
                    headers.forEach(th => {
                        th.classList.remove('sort-asc', 'sort-desc');
                        if (th.dataset.sort === column && sortState[stateKey] !== 'none') {
                            th.classList.add(`sort-${sortState[stateKey]}`);
                        }
                    });
                    
                    // Re-render table body
                    const tableBody = table.querySelector('tbody');
                    renderTable(tableBody, sortedReps, listIdentifier);
                }

                function renderTable(tableBodyElement, dataArray, listIdentifier) {
                    if (!tableBodyElement) return;
                    tableBodyElement.innerHTML = ''; 
                    dataArray.forEach((rep) => {
                        const row = tableBodyElement.insertRow();
                        row.setAttribute('data-id', rep.id);
                        row.setAttribute('data-list', listIdentifier);
                        const cellCalled = row.insertCell();
                        const calledCheckbox = document.createElement('input');
                        calledCheckbox.type = 'checkbox';
                        calledCheckbox.checked = !!rep.called;
                        calledCheckbox.dataset.repId = rep.id;
                        calledCheckbox.dataset.list = listIdentifier;
                        calledCheckbox.addEventListener('change', handleCalledChange);
                        cellCalled.appendChild(calledCheckbox);
                        const cellEmailed = row.insertCell();
                        const emailedCheckbox = document.createElement('input');
                        emailedCheckbox.type = 'checkbox';
                        emailedCheckbox.checked = !!rep.emailed;
                        emailedCheckbox.dataset.repId = rep.id;
                        emailedCheckbox.dataset.list = listIdentifier;
                        emailedCheckbox.addEventListener('change', handleEmailedChange);
                        cellEmailed.appendChild(emailedCheckbox);
                        row.insertCell().textContent = rep.district;
                        row.insertCell().textContent = rep.representative_name || 'N/A';
                        row.insertCell().textContent = rep.party;
                        const cellEmail = row.insertCell();
                        const emailLink = document.createElement('a');
                        emailLink.href = "#"; 
                        emailLink.textContent = rep.email;
                        emailLink.dataset.email = rep.email;
                        emailLink.dataset.repName = rep.representative_name || 'N/A';
                        emailLink.dataset.repId = rep.id;
                        emailLink.dataset.list = listIdentifier;
                        emailLink.classList.add('email-link');
                        emailLink.addEventListener('click', handleEmailClick);
                        cellEmail.appendChild(emailLink);
                        const cellPhone = row.insertCell();
                        const phoneLink = document.createElement('a');
                        phoneLink.href = `tel:${(rep.phone_number || '').replace(/\D/g, '')}`;
                        phoneLink.textContent = rep.phone_number || 'N/A';
                        cellPhone.appendChild(phoneLink);
                        const cellResponseSummary = row.insertCell();
                        cellResponseSummary.classList.add('response-summary-cell');
                        updateResponseSummaryCell(cellResponseSummary, rep);
                    });
                    
                    // After rendering table, also render cards for mobile
                    const cardsContainer = document.getElementById(`cards-${listIdentifier}`);
                    if (cardsContainer) {
                        renderCards(cardsContainer, dataArray, listIdentifier);
                    }
                    
                    // After rendering, check if table container is scrollable
                    setTimeout(() => {
                        const tableContainer = tableBodyElement.closest('.table-container');
                        if (tableContainer) {
                            checkScrollable(tableContainer);
                        }
                    }, 100);
                }
                
                function renderCards(cardsContainer, dataArray, listIdentifier) {
                    cardsContainer.innerHTML = '';
                    dataArray.forEach((rep) => {
                        const card = document.createElement('div');
                        card.className = 'rep-card';
                        card.setAttribute('data-id', rep.id);
                        card.setAttribute('data-list', listIdentifier);
                        
                        card.innerHTML = `
                            <div class="card-header">
                                <div class="card-checkboxes">
                                    <label class="card-checkbox-label">
                                        <input type="checkbox" ${rep.called ? 'checked' : ''} data-rep-id="${rep.id}" data-list="${listIdentifier}" class="card-called-checkbox">
                                        <sl-icon name="telephone-fill"></sl-icon>
                                        Called
                                    </label>
                                    <label class="card-checkbox-label">
                                        <input type="checkbox" ${rep.emailed ? 'checked' : ''} data-rep-id="${rep.id}" data-list="${listIdentifier}" class="card-emailed-checkbox">
                                        <sl-icon name="envelope-fill"></sl-icon>
                                        Emailed
                                    </label>
                                </div>
                                <div class="card-district-party">
                                    District ${rep.district} - ${rep.party}
                                </div>
                            </div>
                            <div class="card-name">${rep.representative_name || 'N/A'}</div>
                            <div class="card-contact">
                                ${rep.email ? `
                                    <div class="card-contact-item">
                                        <sl-icon name="envelope"></sl-icon>
                                        <a href="#" class="card-email-link" data-email="${rep.email}" data-rep-name="${rep.representative_name || 'N/A'}" data-rep-id="${rep.id}" data-list="${listIdentifier}">${rep.email}</a>
                                    </div>
                                ` : ''}
                                ${rep.phone_number ? `
                                    <div class="card-contact-item">
                                        <sl-icon name="telephone"></sl-icon>
                                        <a href="tel:${rep.phone_number.replace(/\D/g, '')}">${rep.phone_number}</a>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="card-response">
                                ${rep.called ? 
                                    `<strong>Response:</strong> ${getResponseText(rep.response)}<br>
                                    ${rep.notes ? `<strong>Notes:</strong> ${rep.notes}` : ''}` :
                                    '<em>Not called yet</em>'
                                }
                            </div>
                        `;
                        
                        // Add event listeners
                        const calledCheckbox = card.querySelector('.card-called-checkbox');
                        calledCheckbox.addEventListener('change', handleCalledChange);
                        
                        const emailedCheckbox = card.querySelector('.card-emailed-checkbox');
                        emailedCheckbox.addEventListener('change', handleEmailedChange);
                        
                        const emailLink = card.querySelector('.card-email-link');
                        if (emailLink) {
                            emailLink.addEventListener('click', handleEmailClick);
                        }
                        
                        cardsContainer.appendChild(card);
                    });
                }
                
                function getResponseText(response) {
                    const selectedOptionText = responseOptions.find(opt => opt.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/^$/, 'not_selected') === response);
                    return selectedOptionText || (response !== 'not_selected' ? String(response).replace(/_/g, ' ') : 'No response logged');
                }
                
                function checkScrollable(container) {
                    // Check if content is taller than container
                    const isScrollable = container.scrollHeight > container.clientHeight;
                    
                    if (isScrollable) {
                        container.classList.add('has-scroll');
                        // Force scrollbar visibility
                        container.style.overflowY = 'scroll';
                        
                        // Add scroll indicator message if not already present
                        if (!container.querySelector('.scroll-indicator-message')) {
                            const indicator = document.createElement('div');
                            indicator.className = 'scroll-indicator-message';
                            indicator.textContent = '↓ Scroll for more';
                            container.appendChild(indicator);
                        }
                        
                        console.log(`Table container is scrollable. Height: ${container.clientHeight}px, Content: ${container.scrollHeight}px, Overflow: ${container.style.overflowY}`);
                        
                        // Log the specific list that's having issues
                        const table = container.querySelector('table');
                        if (table) {
                            const listId = table.id;
                            const rowCount = table.querySelectorAll('tbody tr').length;
                            console.log(`List ${listId} has ${rowCount} rows`);
                        }
                    } else {
                        container.classList.remove('has-scroll');
                        // Remove indicator if present
                        const indicator = container.querySelector('.scroll-indicator-message');
                        if (indicator) {
                            indicator.remove();
                        }
                        console.log(`Table container is not scrollable. Height: ${container.clientHeight}px, Content: ${container.scrollHeight}px`);
                    }
                    
                    // Force a reflow to ensure browser updates
                    container.offsetHeight;
                }
                
                // Check all table containers on window resize
                window.addEventListener('resize', () => {
                    document.querySelectorAll('.table-container').forEach(container => {
                        checkScrollable(container);
                    });
                });

                function updateResponseSummaryCell(cell, rep) {
                    if (rep.called) { 
                        let summaryText = 'N/A';
                        const selectedOptionText = responseOptions.find(opt => opt.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/^$/, 'not_selected') === rep.response);
                        summaryText = selectedOptionText || (rep.response !== 'not_selected' ? String(rep.response).replace(/_/g, ' ') : 'No response logged');
                        let summary = `Response: ${summaryText}`;
                        if (rep.notes) summary += `<br>Notes: ${String(rep.notes).substring(0, 35)}${String(rep.notes).length > 35 ? '...' : ''}`;
                        cell.innerHTML = summary;
                    } else {
                        cell.innerHTML = '<i>Not called yet</i>';
                    }
                }
                
                function getRepresentativeListByIdentifier(listIdentifier) {
                    return contactLists.get(listIdentifier)?.reps || [];
                }

                function handleCalledChange(event) {
                    const repId = event.target.dataset.repId;
                    const listIdentifier = event.target.dataset.list;
                    const currentList = getRepresentativeListByIdentifier(listIdentifier);
                    const repIndex = currentList.findIndex(r => r.id === repId);
                    if (repIndex === -1) return;
                    const rep = currentList[repIndex];
                    rep.called = event.target.checked;
                    const row = event.target.closest('tr'); 
                    const summaryCell = row ? row.cells[row.cells.length -1] : null; 
                    if (rep.called) { 
                        document.getElementById('currentRepIdForModal').value = rep.id;
                        document.getElementById('currentListIdentifierForModal').value = listIdentifier;
                        document.getElementById('responseModalTitle').textContent = `Log Response: ${rep.name}`;
                        modalResponseSelect.value = rep.response || 'not_selected';
                        document.getElementById('modalNotesTextarea').value = rep.notes || '';
                        responseModal.style.display = 'block';
                    } else { 
                        rep.response = 'not_selected';
                        rep.notes = '';
                        if (summaryCell) updateResponseSummaryCell(summaryCell, rep);
                    }
                    saveDataToAllStorages();
                }

                function handleEmailedChange(event) {
                    const repId = event.target.dataset.repId;
                    const listIdentifier = event.target.dataset.list;
                    const currentList = getRepresentativeListByIdentifier(listIdentifier);
                    const repIndex = currentList.findIndex(r => r.id === repId);
                    if (repIndex !== -1) {
                        currentList[repIndex].emailed = event.target.checked;
                        saveDataToAllStorages();
                    }
                }
                
                async function handleEmailClick(event) {
                    event.preventDefault();
                    const targetLink = event.currentTarget;
                    const repId = targetLink.dataset.repId;
                    const listIdentifier = targetLink.dataset.list;
                    const currentList = getRepresentativeListByIdentifier(listIdentifier);
                    const rep = currentList.find(r => r.id === repId);

                    console.log('Debug handleEmailClick:', {
                        repId,
                        listIdentifier,
                        currentListLength: currentList.length,
                        rep,
                        firstRepInList: currentList[0]
                    });

                    if (!rep) {
                        alert("Representative data not found. Please refresh the page and try again.");
                        return;
                    }

                    if (!userProfile.onboardingComplete) {
                        alert("Please complete your Communications Profile from 'Edit My Info' before generating emails.");
                        editMyInfoButton.click();
                        return;
                    }

                    const emailGenModal = document.getElementById('emailGenerationModal');
                    const spinner = document.getElementById('emailGenSpinner');
                    const content = document.getElementById('emailGenContent');
                    
                    emailGenModal.style.display = 'block';
                    spinner.classList.remove('hidden');
                    content.classList.add('hidden');

                    if (llmToggle.checked) {
                        try {
                            let emailData = null;
                            
                            // Check cache first
                            const cachedEmail = emailCache.cache.get(repId);
                            if (cachedEmail && isEmailCacheValid(cachedEmail) && cachedEmail.userProfileHash === getUserProfileHash()) {
                                console.log(`Using cached email for ${rep.representative_name}`);
                                emailData = cachedEmail;
                            } else {
                                // Check if already generating for this rep
                                if (emailCache.currentlyGenerating === repId) {
                                    console.log(`Waiting for in-progress generation for ${rep.representative_name}`);
                                    const result = await emailCache.generationPromise;
                                    if (result) {
                                        emailData = emailCache.cache.get(repId);
                                    }
                                } else {
                                    // Generate fresh
                                    console.log(`Generating fresh email for ${rep.representative_name}`);
                                    const generateEmail = functions.httpsCallable('generateEmail');
                                    const result = await generateEmail({ userProfile, representative: rep });
                                    
                                    // Save to cache
                                    await saveEmailToCache(repId, {
                                        subject: result.data.subject,
                                        body: result.data.body,
                                        repData: rep
                                    });
                                    
                                    emailData = {
                                        subject: result.data.subject,
                                        body: result.data.body
                                    };
                                }
                            }
                            
                            // Queue the next rep for background generation
                            const next = determineNextRep(rep, listIdentifier);
                            if (next && !emailCache.cache.has(next.rep.id)) {
                                setTimeout(() => {
                                    generateEmailInBackground(next.rep, next.listId);
                                }, 500);
                            }
                            
                            // Use the email data
                            document.getElementById('generatedSubject').value = emailData.subject;
                            document.getElementById('generatedBody').value = emailData.body;
                            
                            // Update copy button values
                            updateCopyButton('subject', emailData.subject);
                            updateCopyButton('body', emailData.body);

                            // Store current email data for rating
                            currentEmailData = {
                                repName: rep.representative_name || rep.name || 'N/A',
                                subject: emailData.subject,
                                body: emailData.body,
                                rep: rep  // Store the full rep object for new drafts
                            };

                            // Reset rating buttons
                            document.getElementById('thumbsUpBtn').classList.remove('selected');
                            document.getElementById('thumbsDownBtn').classList.remove('selected');
                            
                            // Show rating buttons for AI mode
                            document.querySelector('.email-rating-container').style.display = 'flex';
                            
                            // Initialize draft history for this rep if needed
                            if (!draftHistory.drafts.has(repId)) {
                                draftHistory.drafts.set(repId, [{
                                    subject: emailData.subject,
                                    body: emailData.body,
                                    timestamp: new Date().toISOString()
                                }]);
                                draftHistory.currentIndex.set(repId, 0);
                            }
                            
                            // Update draft navigation (will be hidden if only 1 draft)
                            updateDraftNavigation(repId);
                            
                            spinner.classList.add('hidden');
                            content.classList.remove('hidden');

                            document.getElementById('approveAndSendEmail').onclick = () => {
                                const finalSubject = document.getElementById('generatedSubject').value;
                                const finalBody = document.getElementById('generatedBody').value;

                                // If no explicit rating was given, infer positive rating when sending
                                const hasRating = userProfile.ratedEmails && userProfile.ratedEmails.some(
                                    email => email.subject === currentEmailData.subject && 
                                            email.body === currentEmailData.body
                                );
                                
                                if (!hasRating) {
                                    if (!userProfile.ratedEmails) {
                                        userProfile.ratedEmails = [];
                                    }
                                    userProfile.ratedEmails.push({
                                        repName: currentEmailData.repName,
                                        subject: currentEmailData.subject,
                                        body: currentEmailData.body,
                                        rating: 'positive',
                                        timestamp: new Date().toISOString()
                                    });
                                }

                                const repIndex = currentList.findIndex(r => r.id === repId);
                                if (repIndex !== -1) {
                                    currentList[repIndex].emailed = true;
                                    const row = targetLink.closest('tr');
                                    const emailedCheckboxInRow = row ? row.querySelector('td:nth-child(2) input[type="checkbox"]') : null;
                                    if (emailedCheckboxInRow) emailedCheckboxInRow.checked = true;
                                }
                                
                                saveDataToAllStorages();
                                
                                window.location.href = `mailto:${rep.email}?subject=${encodeURIComponent(finalSubject)}&body=${encodeURIComponent(finalBody)}`;
                                emailGenModal.style.display = 'none';
                            };

                        } catch (error) {
                            console.error("Error calling generateEmail function:", error);
                            alert("Failed to generate email. Please try again later.");
                            emailGenModal.style.display = 'none';
                        }
                    } else {
                        // Use the template with AI-generated subject
                        let subject = getNextSubjectLine(); // Use AI-generated subject
                        let body = emailBodyTemplateInput.value;

                        const repName = formatRepName(rep.representative_name || 'Representative');
                        
                        // Determine user identity based on constituent status
                        const isConstituent = isUserConstituentOf(rep);
                        let userIdentity = '';
                        
                        if (isConstituent) {
                            // They are a constituent - use their location
                            const location = userProfile.userLocation || 'your district';
                            userIdentity = `your constituent from ${location}`;
                        } else {
                            // Not a constituent - use tone-based Texas identity
                            const primaryTone = userProfile.intelligentDraftingProfile?.communicationTone?.primaryTone;
                            
                            // Select appropriate identity based on communication tone
                            switch(primaryTone) {
                                case 'CIVIC_PATRIOTIC':
                                    userIdentity = 'a proud Texan';
                                    break;
                                case 'POLICY_ANALYTICAL':
                                    userIdentity = 'a Texas policy advocate';
                                    break;
                                case 'PERSONAL_NARR':
                                    userIdentity = 'a fellow Texan';
                                    break;
                                case 'SOLUTION_ORIENT':
                                    userIdentity = 'a Texas resident focused on solutions';
                                    break;
                                case 'INSPIRATIONAL':
                                    userIdentity = 'a hopeful Texas resident';
                                    break;
                                default:
                                    userIdentity = 'a concerned Texan';
                            }
                        }
                        
                        // Replace placeholders in body (subject is already complete)
                        body = body.replace(/{repName}/g, repName)
                                   .replace(/{userName}/g, userProfile.userFullName || 'a concerned constituent')
                                   .replace(/{userIdentity}/g, userIdentity);

                        document.getElementById('generatedSubject').value = subject;
                        document.getElementById('generatedBody').value = body;
                        
                        // Update copy button values
                        updateCopyButton('subject', subject);
                        updateCopyButton('body', body);

                        // Hide rating buttons for template mode
                        document.querySelector('.email-rating-container').style.display = 'none';

                        spinner.classList.add('hidden');
                        content.classList.remove('hidden');

                        document.getElementById('approveAndSendEmail').onclick = () => {
                            const finalSubject = document.getElementById('generatedSubject').value;
                            const finalBody = document.getElementById('generatedBody').value;

                            const repIndex = currentList.findIndex(r => r.id === repId);
                            if (repIndex !== -1) {
                                currentList[repIndex].emailed = true;
                                const row = targetLink.closest('tr');
                                const emailedCheckboxInRow = row ? row.querySelector('td:nth-child(2) input[type="checkbox"]') : null;
                                if (emailedCheckboxInRow) emailedCheckboxInRow.checked = true;
                            }
                            
                            saveDataToAllStorages();
                            
                            window.location.href = `mailto:${rep.email}?subject=${encodeURIComponent(finalSubject)}&body=${encodeURIComponent(finalBody)}`;
                            emailGenModal.style.display = 'none';
                        };
                    }
                }
                
                async function fetchAndProcessData(fileUrl, listIdentifier) {
                    try {
                        const response = await fetch(fileUrl);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${fileUrl}`);
                        const jsonData = await response.json();
                        return jsonData.map((rep, index) => ({
                            id: `${listIdentifier}-${index}-${rep.district}`, 
                            district: rep.district, name: rep.representative_name, phone: rep.phone_number,
                            party: rep.party, email: rep.email, list: listIdentifier 
                        }));
                    } catch (error) {
                        console.error(`Error fetching initial data for ${listIdentifier} from ${fileUrl}:`, error);
                        return [];
                    }
                }

                initializeApp().catch(e => {
                    alert("CRITICAL ERROR during app initialization: " + e.message);
                    console.error("CRITICAL ERROR during app initialization:", e);
                });
            });
        } catch (e) {
            alert("CRITICAL ERROR SETTING UP DOMContentLoaded: " + e.message);
            console.error("CRITICAL ERROR SETTING UP DOMContentLoaded:", e);
        }
    </script>
</body>
</html>
