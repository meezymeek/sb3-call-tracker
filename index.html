<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SB3 Stakeholders Call Tracker</title>
    <style>
        :root {
            --dark-bg-primary: #1e1e1e;
            --dark-bg-secondary: #2c2c2c;
            --dark-bg-tertiary: #383838;
            --dark-text-primary: #e0e0e0;
            --dark-text-secondary: #b0b0b0;
            --accent-green: #4CAF50;
            --accent-green-darker: #388E3C;
            --border-color-dark: #444444;
            --utility-button-bg: #5a5a5a;
            --utility-button-hover-bg: #4a4a4a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 25px;
            background-color: var(--dark-bg-secondary);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--accent-green);
        }

        header h1 {
            color: var(--accent-green);
            margin: 0 0 5px 0;
            font-size: 2.2em;
        }
        .version-number {
            display: block;
            font-size: 0.8em;
            color: var(--dark-text-secondary);
            margin-bottom: 10px;
        }

        header p {
            color: var(--dark-text-secondary);
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .report-problem-link {
            font-size: 0.85em;
            color: var(--dark-text-secondary);
        }
        .report-problem-link a {
            color: var(--accent-green-darker);
        }
        .report-problem-link a:hover {
            color: var(--accent-green);
        }


        .controls, .email-template-section {
            margin-bottom: 25px;
            padding: 15px;
            background-color: var(--dark-bg-tertiary);
            border-radius: 6px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .email-template-section {
            flex-direction: column;
            align-items: flex-start;
        }

        .email-template-section label {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--dark-text-primary);
        }
        
        .email-template-section input[type="text"],
        .email-template-section textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color-dark);
            border-radius: 4px;
            font-size: 0.95em;
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }
        .email-template-section input[type="text"]:focus,
        .email-template-section textarea:focus {
            border-color: var(--accent-green);
            outline: none;
        }
        
        .email-template-section textarea {
            min-height: 120px; 
            resize: vertical;
        }
        .email-template-section small {
            color: var(--dark-text-secondary);
        }

        .controls button, .controls label.button-like {
            padding: 10px 15px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            flex-grow: 1; 
        }
        /* Primary Action Buttons */
        .controls button#exportData, 
        .controls label.button-like[for="importFile"] {
            background-color: var(--accent-green);
        }
        .controls button#exportData:hover, 
        .controls label.button-like[for="importFile"]:hover {
            background-color: var(--accent-green-darker);
        }

        /* Utility/Secondary Buttons */
        .controls button#resetData,
        .controls button#editMyInfo,
        .controls button#showGuideBtn {
            background-color: var(--utility-button-bg);
        }
        .controls button#resetData:hover,
        .controls button#editMyInfo:hover,
        .controls button#showGuideBtn:hover {
            background-color: var(--utility-button-hover-bg);
        }
        
        .controls input[type="file"] {
            display: none;
        }

        .table-container {
            overflow-x: auto; 
        }

        table {
            width: 100%; 
            border-collapse: collapse;
            margin-bottom: 25px;
            table-layout: fixed; 
        }

        th, td {
            padding: 12px 8px; 
            text-align: left;
            border-bottom: 1px solid var(--border-color-dark);
            vertical-align: middle;
            word-break: break-word; 
            overflow-wrap: break-word;
        }
        
        td a { 
            word-break: break-all;
            overflow-wrap: break-word; 
        }

        th {
            background-color: var(--accent-green);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        th:nth-child(1), td:nth-child(1) { width: 8%; }  
        th:nth-child(2), td:nth-child(2) { width: 8%; }  
        th:nth-child(3), td:nth-child(3) { width: 8%; }  
        th:nth-child(4), td:nth-child(4) { width: 18%; } 
        th:nth-child(5), td:nth-child(5) { width: 23%; } 
        th:nth-child(6), td:nth-child(6) { width: 15%; } 
        th:nth-child(7), td:nth-child(7) { width: 20%; } 

        tr:nth-child(even) {
            background-color: var(--dark-bg-tertiary); 
        }

        tr:hover {
            background-color: #404040; 
        }

        input[type="checkbox"] {
            transform: scale(1.2); 
            margin-right: 3px; 
            cursor: pointer;
            vertical-align: middle;
            /* Consider accent-color for better dark mode visibility, if supported widely */
            /* accent-color: var(--accent-green); */
        }
        
        a { 
            color: var(--accent-green);
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
            color: var(--accent-green-darker);
        }
        
        .footer-actions {
            margin-top: 30px;
            text-align: right;
        }
         .footer-actions button {
            margin-left: 10px;
         }
         .footer-actions button#saveAllChanges {
            background-color: var(--accent-green);
            color: white; /* Ensure text is white */
         }
         .footer-actions button#saveAllChanges:hover {
            background-color: var(--accent-green-darker);
         }

        .response-summary-cell {
            font-size: 0.85em;
            color: var(--dark-text-secondary);
            line-height: 1.4;
        }
        .response-summary-cell i {
            color: #888;
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.7); 
            padding-top: 40px;
        }

        .modal-content {
            background-color: var(--dark-bg-secondary);
            margin: 5% auto; 
            padding: 25px;
            border: 1px solid var(--border-color-dark);
            width: 80%; 
            max-width: 600px; 
            border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.4),0 6px 20px 0 rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-content h2, .modal-content h3 {
            margin-top: 0;
            color: var(--accent-green);
        }
        .modal-content h4 { 
            color: var(--accent-green-darker);
            margin-top: 1.2em;
            margin-bottom: 0.5em;
        }

        .modal-content label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark-text-primary);
        }
        .modal-content input[type="text"], 
        .modal-content select, 
        .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color-dark);
            border-radius: 4px;
            font-size: 1em;
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }
        .modal-content input[type="text"]:focus, 
        .modal-content select:focus, 
        .modal-content textarea:focus {
            border-color: var(--accent-green);
            outline: none;
        }
        .modal-content select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e0e0e0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
            padding-right: 2em;
        }
        .modal-content textarea {
            min-height: 100px;
            resize: vertical;
        }
        .modal-content button { /* Applies to Save Onboarding, Save Response */
            background-color: var(--accent-green);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
            margin-right: 10px;
        }
        .modal-content button:hover {
            background-color: var(--accent-green-darker);
        }
        .modal-content button.button-outline { /* Applies to Cancel, Dismiss Guide */
            background-color: transparent;
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }
        .modal-content button.button-outline:hover {
            background-color: rgba(76, 175, 80, 0.1); 
        }
        .modal-content ul {
            padding-left: 20px;
            margin-top: 0.5em;
        }
        .modal-content li {
            margin-bottom: 0.5em;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--dark-text-primary);
            text-decoration: none;
            cursor: pointer;
        }

        @media screen and (max-width: 768px) {
            .container { width: 98%; padding: 15px; margin-top: 10px; }
            header h1 { font-size: 1.6em; }
            header p { font-size: 0.95em; }
            .controls { flex-direction: row; }
            .controls button, .controls label.button-like { 
                width: auto; 
                flex-grow: 0; 
                margin-bottom: 5px; 
            }
            @media (max-width: 600px) { 
                .controls { flex-direction: column; }
                .controls button, .controls label.button-like { width: 100%; margin-bottom: 10px; }
            }

            th, td { padding: 8px 4px; font-size: 0.7em; } 
            th:nth-child(1), td:nth-child(1) { width: 10%; } 
            th:nth-child(2), td:nth-child(2) { width: 10%; } 
            th:nth-child(3), td:nth-child(3) { width: 10%; } 
            th:nth-child(4), td:nth-child(4) { width: 18%; } 
            th:nth-child(5), td:nth-child(5) { width: 22%; } 
            th:nth-child(6), td:nth-child(6) { width: 10%; } 
            th:nth-child(7), td:nth-child(7) { width: 20%; } 

            .modal-content { width: 90%; margin: 10% auto; padding: 20px; }
        }
         @media screen and (max-width: 480px) {
            header h1 { font-size: 1.4em; }
            .version-number { font-size: 0.75em; }
            .report-problem-link { font-size: 0.8em; }

            th, td { padding: 6px 3px; font-size: 0.65em; } 

            th:nth-child(3), td:nth-child(3) { display: none; } 
            th:nth-child(1), td:nth-child(1) { width: 12%; } 
            th:nth-child(2), td:nth-child(2) { width: 12%; } 
            th:nth-child(4), td:nth-child(4) { width: 22%; } 
            th:nth-child(5), td:nth-child(5) { width: 26%; } 
            th:nth-child(6), td:nth-child(6) { width: 8%; }  
            th:nth-child(7), td:nth-child(7) { width: 20%; } 
         }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SB3 Stakeholders Call Tracker</h1>
            <span class="version-number">v1.0</span>
            <p>Track your calls and emails to representatives, their responses, and your notes.</p>
            <div class="report-problem-link">
                <a href="mailto:hayden@delta8denton.com?subject=Problem Report - SB3 Call Tracker v1.0">Report Problems</a>
            </div>
        </header>

        <div class="controls">
            <button id="showGuideBtn">User Guide</button> 
            <button id="exportData">Export Progress</button>
            <label for="importFile" class="button-like">Import Progress</label>
            <input type="file" id="importFile" accept=".json">
            <button id="editMyInfo">Edit My Info</button>
            <button id="resetData">Reset All Data</button>
        </div>

        <div class="email-template-section">
            <label for="emailSubjectTemplate">Email Subject Template:</label>
            <input type="text" id="emailSubjectTemplate">
            
            <label for="emailBodyTemplate" style="margin-top:10px;">Email Body Template:</label>
            <textarea id="emailBodyTemplate"></textarea>
            <small><em>Placeholders: {RepName}, {UserName}, {UserLocation}. Click an email in the table to use this template.</em></small>
        </div>

        <div class="table-container">
            <table id="repsTable">
                <thead>
                    <tr>
                        <th>Called</th>
                        <th>Emailed</th>
                        <th>District</th>
                        <th>Representative</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Response Summary</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
         <div class="footer-actions">
            <button id="saveAllChanges" class="button-like">Save All Changes</button>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboardingModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeOnboardingModal">&times;</span>
            <h2>Welcome! Let's Get You Set Up</h2>
            <p>Please provide a few details to personalize your email templates. This information is stored locally in your browser.</p>
            <label for="onboardingUserName">Your Full Name (for email signature):</label>
            <input type="text" id="onboardingUserName" placeholder="e.g., Jane Doe">
            
            <label for="onboardingUserLocation">Your City/Town (e.g., "Austin resident"):</label>
            <input type="text" id="onboardingUserLocation" placeholder="e.g., Austin, TX or concerned Texan">
            
            <button id="saveOnboardingInfo">Save and Continue</button>
        </div>
    </div>

    <!-- Response Modal -->
    <div id="responseModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeResponseModal">&times;</span>
            <h3 id="responseModalTitle">Log Call Response</h3>
            <input type="hidden" id="currentRepIdForModal">

            <label for="modalResponseSelect">Response:</label>
            <select id="modalResponseSelect">
                <!-- Options populated by JS -->
            </select>

            <label for="modalNotesTextarea">Notes (e.g., staffer name, key points discussed):</label>
            <textarea id="modalNotesTextarea" placeholder="Enter notes here..."></textarea>
            
            <button id="saveResponseModal">Save Response</button>
            <button id="cancelResponseModal" class="button-outline">Cancel</button>
        </div>
    </div>

    <!-- User Guide Modal -->
    <div id="guideModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeGuideModal">&times;</span>
            <h2>SB3 Call Tracker - Easy Mobile Guide (v1.0)</h2>
            <p>This tool is like a digital checklist to help you contact lawmakers about SB3 using your phone. It remembers what you've done.</p>

            <h4>1. First Time Opening? (Quick Setup):</h4>
            <ul>
                <li>A "Welcome" box will pop up.</li>
                <li>Type in your <strong>Full Name</strong> (so emails can have your signature).</li>
                <li>Type in your <strong>City/Town</strong> (like "Austin resident" or just "Texas").</li>
                <li>Tap "Save and Continue." That's it for setup!</li>
                <li><em>Need to change your name/town later? Tap "Edit My Info."</em></li>
            </ul>

            <h4>2. Sending Emails (Easy Mode):</h4>
            <ul>
                <li>The tool has a pre-written email ready for you.</li>
                <li>If you want to peek or change it, look for "Email Subject Template" and "Email Body Template" on the main screen. (Most people won't need to touch this).</li>
            </ul>

            <h4>3. Contacting Lawmakers (The List):</h4>
            <p>You'll see a list of lawmakers. Here's how to track your contacts:</p>
            <ul>
                <li><strong>To Call a Lawmaker:</strong>
                    <ul>
                        <li>Find their name and tap their <strong>Phone Number</strong>. Your phone should offer to call.</li>
                        <li>After your call, find that lawmaker in the list and check the little box in the <strong>"Called"</strong> column.</li>
                        <li>A new box will pop up:
                            <ul>
                                <li><strong>Response:</strong> Pick how the call went (like "For," "Against," or "Left Voicemail").</li>
                                <li><strong>Notes:</strong> You can type quick notes here (like "Spoke to Aide Sarah").</li>
                            </ul>
                        </li>
                        <li>Tap "Save Response."</li>
                    </ul>
                </li>
                <li><strong>To Email a Lawmaker:</strong>
                    <ul>
                        <li>Find their name and tap their <strong>Email Address</strong>. Your phone's email app should open with the email mostly written for you!</li>
                        <li>Just check it over and hit "Send" in your email app.</li>
                        <li>The tool will automatically check the box in the <strong>"Emailed"</strong> column for you.</li>
                    </ul>
                </li>
                <li><strong>Keeping Track:</strong>
                    <ul>
                        <li>The <strong>"Called"</strong> and <strong>"Emailed"</strong> boxes show who you've contacted.</li>
                        <li>The "Response Summary" column shows what happened on your calls.</li>
                    </ul>
                </li>
            </ul>

            <h4>4. Your Progress:</h4>
            <ul>
                <li><strong>It Saves Automatically!</strong> When you check boxes or save call notes, the tool remembers.</li>
                <li><strong>"Save All Changes" Button:</strong> If you <em>do</em> change the email templates, tap this green button at the bottom to save those specific changes.</li>
                <li><strong>Export Progress:</strong> Think of this as "Save a Copy." It downloads a special file with all your work. Good if you want a backup.</li>
                <li><strong>Import Progress:</strong> Lets you load a saved copy (an exported file) back into the tool.</li>
                <li><strong>Reset All Data:</strong> Wipes everything clean and starts over. <strong>Be careful, it can't be undone!</strong></li>
            </ul>
            
            <h4>Tips for Your Phone:</h4>
            <ul>
                <li>Everything should fit on your screen. If text is long, it will wrap to the next line.</li>
                <li>On really small phone screens, the "District" info might hide to make more space.</li>
            </ul>

            <h4>Got a Problem with the Tool?</h4>
            <p>Look under the big title at the top for a "Report Problems" link. Tap it to send an email.</p>
            <button id="dismissGuideModal" class="button-outline" style="margin-top: 20px;">Dismiss</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DATA ---
            const initialRepresentativesData = [
                { id: '22', district: '22', name: 'Christian Manuel', email: 'christian.manuel@house.texas.gov', phone: '(512) 463-0508' },
                { id: '27', district: '27', name: 'Ron Reynolds', email: 'ron.reynolds@house.texas.gov', phone: '(512) 463-0490' },
                { id: '35', district: '35', name: 'Oscar Longoria', email: 'oscar.longoria@house.texas.gov', phone: '(512) 463-0645' },
                { id: '36', district: '36', name: 'Sergio Muñoz Jr.', email: 'sergio.munoz@house.texas.gov', phone: '(512) 463-0704' },
                { id: '37', district: '37', name: 'Janie Lopez', email: 'janie.lopez@house.texas.gov', phone: '(512) 463-0600' },
                { id: '38', district: '38', name: 'Erin Gamez', email: 'erin.gamez@house.texas.gov', phone: '(512) 463-0426' },
                { id: '41', district: '41', name: 'Bobby Guerra', email: 'bobby.guerra@house.texas.gov', phone: '(512) 463-0578' },
                { id: '45', district: '45', name: 'Erin Zwiener', email: 'erin.zwiener@house.texas.gov', phone: '(512) 463-0647' },
                { id: '46', district: '46', name: 'Sheryl Cole', email: 'sheryl.cole@house.texas.gov', phone: '(512) 463-0506' },
                { id: '47', district: '47', name: 'Vikki Goodwin', email: 'vikki.goodwin@house.texas.gov', phone: '(512) 463-0652' },
                { id: '49', district: '49', name: 'Gina Hinojosa', email: 'gina.hinojosa@house.texas.gov', phone: '(512) 463-0668' },
                { id: '50', district: '50', name: 'James Talarico', email: 'james.talarico@house.texas.gov', phone: '(512) 463-0670' },
                { id: '51', district: '51', name: 'Lulu Flores', email: 'lulu.flores@house.texas.gov', phone: '(512) 463-0660' },
                { id: '76', district: '76', name: 'Claudia Ordaz', email: 'claudia.ordaz@house.texas.gov', phone: '(512) 463-0638' },
                { id: '77', district: '77', name: 'Lina Ortega', email: 'lina.ortega@house.texas.gov', phone: '(512) 463-0638' },
                { id: '78', district: '78', name: 'Joe Moody', email: 'joe.moody@house.texas.gov', phone: '(512) 463-0728' },
                { id: '79', district: '79', name: 'Art Fierro', email: 'art.fierro@house.texas.gov', phone: '(512) 463-0596' },
                { id: '80', district: '80', name: 'Tracy King', email: 'tracy.king@house.texas.gov', phone: '(512) 463-0194' },
                { id: '90', district: '90', name: 'Ramon Romero Jr.', email: 'ramon.romero@house.texas.gov', phone: '(512) 463-0740' },
                { id: '92', district: '92', name: 'Salman Bhojani', email: 'salman.bhojani@house.texas.gov', phone: '(512) 463-0506' },
                { id: '95', district: '95', name: 'Nicole Collier', email: 'nicole.collier@house.texas.gov', phone: '(512) 463-0716' },
                { id: '100', district: '100', name: 'Venton Jones', email: 'venton.jones@house.texas.gov', phone: '(512) 463-0586' },
                { id: '103', district: '103', name: 'Rafael Anchía', email: 'rafael.ancha@house.texas.gov', phone: '(512) 463-0746' },
                { id: '104', district: '104', name: 'Jessica González', email: 'jessica.gonzalez@house.texas.gov', phone: '(512) 463-0408' },
                { id: '105', district: '105', name: 'Terry Meza', email: 'terry.meza@house.texas.gov', phone: '(512) 463-0641' },
                { id: '107', district: '107', name: 'Victoria Neave Criado', email: 'victoria.neave@house.texas.gov', phone: '(512) 463-0244' },
                { id: '116', district: '116', name: 'Trey Martinez Fischer', email: 'trey.martinezfischer@house.texas.gov', phone: '(512) 463-0616' },
                { id: '117', district: '117', name: 'Philip Cortez', email: 'philip.cortez@house.texas.gov', phone: '(512) 463-0269' },
                { id: '118', district: '118', name: 'John Lujan', email: 'john.lujan@house.texas.gov', phone: '(512) 463-0122' },
                { id: '123', district: '123', name: 'Diego Bernal', email: 'diego.bernal@house.texas.gov', phone: '(512) 463-0532' },
                { id: '124', district: '124', name: 'Josey Garcia', email: 'josey.garcia@house.texas.gov', phone: '(512) 463-0646' },
                { id: '125', district: '125', name: 'Ray Lopez', email: 'ray.lopez@house.texas.gov', phone: '(512) 463-0669' }
            ];
            let representatives = [];
            let userFullName = '';
            let userLocation = '';

            // DOM Element References
            const tableBody = document.getElementById('repsTable').getElementsByTagName('tbody')[0];
            const exportButton = document.getElementById('exportData');
            const importFile = document.getElementById('importFile');
            const resetButton = document.getElementById('resetData');
            const saveAllButton = document.getElementById('saveAllChanges');
            const editMyInfoButton = document.getElementById('editMyInfo');
            const showGuideButton = document.getElementById('showGuideBtn');
            
            const emailSubjectTemplateInput = document.getElementById('emailSubjectTemplate');
            const emailBodyTemplateInput = document.getElementById('emailBodyTemplate');

            const onboardingModal = document.getElementById('onboardingModal');
            const closeOnboardingModalBtn = document.getElementById('closeOnboardingModal');
            const onboardingUserNameInput = document.getElementById('onboardingUserName');
            const onboardingUserLocationInput = document.getElementById('onboardingUserLocation');
            const saveOnboardingInfoBtn = document.getElementById('saveOnboardingInfo');

            const responseModal = document.getElementById('responseModal');
            const closeResponseModalBtn = document.getElementById('closeResponseModal');
            const responseModalTitle = document.getElementById('responseModalTitle');
            const currentRepIdForModalInput = document.getElementById('currentRepIdForModal');
            const modalResponseSelect = document.getElementById('modalResponseSelect');
            const modalNotesTextarea = document.getElementById('modalNotesTextarea');
            const saveResponseModalBtn = document.getElementById('saveResponseModal');
            const cancelResponseModalBtn = document.getElementById('cancelResponseModal');

            const guideModal = document.getElementById('guideModal');
            const closeGuideModalBtn = document.getElementById('closeGuideModal');
            const dismissGuideModalBtn = document.getElementById('dismissGuideModal');

            // Default Email Content
            const defaultEmailSubject = "Regarding CSSB 3 & SB 3 - A Message from a Constituent";
            const defaultEmailBody = `Dear {RepName},

I’m writing as a concerned constituent to urge you to oppose CSSB 3 and SB 3. While SB 3 represents a near-total ban on hemp-derived THC products, CSSB 3 is being framed as a compromise — but in reality, it imposes restrictions so severe that it would still dismantle the industry.

These bills are a clear example of government overreach. They threaten more than 50,000 Texas jobs, risk over $8 billion in annual economic impact, and would eliminate access to wellness products that millions of Texans rely on.

This is not conservative policy — it’s a rollback of personal freedom and economic opportunity. Hemp-derived products are already legal and regulated under both federal and Texas law, with existing safety and testing requirements in place. Texans, including veterans, parents, and people managing chronic pain, use these products responsibly.

Driving them to unregulated, illegal markets will only increase public health risks.

If the true goal is to protect minors, I support responsible regulation — not prohibition. Reasonable safeguards could include:

* Restricting sales to adults age 21 and older
* Requiring child-resistant packaging
* Establishing retail buffer zones around schools

Every $1 spent on hemp generates $2.80 for the local economy. This industry supports Texas farmers, retailers, processors, and thousands of small business owners.

Thank you,
{UserName}
{UserLocation}`;

            // --- User Info & Onboarding ---
            function loadUserInfo() {
                userFullName = localStorage.getItem('userFullName') || '';
                userLocation = localStorage.getItem('userLocation') || '';
                const onboardingComplete = localStorage.getItem('onboardingComplete') === 'true';

                if (!onboardingComplete) {
                    onboardingModal.style.display = 'block';
                }
                onboardingUserNameInput.value = userFullName;
                onboardingUserLocationInput.value = userLocation;
            }

            closeOnboardingModalBtn.onclick = () => onboardingModal.style.display = 'none';
            editMyInfoButton.onclick = () => {
                onboardingUserNameInput.value = userFullName; 
                onboardingUserLocationInput.value = userLocation;
                onboardingModal.style.display = 'block';
            }

            saveOnboardingInfoBtn.onclick = function() {
                userFullName = onboardingUserNameInput.value.trim();
                userLocation = onboardingUserLocationInput.value.trim();

                if (userFullName) { 
                    localStorage.setItem('userFullName', userFullName);
                    localStorage.setItem('userLocation', userLocation);
                    localStorage.setItem('onboardingComplete', 'true');
                    onboardingModal.style.display = 'none';
                    alert('Your information has been saved.');
                } else {
                    alert('Please enter your full name.');
                }
            }

            // --- Data Persistence (Local Storage) ---
            function loadDataFromLocalStorage() {
                loadUserInfo(); // Load user details first

                const storedData = localStorage.getItem('representativesCallData');
                if (storedData) {
                    const parsedStoredData = JSON.parse(storedData);
                    // Merge initial data with stored data, ensuring all reps are present
                    // and new properties like 'emailed' are added if missing from old storage
                    representatives = initialRepresentativesData.map(initialRep => {
                        const storedRep = parsedStoredData.find(s => s.id === initialRep.id);
                        return {
                            ...initialRep, // Start with defaults from initialRepresentativesData
                            called: false, // Default called status
                            emailed: false, // Default emailed status
                            response: 'not_selected', // Default response
                            notes: '', // Default notes
                            ...(storedRep || {}) // Override with stored values if they exist
                        };
                    });
                } else {
                    // If no stored data, initialize from initialRepresentativesData with tracking fields
                    representatives = initialRepresentativesData.map(rep => ({
                        ...rep,
                        called: false,
                        emailed: false, 
                        response: 'not_selected',
                        notes: ''
                    }));
                }
                emailSubjectTemplateInput.value = localStorage.getItem('emailSubjectTemplate') || defaultEmailSubject;
                emailBodyTemplateInput.value = localStorage.getItem('emailBodyTemplate') || defaultEmailBody;
            }

            function saveDataToLocalStorage() {
                localStorage.setItem('representativesCallData', JSON.stringify(representatives));
                localStorage.setItem('emailSubjectTemplate', emailSubjectTemplateInput.value);
                localStorage.setItem('emailBodyTemplate', emailBodyTemplateInput.value);
                // User info is saved separately by its own functions
                console.log("Data saved to local storage.");
            }
            
            // --- UI Rendering & Event Handlers ---
            const responseOptions = ['', 'For', 'Against', 'Not Advised/Neutral', 'No Stance Yet', 'Left Voicemail', 'Other'];
            responseOptions.forEach(val => {
                const option = document.createElement('option');
                option.value = val.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/^$/, 'not_selected');
                option.textContent = val || 'Select Response...';
                modalResponseSelect.appendChild(option);
            });

            function renderTable() {
                tableBody.innerHTML = ''; 
                representatives.forEach((rep) => {
                    const row = tableBody.insertRow();
                    row.setAttribute('data-id', rep.id);

                    // Called Checkbox
                    const cellCalled = row.insertCell();
                    const calledCheckbox = document.createElement('input');
                    calledCheckbox.type = 'checkbox';
                    calledCheckbox.checked = rep.called;
                    calledCheckbox.dataset.repId = rep.id;
                    calledCheckbox.addEventListener('change', handleCalledChange);
                    cellCalled.appendChild(calledCheckbox);

                    // Emailed Checkbox
                    const cellEmailed = row.insertCell();
                    const emailedCheckbox = document.createElement('input');
                    emailedCheckbox.type = 'checkbox';
                    emailedCheckbox.checked = rep.emailed;
                    emailedCheckbox.dataset.repId = rep.id;
                    emailedCheckbox.addEventListener('change', handleEmailedChange);
                    cellEmailed.appendChild(emailedCheckbox);

                    // District, Name
                    row.insertCell().textContent = rep.district;
                    row.insertCell().textContent = rep.name;
                    
                    // Email Link
                    const cellEmail = row.insertCell();
                    const emailLink = document.createElement('a');
                    emailLink.href = "#"; 
                    emailLink.textContent = rep.email;
                    emailLink.dataset.email = rep.email;
                    emailLink.dataset.repName = rep.name;
                    emailLink.dataset.repId = rep.id; 
                    emailLink.classList.add('email-link');
                    emailLink.addEventListener('click', handleEmailClick);
                    cellEmail.appendChild(emailLink);

                    // Phone Link
                    const cellPhone = row.insertCell();
                    const phoneLink = document.createElement('a');
                    phoneLink.href = `tel:${rep.phone.replace(/\D/g, '')}`;
                    phoneLink.textContent = rep.phone;
                    cellPhone.appendChild(phoneLink);

                    // Response Summary Cell
                    const cellResponseSummary = row.insertCell();
                    cellResponseSummary.classList.add('response-summary-cell');
                    updateResponseSummaryCell(cellResponseSummary, rep);
                });
            }

            function updateResponseSummaryCell(cell, rep) {
                if (rep.called) { 
                    let summaryText = 'N/A';
                    const selectedOptionText = responseOptions.find(opt => opt.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/^$/, 'not_selected') === rep.response);
                    summaryText = selectedOptionText || (rep.response !== 'not_selected' ? rep.response.replace(/_/g, ' ') : 'No response logged');
                    
                    let summary = `Response: ${summaryText}`;
                    if (rep.notes) {
                        summary += `<br>Notes: ${rep.notes.substring(0, 35)}${rep.notes.length > 35 ? '...' : ''}`;
                    }
                    cell.innerHTML = summary;
                } else {
                    cell.innerHTML = '<i>Not called yet</i>';
                }
            }

            function handleCalledChange(event) {
                const repId = event.target.dataset.repId;
                const repIndex = representatives.findIndex(r => r.id === repId);
                if (repIndex === -1) return;

                const rep = representatives[repIndex];
                const isChecked = event.target.checked;
                rep.called = isChecked;

                const row = document.querySelector(`tr[data-id="${repId}"]`);
                const summaryCell = row ? row.cells[row.cells.length -1] : null; 

                if (isChecked) { // If "Called" is checked, show response modal
                    currentRepIdForModalInput.value = rep.id;
                    responseModalTitle.textContent = `Log Response: ${rep.name}`;
                    modalResponseSelect.value = rep.response || 'not_selected';
                    modalNotesTextarea.value = rep.notes || '';
                    responseModal.style.display = 'block';
                } else { // If "Called" is unchecked, clear response and notes
                    rep.response = 'not_selected';
                    rep.notes = '';
                    if (summaryCell) updateResponseSummaryCell(summaryCell, rep);
                }
                saveDataToLocalStorage();
            }

            function handleEmailedChange(event) {
                const repId = event.target.dataset.repId;
                const repIndex = representatives.findIndex(r => r.id === repId);
                if (repIndex === -1) return;

                representatives[repIndex].emailed = event.target.checked;
                saveDataToLocalStorage();
            }
            
            function handleEmailClick(event) {
                console.log("handleEmailClick triggered.");
                event.preventDefault(); 

                const targetLink = event.currentTarget; 
                const recipientEmail = targetLink.dataset.email;
                const repName = targetLink.dataset.repName;
                const repId = targetLink.dataset.repId; 

                console.log("Recipient Email:", recipientEmail, "Representative Name:", repName, "Rep ID:", repId);

                if (!recipientEmail) { 
                    console.error("CRITICAL: Could not get recipient's email from data attributes.");
                    alert("Error: Could not get representative's email.");
                    return;
                }

                if (!emailSubjectTemplateInput || !emailBodyTemplateInput) {
                    console.error("CRITICAL: Email template input fields not found.");
                    alert("Error: Email template fields missing.");
                    return;
                }

                let subject = emailSubjectTemplateInput.value;
                let body = emailBodyTemplateInput.value;
                
                if (typeof subject !== 'string') subject = "";
                if (typeof body !== 'string') body = "";
                
                const repNameStr = repName || ""; 
                const userNameStr = userFullName || "[Your Name]";
                const userLocationStr = userLocation || "[Your Location]";

                try {
                    subject = subject.replace(/{RepName}/g, repNameStr)
                                   .replace(/{UserName}/g, userNameStr)
                                   .replace(/{UserLocation}/g, userLocationStr);
                    body = body.replace(/{RepName}/g, repNameStr)
                               .replace(/{UserName}/g, userNameStr)
                               .replace(/{UserLocation}/g, userLocationStr);
                } catch (e) {
                    console.error("Error during placeholder replacement:", e);
                    alert("Error preparing email template.");
                    return;
                }
                
                const mailtoLink = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                console.log("Final mailtoLink:", mailtoLink);
                
                try {
                    window.location.href = mailtoLink; // Attempt to open email client
                    // If successful and repId is valid, mark as emailed
                    if (repId) {
                        const repIndex = representatives.findIndex(r => r.id === repId);
                        if (repIndex !== -1 && !representatives[repIndex].emailed) {
                            representatives[repIndex].emailed = true;
                            const emailedCheckboxInRow = document.querySelector(`tr[data-id="${repId}"] td:nth-child(2) input[type="checkbox"]`);
                            if (emailedCheckboxInRow) {
                                emailedCheckboxInRow.checked = true;
                            }
                            saveDataToLocalStorage(); // Save change immediately
                        }
                    }
                    console.log("Attempted to navigate to mailto link. Marked as emailed if successful and ID found.");
                } catch (e) {
                    console.error("Error trying to open mailto link:", e);
                    alert("Could not open email client.");
                }
            }

            // --- Modal Control ---
            closeResponseModalBtn.onclick = () => responseModal.style.display = 'none';
            cancelResponseModalBtn.onclick = () => responseModal.style.display = 'none';

            saveResponseModalBtn.onclick = function() {
                const repId = currentRepIdForModalInput.value;
                if (!repId) return;
                const repIndex = representatives.findIndex(r => r.id === repId);
                if (repIndex === -1) return;

                representatives[repIndex].response = modalResponseSelect.value;
                representatives[repIndex].notes = modalNotesTextarea.value;
                
                const row = document.querySelector(`tr[data-id="${repId}"]`);
                if (row) {
                    const summaryCell = row.cells[row.cells.length -1]; 
                    updateResponseSummaryCell(summaryCell, representatives[repIndex]);
                }
                responseModal.style.display = 'none';
                saveDataToLocalStorage();
            };
            
            showGuideButton.onclick = () => guideModal.style.display = 'block';
            closeGuideModalBtn.onclick = () => guideModal.style.display = 'none';
            dismissGuideModalBtn.onclick = () => guideModal.style.display = 'none';

            // Close modals if clicking outside their content
            window.onclick = function(event) {
                if (event.target == responseModal) responseModal.style.display = 'none';
                if (event.target == onboardingModal) onboardingModal.style.display = 'none';
                if (event.target == guideModal) guideModal.style.display = 'none';
            }

            // --- Data Management Buttons ---
            exportButton.addEventListener('click', () => {
                saveDataToLocalStorage(); // Ensure latest data is captured
                const dataStr = JSON.stringify({
                    representatives: representatives,
                    emailSubject: emailSubjectTemplateInput.value,
                    emailBody: emailBodyTemplateInput.value,
                    userFullName: userFullName,
                    userLocation: userLocation,
                    onboardingComplete: localStorage.getItem('onboardingComplete') === 'true'
                }, null, 2); // null, 2 for pretty printing JSON
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'sb3_call_tracker_progress.json';
                
                let linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                linkElement.remove();
            });

            importFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (importedData.representatives && Array.isArray(importedData.representatives)) {
                                // Merge imported data, prioritizing the structure from initialRepresentativesData
                                // but taking values from importedData
                                representatives = initialRepresentativesData.map(initialRep => {
                                    const importedRepData = importedData.representatives.find(ir => ir.id === initialRep.id);
                                    return {
                                        ...initialRep, // Base structure and contact info
                                        called: importedRepData?.called || false,
                                        emailed: importedRepData?.emailed || false,
                                        response: importedRepData?.response || 'not_selected',
                                        notes: importedRepData?.notes || ''
                                    };
                                });
                                
                                emailSubjectTemplateInput.value = importedData.emailSubject || defaultEmailSubject;
                                emailBodyTemplateInput.value = importedData.emailBody || defaultEmailBody;
                                userFullName = importedData.userFullName || '';
                                userLocation = importedData.userLocation || '';
                                onboardingUserNameInput.value = userFullName; 
                                onboardingUserLocationInput.value = userLocation;
                                localStorage.setItem('userFullName', userFullName);
                                localStorage.setItem('userLocation', userLocation);
                                if(importedData.onboardingComplete !== undefined) { // Check for undefined explicitly
                                   localStorage.setItem('onboardingComplete', importedData.onboardingComplete.toString());
                                }
                                saveDataToLocalStorage(); 
                                renderTable(); 
                                alert('Progress imported successfully!');
                            } else {
                                alert('Error: Invalid file format. Ensure it contains a "representatives" array.');
                            }
                        } catch (error) {
                            console.error('Error importing data:', error);
                            alert('Error importing file. It might be corrupted or not a valid JSON.');
                        }
                        importFile.value = ''; // Reset file input
                    };
                    reader.readAsText(file);
                }
            });
            
            resetButton.addEventListener('click', () => {
                if (confirm('Are you sure you want to reset all data? This includes your progress, notes, and personal info. This cannot be undone.')) {
                    localStorage.clear(); // Clears all local storage for this domain
                    // Re-initialize data and UI
                    loadDataFromLocalStorage(); // This will trigger onboarding if needed
                    renderTable();
                    alert('All data has been reset.');
                }
            });

            saveAllButton.addEventListener('click', () => {
                saveDataToLocalStorage(); // Primarily saves email template edits, other data is saved on interaction
                alert('All changes (including email templates) have been saved!');
            });

            // --- Initial Load ---
            loadDataFromLocalStorage(); 
            renderTable();
        });
    </script>
</body>
</html>