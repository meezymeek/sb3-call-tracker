<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SB3 Stakeholders Call Tracker</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    <style>
        :root {
            --dark-bg-primary: #1e1e1e;
            --dark-bg-secondary: #2c2c2c;
            --dark-bg-tertiary: #383838;
            --dark-text-primary: #e0e0e0;
            --dark-text-secondary: #b0b0b0;
            --accent-green: #4CAF50;
            --accent-green-darker: #388E3C;
            --border-color-dark: #444444;
            --utility-button-bg: #5a5a5a;
            --utility-button-hover-bg: #4a4a4a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 25px;
            background-color: var(--dark-bg-secondary);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--accent-green);
        }

        header h1 {
            color: var(--accent-green);
            margin: 0 0 5px 0;
            font-size: 2.2em;
        }
        .version-number {
            display: block;
            font-size: 0.8em;
            color: var(--dark-text-secondary);
            margin-bottom: 10px;
        }

        header p {
            color: var(--dark-text-secondary);
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .report-problem-link {
            font-size: 0.85em;
            color: var(--dark-text-secondary);
        }
        .report-problem-link a {
            color: var(--accent-green-darker);
        }
        .report-problem-link a:hover {
            color: var(--accent-green);
        }


        .controls, .email-template-section {
            margin-bottom: 25px;
            padding: 15px;
            background-color: var(--dark-bg-tertiary);
            border-radius: 6px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .email-template-section {
            flex-direction: column;
            align-items: flex-start;
        }

        .email-template-section label {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--dark-text-primary);
        }
        
        .email-template-section input[type="text"],
        .email-template-section textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color-dark);
            border-radius: 4px;
            font-size: 0.95em;
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }
        .email-template-section input[type="text"]:focus,
        .email-template-section textarea:focus {
            border-color: var(--accent-green);
            outline: none;
        }
        
        .email-template-section textarea {
            min-height: 120px; 
            resize: vertical;
        }
        .email-template-section small {
            color: var(--dark-text-secondary);
        }

        .controls button, .controls label.button-like {
            padding: 10px 15px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            flex-grow: 1; 
        }
        .controls button#exportData, 
        .controls label.button-like[for="importFile"] {
            background-color: var(--accent-green);
        }
        .controls button#exportData:hover, 
        .controls label.button-like[for="importFile"]:hover {
            background-color: var(--accent-green-darker);
        }

        .controls button#resetData,
        .controls button#editMyInfo,
        .controls button#showGuideBtn {
            background-color: var(--utility-button-bg);
        }
        .controls button#resetData:hover,
        .controls button#editMyInfo:hover,
        .controls button#showGuideBtn:hover {
            background-color: var(--utility-button-hover-bg);
        }
        
        .controls input[type="file"] {
            display: none;
        }

        .table-container {
            overflow-x: auto; 
            margin-bottom: 20px; 
        }

        table {
            width: 100%; 
            border-collapse: collapse;
            table-layout: fixed; 
        }

        th, td {
            padding: 12px 8px; 
            text-align: left;
            border-bottom: 1px solid var(--border-color-dark);
            vertical-align: middle;
            word-break: break-word; 
            overflow-wrap: break-word;
        }
        
        td a { 
            word-break: break-all;
            overflow-wrap: break-word; 
        }

        th {
            background-color: var(--accent-green);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        th:nth-child(1), td:nth-child(1) { width: 7%; }  /* Called */
        th:nth-child(2), td:nth-child(2) { width: 7%; }  /* Emailed */
        th:nth-child(3), td:nth-child(3) { width: 8%; }  /* District */
        th:nth-child(4), td:nth-child(4) { width: 18%; } /* Representative */
        th:nth-child(5), td:nth-child(5) { width: 7%; }  /* Party */
        th:nth-child(6), td:nth-child(6) { width: 20%; } /* Email */
        th:nth-child(7), td:nth-child(7) { width: 13%; } /* Phone */
        th:nth-child(8), td:nth-child(8) { width: 20%; } /* Response Summary */


        tr:nth-child(even) {
            background-color: var(--dark-bg-tertiary); 
        }

        tr:hover {
            background-color: #404040; 
        }

        input[type="checkbox"] {
            transform: scale(1.2); 
            margin-right: 3px; 
            cursor: pointer;
            vertical-align: middle;
        }
        
        a { 
            color: var(--accent-green);
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
            color: var(--accent-green-darker);
        }
        
        .footer-actions {
            margin-top: 30px;
            text-align: right;
            min-height: 40px; /* Ensure space even if button is removed */
        }
         .footer-actions button { 
            margin-left: 10px;
            background-color: var(--accent-green);
            color: white; 
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
         }
         .footer-actions button:hover {
            background-color: var(--accent-green-darker);
         }

        .response-summary-cell {
            font-size: 0.85em;
            color: var(--dark-text-secondary);
            line-height: 1.4;
        }
        .response-summary-cell i {
            color: #888;
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.7); 
            padding-top: 40px;
        }

        .modal-content {
            background-color: var(--dark-bg-secondary);
            margin: 5% auto; 
            padding: 25px;
            border: 1px solid var(--border-color-dark);
            width: 80%; 
            max-width: 600px; 
            border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.4),0 6px 20px 0 rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-content h2, .modal-content h3 {
            margin-top: 0;
            color: var(--accent-green);
        }
        .modal-content h4 { 
            color: var(--accent-green-darker);
            margin-top: 1.2em;
            margin-bottom: 0.5em;
        }

        .modal-content label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark-text-primary);
        }
        .modal-content input[type="text"], 
        .modal-content select, 
        .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color-dark);
            border-radius: 4px;
            font-size: 1em;
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }
        .modal-content input[type="text"]:focus, 
        .modal-content select:focus, 
        .modal-content textarea:focus {
            border-color: var(--accent-green);
            outline: none;
        }
        .modal-content select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e0e0e0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
            padding-right: 2em;
        }
        .modal-content textarea {
            min-height: 100px;
            resize: vertical;
        }
        .modal-content button { 
            background-color: var(--accent-green);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
            margin-right: 10px;
        }
        .modal-content button:hover {
            background-color: var(--accent-green-darker);
        }
        .modal-content button.button-outline { 
            background-color: transparent;
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }
        .modal-content button.button-outline:hover {
            background-color: rgba(76, 175, 80, 0.1); 
        }
        .modal-content ul {
            padding-left: 20px;
            margin-top: 0.5em;
        }
        .modal-content li {
            margin-bottom: 0.5em;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--dark-text-primary);
            text-decoration: none;
            cursor: pointer;
        }

        @media screen and (max-width: 768px) {
            .container { width: 98%; padding: 15px; margin-top: 10px; }
            header h1 { font-size: 1.6em; }
            header p { font-size: 0.95em; }
            .controls { flex-direction: row; }
            .controls button, .controls label.button-like { 
                width: auto; 
                flex-grow: 0; 
                margin-bottom: 5px; 
            }
            @media (max-width: 600px) { 
                .controls { flex-direction: column; }
                .controls button, .controls label.button-like { width: 100%; margin-bottom: 10px; }
            }

            th, td { padding: 8px 4px; font-size: 0.7em; } 
            th:nth-child(1), td:nth-child(1) { width: 8%; }
            th:nth-child(2), td:nth-child(2) { width: 8%; }
            th:nth-child(3), td:nth-child(3) { width: 8%; }
            th:nth-child(4), td:nth-child(4) { width: 18%; }
            th:nth-child(5), td:nth-child(5) { width: 7%; }
            th:nth-child(6), td:nth-child(6) { width: 13%; }
            th:nth-child(7), td:nth-child(7) { width: 20%; }
            th:nth-child(8), td:nth-child(8) { width: 18%; }

            .modal-content { width: 90%; margin: 10% auto; padding: 20px; }
        }
         @media screen and (max-width: 480px) {
            header h1 { font-size: 1.4em; }
            .version-number { font-size: 0.75em; }
            .report-problem-link { font-size: 0.8em; }

            th, td { padding: 6px 3px; font-size: 0.60em; } 

            th:nth-child(3), td:nth-child(3) { display: none; } 
            th:nth-child(5), td:nth-child(5) { display: none; } 
            th:nth-child(1), td:nth-child(1) { width: 10%; } 
            th:nth-child(2), td:nth-child(2) { width: 10%; } 
            th:nth-child(4), td:nth-child(4) { width: 25%; } 
            th:nth-child(6), td:nth-child(6) { width: 15%; } 
            th:nth-child(7), td:nth-child(7) { width: 20%; } 
            th:nth-child(8), td:nth-child(8) { width: 20%; } 
         }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SB3 Stakeholders Call Tracker</h1>
            <span class="version-number">v1.1 (Firebase Beta)</span>
            <p>Track your calls and emails to representatives, their responses, and your notes. Progress is saved automatically to your device and backed up to a secure cloud database.</p>
            <div class="report-problem-link">
                <a href="mailto:hayden@delta8denton.com?subject=Problem Report - SB3 Call Tracker v1.1">Report Problems</a>
            </div>
        </header>

        <div class="controls">
            <button id="showGuideBtn">User Guide</button> 
            <button id="exportData">Export Progress</button>
            <label for="importFile" class="button-like">Import Progress</label>
            <input type="file" id="importFile" accept=".json">
            <button id="editMyInfo">Edit My Info</button>
            <button id="resetData">Reset All Data</button>
        </div>

        <div class="email-template-section">
            <label for="emailSubjectTemplate">Email Subject Template:</label>
            <input type="text" id="emailSubjectTemplate">
            
            <label for="emailBodyTemplate" style="margin-top:10px;">Email Body Template:</label>
            <textarea id="emailBodyTemplate"></textarea>
            <small><em>Placeholders: {RepName}, {UserName}, {UserLocation}. Click an email in the table to use this template. Changes save automatically.</em></small>
        </div>

        <h2 style="text-align: center; margin-top: 40px; color: var(--accent-green);">YAE Dems List</h2>
        <div class="table-container">
            <table id="repsTableYaeDems">
                <thead>
                    <tr>
                        <th>Called</th>
                        <th>Emailed</th>
                        <th>District</th>
                        <th>Representative</th>
                        <th>Party</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Response Summary</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <h2 style="text-align: center; margin-top: 40px; color: var(--accent-green);">Potential Flips</h2>
        <div class="table-container">
            <table id="repsTableChairFlips">
                <thead>
                    <tr>
                        <th>Called</th>
                        <th>Emailed</th>
                        <th>District</th>
                        <th>Representative</th>
                        <th>Party</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Response Summary</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <h2 style="text-align: center; margin-top: 40px; color: var(--accent-green);">NAY Voters</h2>
        <div class="table-container">
            <table id="repsTableNayVoters">
                <thead>
                    <tr>
                        <th>Called</th>
                        <th>Emailed</th>
                        <th>District</th>
                        <th>Representative</th>
                        <th>Party</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Response Summary</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

         <div class="footer-actions">
            <!-- Save All Changes button removed due to auto-save implementation -->
        </div>
    </div>

    <div id="onboardingModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeOnboardingModal">×</span>
            <h2>Welcome! Let's Get You Set Up</h2>
            <p>Please provide a few details to personalize your email templates. This information is stored locally in your browser and backed up.</p>
            <label for="onboardingUserName">Your Full Name (for email signature):</label>
            <input type="text" id="onboardingUserName" placeholder="e.g., Jane Doe">
            <label for="onboardingUserLocation">Your City/Town (e.g., "Austin resident"):</label>
            <input type="text" id="onboardingUserLocation" placeholder="e.g., Austin, TX or concerned Texan">
            <button id="saveOnboardingInfo">Save and Continue</button>
        </div>
    </div>

    <div id="responseModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeResponseModal">×</span>
            <h3 id="responseModalTitle">Log Call Response</h3>
            <input type="hidden" id="currentRepIdForModal">
            <input type="hidden" id="currentListIdentifierForModal">
            <label for="modalResponseSelect">Response:</label>
            <select id="modalResponseSelect"></select>
            <label for="modalNotesTextarea">Notes (e.g., staffer name, key points discussed):</label>
            <textarea id="modalNotesTextarea" placeholder="Enter notes here..."></textarea>
            <button id="saveResponseModal">Save Response</button>
            <button id="cancelResponseModal" class="button-outline">Cancel</button>
        </div>
    </div>

    <div id="guideModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeGuideModal">×</span>
            <h2>SB3 Call Tracker - Easy Mobile Guide (v1.1 - Firebase Beta)</h2>
            <p>This tool helps you contact lawmakers. Your progress is saved automatically to this device and backed up to a secure cloud database (Firebase) linked to this device only.</p>
            <h4>1. First Time Opening? (Quick Setup):</h4>
            <ul>
                <li>A "Welcome" box will pop up.</li>
                <li>Type in your <strong>Full Name</strong> and <strong>City/Town</strong>.</li>
                <li>Tap "Save and Continue." This info is saved to your device and backed up.</li>
                <li><em>Need to change it later? Tap "Edit My Info."</em></li>
            </ul>
            <h4>2. Sending Emails:</h4>
            <ul>
                <li>Email templates are provided. You can edit them on the main screen.</li>
                <li>Changes to templates are saved automatically.</li>
            </ul>
            <h4>3. Contacting Lawmakers:</h4>
            <ul>
                <li><strong>To Call:</strong> Tap the phone number. After, check "Called." A box appears to log the response and notes. Tap "Save Response."</li>
                <li><strong>To Email:</strong> Tap the email address. Your email app opens. After sending, the "Emailed" box is checked automatically.</li>
                <li>All these actions are saved automatically.</li>
            </ul>
            <h4>4. Your Progress:</h4>
            <ul>
                <li><strong>Auto-Save:</strong> All changes (checkboxes, notes, templates, user info) are saved automatically to your device and backed up. The "Save All Changes" button has been removed.</li>
                <li><strong>Export/Import:</strong> Still available for manual backups or transferring to a *new* device if needed (though Firebase aims to make this less necessary for the same device).</li>
                <li><strong>Reset All Data:</strong> Clears data from *this device's local storage and its Firebase backup*. Use with caution!</li>
            </ul>
            <button id="dismissGuideModal" class="button-outline" style="margin-top: 20px;">Dismiss</button>
        </div>
    </div>

    <script>
        // Global error handler
        window.onerror = function(message, source, lineno, colno, error) {
            const errorDetails = `CRITICAL SCRIPT ERROR:\nMessage: ${message}\nSource: ${source}\nLine: ${lineno}\nColumn: ${colno}\nError: ${error ? JSON.stringify(error) : 'N/A'}`;
            alert(errorDetails);
            console.error("GLOBAL ERROR:", message, source, lineno, colno, error);
            return true; 
        };

        try { 
            document.addEventListener('DOMContentLoaded', function() {
                console.log("DOMContentLoaded event fired.");

                // Firebase Configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyAm-QMDte5ytPN7Z8Cz7VaDe7hUVGsTE-8",
                    authDomain: "sb3calltool.firebaseapp.com",
                    projectId: "sb3calltool",
                    storageBucket: "sb3calltool.firebasestorage.app", // Corrected from .app
                    messagingSenderId: "834566220861",
                    appId: "1:834566220861:web:6475e1ddf50c00e54b0e54",
                    measurementId: "G-BC4Z144B00",
                    databaseURL: "https://sb3calltool-default-rtdb.firebaseio.com" // Added databaseURL
                };

                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                firebase.analytics(); // Initialize Analytics
                const auth = firebase.auth();
                const db = firebase.database();
                let currentUser = null;
                let deviceId = localStorage.getItem('sb3CallToolDeviceId');

                if (!deviceId) {
                    deviceId = 'device-' + Math.random().toString(36).substr(2, 16) + Date.now().toString(36);
                    localStorage.setItem('sb3CallToolDeviceId', deviceId);
                }
                
                let initialYaeDemsData = [];
                let representativesYaeDems = [];
                let initialChairFlipsData = [];
                let representativesChairFlips = [];
                let initialNayVotersData = [];
                let representativesNayVoters = [];
                
                let userFullName = '';    
                let userLocation = '';

                const yaeDemsTableBody = document.getElementById('repsTableYaeDems').getElementsByTagName('tbody')[0];
                const chairFlipsTableBody = document.getElementById('repsTableChairFlips').getElementsByTagName('tbody')[0];
                const nayVotersTableBody = document.getElementById('repsTableNayVoters').getElementsByTagName('tbody')[0];
                const exportButton = document.getElementById('exportData');
                const importFile = document.getElementById('importFile');
                const resetButton = document.getElementById('resetData');
                const editMyInfoButton = document.getElementById('editMyInfo');
                const showGuideButton = document.getElementById('showGuideBtn');
                
                const emailSubjectTemplateInput = document.getElementById('emailSubjectTemplate');
                const emailBodyTemplateInput = document.getElementById('emailBodyTemplate');

                const onboardingModal = document.getElementById('onboardingModal');
                const closeOnboardingModalBtn = document.getElementById('closeOnboardingModal');
                const onboardingUserNameInput = document.getElementById('onboardingUserName');
                const onboardingUserLocationInput = document.getElementById('onboardingUserLocation');
                const saveOnboardingInfoBtn = document.getElementById('saveOnboardingInfo');

                const responseModal = document.getElementById('responseModal');
                const closeResponseModalBtn = document.getElementById('closeResponseModal');
                const responseModalTitle = document.getElementById('responseModalTitle');
                const currentRepIdForModalInput = document.getElementById('currentRepIdForModal');
                const currentListIdentifierForModalInput = document.getElementById('currentListIdentifierForModal');
                const modalResponseSelect = document.getElementById('modalResponseSelect');
                const modalNotesTextarea = document.getElementById('modalNotesTextarea');
                const saveResponseModalBtn = document.getElementById('saveResponseModal');
                const cancelResponseModalBtn = document.getElementById('cancelResponseModal');

                const guideModal = document.getElementById('guideModal');
                const closeGuideModalBtn = document.getElementById('closeGuideModal');
                const dismissGuideModalBtn = document.getElementById('dismissGuideModal');

                const defaultEmailSubject = "Regarding CSSB 3 & SB 3 - A Message from a Constituent";
                const defaultEmailBody = `Dear {RepName},\n\nI’m writing as a concerned constituent to urge you to oppose CSSB 3 and SB 3. While SB 3 represents a near-total ban on hemp-derived THC products, CSSB 3 is being framed as a compromise — but in reality, it imposes restrictions so severe that it would still dismantle the industry.\n\nThese bills are a clear example of government overreach. They threaten more than 50,000 Texas jobs, risk over $8 billion in annual economic impact, and would eliminate access to wellness products that millions of Texans rely on.\n\nThis is not conservative policy — it’s a rollback of personal freedom and economic opportunity. Hemp-derived products are already legal and regulated under both federal and Texas law, with existing safety and testing requirements in place. Texans, including veterans, parents, and people managing chronic pain, use these products responsibly.\n\nDriving them to unregulated, illegal markets will only increase public health risks.\n\nIf the true goal is to protect minors, I support responsible regulation — not prohibition. Reasonable safeguards could include:\n\n* Restricting sales to adults age 21 and older\n* Requiring child-resistant packaging\n* Establishing retail buffer zones around schools\n\nEvery $1 spent on hemp generates $2.80 for the local economy. This industry supports Texas farmers, retailers, processors, and thousands of small business owners.\n\nThank you,\n{UserName}\n{UserLocation}`;

                function loadUserInfoFromLocal() { // Renamed to avoid conflict
                    userFullName = localStorage.getItem('userFullName') || '';
                    userLocation = localStorage.getItem('userLocation') || '';
                    const onboardingComplete = localStorage.getItem('onboardingComplete') === 'true';
                    // Show onboarding if not complete, regardless of Firebase auth state for this specific modal.
                    // Firebase auth will handle data sync once info is entered.
                    if (!onboardingComplete) { 
                         onboardingModal.style.display = 'block';
                    }
                    onboardingUserNameInput.value = userFullName;
                    onboardingUserLocationInput.value = userLocation;
                }
                
                saveOnboardingInfoBtn.onclick = function() {
                    userFullName = onboardingUserNameInput.value.trim();
                    userLocation = onboardingUserLocationInput.value.trim();
                    if (userFullName) { 
                        localStorage.setItem('userFullName', userFullName);
                        localStorage.setItem('userLocation', userLocation);
                        localStorage.setItem('onboardingComplete', 'true');
                        onboardingModal.style.display = 'none';
                        alert('Your information has been saved.');
                        saveDataToAllStorages(); 
                    } else {
                        alert('Please enter your full name for email personalization.');
                    }
                };
                
                async function fetchAndProcessData(filePath, listIdentifier) {
                    try {
                        const response = await fetch(filePath);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${filePath}`);
                        const jsonData = await response.json();
                        return jsonData.map((rep, index) => ({
                            id: `${listIdentifier}-${index}-${rep.district}`, 
                            district: rep.district,
                            name: rep.representative_name,
                            phone: rep.phone_number,
                            party: rep.party,
                            email: rep.email,
                            list: listIdentifier 
                        }));
                    } catch (error) {
                        console.error(`Error fetching initial data for ${listIdentifier}:`, error);
                        alert(`Error loading data from ${filePath}.`);
                        return [];
                    }
                }

                async function loadDataFromAllSources() {
                    loadUserInfoFromLocal(); // Load user info from local first
                    emailSubjectTemplateInput.value = localStorage.getItem('emailSubjectTemplate') || defaultEmailSubject;
                    emailBodyTemplateInput.value = localStorage.getItem('emailBodyTemplate') || defaultEmailBody;

                    if (currentUser) {
                        const userDeviceRef = db.ref(`devices/${deviceId}/latest`);
                        try {
                            const snapshot = await userDeviceRef.once('value');
                            const firebaseData = snapshot.val();
                            if (firebaseData) {
                                console.log("Loading data from Firebase for device:", deviceId);
                                representativesYaeDems = firebaseData.representativesYaeDems || initialYaeDemsData.map(rep => ({ ...rep, called: false, emailed: false, response: 'not_selected', notes: '' }));
                                representativesChairFlips = firebaseData.representativesChairFlips || initialChairFlipsData.map(rep => ({ ...rep, called: false, emailed: false, response: 'not_selected', notes: '' }));
                                representativesNayVoters = firebaseData.representativesNayVoters || initialNayVotersData.map(rep => ({ ...rep, called: false, emailed: false, response: 'not_selected', notes: '' }));
                                emailSubjectTemplateInput.value = firebaseData.emailSubject || defaultEmailSubject;
                                emailBodyTemplateInput.value = firebaseData.emailBody || defaultEmailBody;
                                userFullName = firebaseData.userFullName || userFullName; // Prioritize Firebase if exists
                                userLocation = firebaseData.userLocation || userLocation;
                                onboardingUserNameInput.value = userFullName;
                                onboardingUserLocationInput.value = userLocation;
                                localStorage.setItem('userFullName', userFullName); // Sync local
                                localStorage.setItem('userLocation', userLocation);
                                localStorage.setItem('emailSubjectTemplate', emailSubjectTemplateInput.value);
                                localStorage.setItem('emailBodyTemplate', emailBodyTemplateInput.value);
                                return; // Data loaded from Firebase, skip local list processing
                            }
                        } catch (error) {
                            console.error("Error loading data from Firebase:", error);
                        }
                    }
                    
                    // Fallback to local storage if no Firebase data or not signed in
                    console.log("Loading data from Local Storage.");
                    const processStoredList = (storageKey, initialData) => {
                        const storedData = localStorage.getItem(storageKey);
                        if (storedData && initialData.length > 0) {
                            const parsedStoredData = JSON.parse(storedData);
                            return initialData.map(initialRep => {
                                const storedRepData = parsedStoredData.find(s => s.id === initialRep.id);
                                return { ...initialRep, called: storedRepData?.called || false, emailed: storedRepData?.emailed || false, response: storedRepData?.response || 'not_selected', notes: storedRepData?.notes || '' };
                            });
                        } else if (initialData.length > 0) {
                            return initialData.map(rep => ({ ...rep, called: false, emailed: false, response: 'not_selected', notes: '' }));
                        }
                        return [];
                    };
                    representativesYaeDems = processStoredList('representativesYaeDemsCallData', initialYaeDemsData);
                    representativesChairFlips = processStoredList('representativesChairFlipsCallData', initialChairFlipsData);
                    representativesNayVoters = processStoredList('representativesNayVotersCallData', initialNayVotersData);
                }

                function saveDataToAllStorages() {
                    // Save to Local Storage (as primary quick access)
                    try {
                        localStorage.setItem('representativesYaeDemsCallData', JSON.stringify(representativesYaeDems));
                        localStorage.setItem('representativesChairFlipsCallData', JSON.stringify(representativesChairFlips));
                        localStorage.setItem('representativesNayVotersCallData', JSON.stringify(representativesNayVoters));
                        localStorage.setItem('emailSubjectTemplate', emailSubjectTemplateInput.value);
                        localStorage.setItem('emailBodyTemplate', emailBodyTemplateInput.value);
                        localStorage.setItem('userFullName', userFullName);
                        localStorage.setItem('userLocation', userLocation);
                        console.log("Data saved to Local Storage.");
                    } catch (e) {
                        console.error("Error saving data to localStorage:", e);
                    }

                    // Save to Firebase
                    if (currentUser && deviceId) {
                        const dataToSave = {
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            representativesYaeDems: representativesYaeDems,
                            representativesChairFlips: representativesChairFlips,
                            representativesNayVoters: representativesNayVoters,
                            emailSubject: emailSubjectTemplateInput.value,
                            emailBody: emailBodyTemplateInput.value,
                            userFullName: userFullName,
                            userLocation: userLocation
                        };
                        // Save to a 'latest' node and also push to a historical log
                        db.ref(`devices/${deviceId}/latest`).set(dataToSave)
                            .then(() => console.log("Data saved to Firebase (latest)."))
                            .catch(error => console.error("Error saving 'latest' data to Firebase:", error));
                        
                        db.ref(`devices/${deviceId}/history`).push(dataToSave)
                            .then(() => console.log("Data pushed to Firebase history."))
                            .catch(error => console.error("Error pushing data to Firebase history:", error));
                    }
                }
                
                const responseOptions = ['', 'For', 'Against', 'Not Advised/Neutral', 'No Stance Yet', 'Left Voicemail', 'Other'];
                responseOptions.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/^$/, 'not_selected');
                    option.textContent = val || 'Select Response...';
                    modalResponseSelect.appendChild(option);
                });

                function renderTable(tableBodyElement, dataArray, listIdentifier) {
                    if (!tableBodyElement) {
                        console.error(`Table body for ${listIdentifier} not found!`);
                        return;
                    }
                    tableBodyElement.innerHTML = ''; 
                    dataArray.forEach((rep) => {
                        const row = tableBodyElement.insertRow();
                        row.setAttribute('data-id', rep.id);
                        row.setAttribute('data-list', listIdentifier);
                        const cellCalled = row.insertCell();
                        const calledCheckbox = document.createElement('input');
                        calledCheckbox.type = 'checkbox';
                        calledCheckbox.checked = !!rep.called;
                        calledCheckbox.dataset.repId = rep.id;
                        calledCheckbox.dataset.list = listIdentifier;
                        calledCheckbox.addEventListener('change', handleCalledChange);
                        cellCalled.appendChild(calledCheckbox);
                        const cellEmailed = row.insertCell();
                        const emailedCheckbox = document.createElement('input');
                        emailedCheckbox.type = 'checkbox';
                        emailedCheckbox.checked = !!rep.emailed;
                        emailedCheckbox.dataset.repId = rep.id;
                        emailedCheckbox.dataset.list = listIdentifier;
                        emailedCheckbox.addEventListener('change', handleEmailedChange);
                        cellEmailed.appendChild(emailedCheckbox);
                        row.insertCell().textContent = rep.district;
                        row.insertCell().textContent = rep.name;
                        row.insertCell().textContent = rep.party;
                        const cellEmail = row.insertCell();
                        const emailLink = document.createElement('a');
                        emailLink.href = "#"; 
                        emailLink.textContent = rep.email;
                        emailLink.dataset.email = rep.email;
                        emailLink.dataset.repName = rep.name;
                        emailLink.dataset.repId = rep.id;
                        emailLink.dataset.list = listIdentifier;
                        emailLink.classList.add('email-link');
                        emailLink.addEventListener('click', handleEmailClick);
                        cellEmail.appendChild(emailLink);
                        const cellPhone = row.insertCell();
                        const phoneLink = document.createElement('a');
                        phoneLink.href = `tel:${rep.phone.replace(/\D/g, '')}`;
                        phoneLink.textContent = rep.phone;
                        cellPhone.appendChild(phoneLink);
                        const cellResponseSummary = row.insertCell();
                        cellResponseSummary.classList.add('response-summary-cell');
                        updateResponseSummaryCell(cellResponseSummary, rep);
                    });
                }

                function updateResponseSummaryCell(cell, rep) {
                    if (rep.called) { 
                        let summaryText = 'N/A';
                        const selectedOptionText = responseOptions.find(opt => opt.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/^$/, 'not_selected') === rep.response);
                        summaryText = selectedOptionText || (rep.response !== 'not_selected' ? String(rep.response).replace(/_/g, ' ') : 'No response logged');
                        let summary = `Response: ${summaryText}`;
                        if (rep.notes) summary += `<br>Notes: ${String(rep.notes).substring(0, 35)}${String(rep.notes).length > 35 ? '...' : ''}`;
                        cell.innerHTML = summary;
                    } else {
                        cell.innerHTML = '<i>Not called yet</i>';
                    }
                }
                
                function getRepresentativeListByIdentifier(listIdentifier) {
                    if (listIdentifier === 'yaeDems') return representativesYaeDems;
                    if (listIdentifier === 'chairFlips') return representativesChairFlips;
                    if (listIdentifier === 'nayVoters') return representativesNayVoters;
                    return []; 
                }

                function handleCalledChange(event) {
                    const repId = event.target.dataset.repId;
                    const listIdentifier = event.target.dataset.list;
                    const currentList = getRepresentativeListByIdentifier(listIdentifier);
                    const repIndex = currentList.findIndex(r => r.id === repId);
                    if (repIndex === -1) return;
                    const rep = currentList[repIndex];
                    rep.called = event.target.checked;
                    const row = event.target.closest('tr'); 
                    const summaryCell = row ? row.cells[row.cells.length -1] : null; 
                    if (rep.called) { 
                        currentRepIdForModalInput.value = rep.id;
                        currentListIdentifierForModalInput.value = listIdentifier;
                        responseModalTitle.textContent = `Log Response: ${rep.name}`;
                        modalResponseSelect.value = rep.response || 'not_selected';
                        modalNotesTextarea.value = rep.notes || '';
                        responseModal.style.display = 'block';
                    } else { 
                        rep.response = 'not_selected';
                        rep.notes = '';
                        if (summaryCell) updateResponseSummaryCell(summaryCell, rep);
                    }
                    saveDataToAllStorages();
                }

                function handleEmailedChange(event) {
                    const repId = event.target.dataset.repId;
                    const listIdentifier = event.target.dataset.list;
                    const currentList = getRepresentativeListByIdentifier(listIdentifier);
                    const repIndex = currentList.findIndex(r => r.id === repId);
                    if (repIndex === -1) return;
                    currentList[repIndex].emailed = event.target.checked;
                    saveDataToAllStorages();
                }
                
                function handleEmailClick(event) {
                    event.preventDefault(); 
                    const targetLink = event.currentTarget; 
                    const recipientEmail = targetLink.dataset.email;
                    const repName = targetLink.dataset.repName;
                    const repId = targetLink.dataset.repId; 
                    const listIdentifier = targetLink.dataset.list;
                    if (!userFullName) {
                        alert("Please set your name in 'Edit My Info' before sending emails.");
                        onboardingModal.style.display = 'block';
                        onboardingUserNameInput.focus();
                        return;
                    }
                    if (!recipientEmail) { alert("Error: Rep email missing."); return; }
                    let subject = emailSubjectTemplateInput.value || "";
                    let body = emailBodyTemplateInput.value || "";
                    subject = subject.replace(/{RepName}/g, repName || "").replace(/{UserName}/g, userFullName).replace(/{UserLocation}/g, userLocation);
                    body = body.replace(/{RepName}/g, repName || "").replace(/{UserName}/g, userFullName).replace(/{UserLocation}/g, userLocation);
                    window.location.href = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    if (repId) {
                        const currentList = getRepresentativeListByIdentifier(listIdentifier);
                        const repIndex = currentList.findIndex(r => r.id === repId);
                        if (repIndex !== -1 && !currentList[repIndex].emailed) {
                            currentList[repIndex].emailed = true;
                            const row = targetLink.closest('tr');
                            const emailedCheckboxInRow = row ? row.querySelector('td:nth-child(2) input[type="checkbox"]') : null;
                            if (emailedCheckboxInRow) emailedCheckboxInRow.checked = true;
                            saveDataToAllStorages();
                        }
                    }
                }

                closeResponseModalBtn.onclick = () => responseModal.style.display = 'none';
                cancelResponseModalBtn.onclick = () => responseModal.style.display = 'none';
                saveResponseModalBtn.onclick = function() {
                    const repId = currentRepIdForModalInput.value;
                    const listIdentifier = currentListIdentifierForModalInput.value;
                    if (!repId || !listIdentifier) return;
                    const currentList = getRepresentativeListByIdentifier(listIdentifier);
                    const repIndex = currentList.findIndex(r => r.id === repId);
                    if (repIndex === -1) return;
                    currentList[repIndex].response = modalResponseSelect.value;
                    currentList[repIndex].notes = modalNotesTextarea.value;
                    let tableBodyElement;
                    if (listIdentifier === 'yaeDems') tableBodyElement = yaeDemsTableBody;
                    else if (listIdentifier === 'chairFlips') tableBodyElement = chairFlipsTableBody;
                    else if (listIdentifier === 'nayVoters') tableBodyElement = nayVotersTableBody;
                    if (tableBodyElement) {
                        const row = tableBodyElement.querySelector(`tr[data-id="${repId}"]`);
                        if (row) updateResponseSummaryCell(row.cells[row.cells.length -1], currentList[repIndex]);
                    }
                    responseModal.style.display = 'none';
                    saveDataToAllStorages();
                };
                
                showGuideButton.onclick = () => guideModal.style.display = 'block';
                closeGuideModalBtn.onclick = () => guideModal.style.display = 'none';
                dismissGuideModalBtn.onclick = () => guideModal.style.display = 'none';
                window.onclick = function(event) {
                    if (event.target == responseModal) responseModal.style.display = 'none';
                    if (event.target == onboardingModal) onboardingModal.style.display = 'none';
                    if (event.target == guideModal) guideModal.style.display = 'none';
                };

                exportButton.addEventListener('click', () => {
                    saveDataToAllStorages(); 
                    const dataToExport = {
                        deviceId: deviceId, // Include deviceId for potential re-import on same device context
                        representativesYaeDems: representativesYaeDems,
                        representativesChairFlips: representativesChairFlips,
                        representativesNayVoters: representativesNayVoters,
                        emailSubject: emailSubjectTemplateInput.value,
                        emailBody: emailBodyTemplateInput.value,
                        userFullName: userFullName,
                        userLocation: userLocation,
                        onboardingComplete: localStorage.getItem('onboardingComplete') === 'true'
                    };
                    const dataStr = JSON.stringify(dataToExport, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const exportFileDefaultName = 'sb3_call_tracker_progress.json';
                    let linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                    linkElement.remove();
                });

                importFile.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                const processImportedList = (dataKey, initialDataArray) => {
                                    let listToUpdate = [];
                                    if (importedData[dataKey] && Array.isArray(importedData[dataKey]) && initialDataArray.length > 0) {
                                        listToUpdate = initialDataArray.map(initialRep => {
                                            const importedRepData = importedData[dataKey].find(ir => ir.id === initialRep.id || (ir.name === initialRep.name && ir.district === initialRep.district));
                                            return { ...initialRep, called: importedRepData?.called || false, emailed: importedRepData?.emailed || false, response: importedRepData?.response || 'not_selected', notes: importedRepData?.notes || '' };
                                        });
                                    } else if (initialDataArray.length > 0) {
                                         listToUpdate = initialDataArray.map(rep => ({ ...rep, called: false, emailed: false, response: 'not_selected', notes: '' }));
                                    }
                                    return listToUpdate;
                                };
                                representativesYaeDems = processImportedList('representativesYaeDems', initialYaeDemsData);
                                representativesChairFlips = processImportedList('representativesChairFlips', initialChairFlipsData);
                                representativesNayVoters = processImportedList('representativesNayVoters', initialNayVotersData);

                                emailSubjectTemplateInput.value = importedData.emailSubject || defaultEmailSubject;
                                emailBodyTemplateInput.value = importedData.emailBody || defaultEmailBody;
                                userFullName = importedData.userFullName || '';
                                userLocation = importedData.userLocation || '';
                                onboardingUserNameInput.value = userFullName; 
                                onboardingUserLocationInput.value = userLocation;
                                if(importedData.onboardingComplete !== undefined) {
                                   localStorage.setItem('onboardingComplete', importedData.onboardingComplete.toString());
                                }
                                // If imported data contains a deviceId, prefer it for consistency if user is importing their own data.
                                // However, for a fresh import on a new device, we'd use the new device's generated ID.
                                // For now, we'll stick to the current deviceId.
                                saveDataToAllStorages(); 
                                renderAllTables();
                                alert('Progress imported successfully!');
                            } catch (error) {
                                console.error('Error importing data:', error);
                                alert('Error importing file.');
                            }
                            importFile.value = ''; 
                        };
                        reader.readAsText(file);
                    }
                });
                
                resetButton.addEventListener('click', () => {
                    if (confirm('Are you sure you want to reset all data? This will clear local storage and attempt to clear Firebase data for this device. This cannot be undone.')) {
                        localStorage.clear(); 
                        // Clear Firebase data for this device
                        if (currentUser && deviceId) {
                            db.ref(`devices/${deviceId}`).remove()
                                .then(() => console.log("Firebase data for device cleared."))
                                .catch(error => console.error("Error clearing Firebase data:", error));
                        }
                        // Regenerate deviceId for a fresh start if needed, or keep it to re-associate if user logs back in.
                        // For now, we'll keep it simple and just clear local. A new deviceId will be generated if not found.
                        deviceId = null; // Force re-generation or re-association on next load
                        localStorage.removeItem('sb3CallToolDeviceId');


                        initialYaeDemsData = []; 
                        initialChairFlipsData = [];
                        initialNayVotersData = [];
                        initializeApp(); 
                        alert('All data has been reset.');
                    }
                });

                emailSubjectTemplateInput.addEventListener('input', saveDataToAllStorages);
                emailBodyTemplateInput.addEventListener('input', saveDataToAllStorages);

                function renderAllTables() {
                    renderTable(yaeDemsTableBody, representativesYaeDems, 'yaeDems');
                    renderTable(chairFlipsTableBody, representativesChairFlips, 'chairFlips');
                    renderTable(nayVotersTableBody, representativesNayVoters, 'nayVoters');
                }

                async function initializeApp() {
                    console.log("Attempting to fetch initial data for all lists...");
                    initialYaeDemsData = await fetchAndProcessData('yae_dems.json', 'yaeDems');
                    initialChairFlipsData = await fetchAndProcessData('chair_flips.json', 'chairFlips');
                    initialNayVotersData = await fetchAndProcessData('nay_voters.json', 'nayVoters');
                    
                    auth.onAuthStateChanged(async user => {
                        if (user) {
                            console.log("User signed in anonymously:", user.uid);
                            currentUser = user;
                            // If the anonymous UID is different from stored deviceId, update deviceId to user.uid
                            // This makes the Firebase path based on the auth UID.
                            if (deviceId !== user.uid) {
                                console.log(`Device ID changing from ${deviceId} to auth UID ${user.uid}`);
                                deviceId = user.uid;
                                localStorage.setItem('sb3CallToolDeviceId', deviceId);
                            }
                        } else {
                            console.log("User is signed out. Signing in anonymously...");
                            currentUser = null;
                            try {
                                const userCredential = await auth.signInAnonymously();
                                currentUser = userCredential.user;
                                console.log("Signed in anonymously:", currentUser.uid);
                                deviceId = currentUser.uid; // Use auth UID as deviceId
                                localStorage.setItem('sb3CallToolDeviceId', deviceId);
                            } catch (error) {
                                console.error("Error signing in anonymously:", error);
                                alert("Could not connect to the database for backup. Progress will only be saved locally. Error: " + error.message);
                            }
                        }
                        await loadDataFromAllSources();
                        renderAllTables();
                        console.log("Initial load and render process finished for all lists.");
                    });
                }

                initializeApp().catch(e => {
                    alert("Error during app initialization: " + e.message + "\nSee console for details.");
                    console.error("Error during app initialization:", e);
                });
            });
        } catch (e) {
            alert("CRITICAL ERROR SETTING UP DOMContentLoaded: " + e.message);
            console.error("CRITICAL ERROR SETTING UP DOMContentLoaded:", e);
        }
    </script>
</body>
</html>
