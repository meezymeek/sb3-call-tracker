<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SB3 Call Tool</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --dark-bg-primary: #1e1e1e;
            --dark-bg-secondary: #2c2c2c;
            --dark-bg-tertiary: #383838;
            --dark-text-primary: #e0e0e0;
            --dark-text-secondary: #b0b0b0;
            --accent-green: #4CAF50;
            --accent-green-darker: #388E3C;
            --border-color-dark: #444444;
            --utility-button-bg: #5a5a5a;
            --utility-button-hover-bg: #4a4a4a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 25px;
            background-color: var(--dark-bg-secondary);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--accent-green);
        }
        header h1 {
            color: var(--accent-green);
            margin: 0 0 5px 0;
            font-size: 2.2em;
        }
        .version-number {
            display: block;
            font-size: 0.8em;
            color: var(--dark-text-secondary);
            margin-bottom: 10px;
        }

        header p {
            color: var(--dark-text-secondary);
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .report-problem-link {
            font-size: 0.85em;
            color: var(--dark-text-secondary);
        }
        .report-problem-link a {
            color: var(--accent-green-darker);
        }
        .report-problem-link a:hover {
            color: var(--accent-green);
        }


        .controls, .email-template-section {
            margin-bottom: 25px;
            padding: 15px;
            background-color: var(--dark-bg-tertiary);
            border-radius: 6px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .email-template-section {
            flex-direction: column;
            align-items: flex-start;
        }

        .email-template-section label {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--dark-text-primary);
        }
        
        .email-template-section input[type="text"],
        .email-template-section textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color-dark);
            border-radius: 4px;
            font-size: 0.95em;
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }
        .email-template-section input[type="text"]:focus,
        .email-template-section textarea:focus {
            border-color: var(--accent-green);
            outline: none;
        }
        
        .email-template-section textarea {
            min-height: 120px; 
            resize: vertical;
        }
        .email-template-section small {
            color: var(--dark-text-secondary);
        }

        /* Toggle Switch Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            flex-shrink: 0;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-green);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .toggle-label {
            margin-right: 10px;
            font-weight: bold;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Hamburger Menu & Sidenav */
        .sidenav {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1001;
            top: 0;
            left: 0;
            background-color: var(--dark-bg-secondary);
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
        }
        .sidenav a, .sidenav .toggle-container, .sidenav .sidenav-link {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 1.1em;
            color: var(--dark-text-primary);
            display: block;
            transition: 0.3s;
            cursor: pointer;
        }
        .sidenav a:hover, .sidenav .sidenav-link:hover {
            color: var(--accent-green);
        }
        .sidenav .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }
        .hamburger-btn {
            font-size: 24px;
            cursor: pointer;
            color: var(--dark-text-primary);
            background-color: var(--utility-button-bg);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
        }
        .hamburger-btn:hover {
            background-color: var(--utility-button-hover-bg);
        }
        .floating-hamburger-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        /* Scroll-to-top button */
        #scrollTopBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: var(--accent-green);
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            font-size: 18px;
            width: 50px;
            height: 50px;
        }
        #scrollTopBtn:hover {
            background-color: var(--accent-green-darker);
        }


        .controls button, .controls label.button-like {
            padding: 10px 15px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .table-container {
            overflow-x: auto; 
            margin-bottom: 20px; 
        }

        table {
            width: 100%; 
            border-collapse: collapse;
            table-layout: fixed; 
        }

        th, td {
            padding: 12px 8px; 
            text-align: left;
            border-bottom: 1px solid var(--border-color-dark);
            vertical-align: middle;
            word-break: break-word; 
            overflow-wrap: break-word;
        }
        
        td a { 
            word-break: break-all;
            overflow-wrap: break-word; 
        }

        th {
            background-color: var(--accent-green);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        th:nth-child(1), td:nth-child(1) { width: 7%; }  /* Called */
        th:nth-child(2), td:nth-child(2) { width: 7%; }  /* Emailed */
        th:nth-child(3), td:nth-child(3) { width: 8%; }  /* District */
        th:nth-child(4), td:nth-child(4) { width: 18%; } /* Representative */
        th:nth-child(5), td:nth-child(5) { width: 7%; }  /* Party */
        th:nth-child(6), td:nth-child(6) { width: 20%; } /* Email */
        th:nth-child(7), td:nth-child(7) { width: 13%; } /* Phone */
        th:nth-child(8), td:nth-child(8) { width: 20%; } /* Response Summary */


        tr:nth-child(even) {
            background-color: var(--dark-bg-tertiary); 
        }

        tr:hover {
            background-color: #404040; 
        }

        input[type="checkbox"] {
            transform: scale(1.2); 
            margin-right: 3px; 
            cursor: pointer;
            vertical-align: middle;
        }
        
        a { 
            color: var(--accent-green);
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
            color: var(--accent-green-darker);
        }
        
        .footer-actions {
            margin-top: 30px;
            text-align: right;
            min-height: 40px; /* Ensure space even if button is removed */
        }
         .footer-actions button { 
            margin-left: 10px;
            background-color: var(--accent-green);
            color: white; 
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
         }
         .footer-actions button:hover {
            background-color: var(--accent-green-darker);
         }

        .response-summary-cell {
            font-size: 0.85em;
            color: var(--dark-text-secondary);
            line-height: 1.4;
        }
        .response-summary-cell i {
            color: #888;
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.7); 
            padding-top: 40px;
        }

        .modal-content {
            background-color: var(--dark-bg-secondary);
            margin: 5% auto; 
            padding: 25px;
            border: 1px solid var(--border-color-dark);
            width: 80%; 
            max-width: 600px; 
            border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.4),0 6px 20px 0 rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-content h2, .modal-content h3 {
            margin-top: 0;
            color: var(--accent-green);
        }
        .modal-content h4 { 
            color: var(--accent-green-darker);
            margin-top: 1.2em;
            margin-bottom: 0.5em;
        }

        .modal-content label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark-text-primary);
        }
        .modal-content input[type="text"], 
        .modal-content select, 
        .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color-dark);
            border-radius: 4px;
            font-size: 1em;
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }
        .modal-content input[type="text"]:focus, 
        .modal-content select:focus, 
        .modal-content textarea:focus {
            border-color: var(--accent-green);
            outline: none;
        }
        .modal-content select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e0e0e0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
            padding-right: 2em;
        }
        .modal-content textarea {
            min-height: 100px;
            resize: vertical;
        }
        .modal-content button { 
            background-color: var(--accent-green);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
            margin-right: 10px;
        }
        .modal-content button:hover {
            background-color: var(--accent-green-darker);
        }
        .modal-content button.button-outline { 
            background-color: transparent;
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }
        .modal-content button.button-outline:hover {
            background-color: rgba(76, 175, 80, 0.1); 
        }
        .modal-content ul {
            padding-left: 20px;
            margin-top: 0.5em;
        }
        .modal-content li {
            margin-bottom: 0.5em;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        
        /* New styles for multi-step modal */
        .modal-step { display: none; }
        .modal-step.active { display: block; }
        .modal-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .modal-navigation button {
            padding: 10px 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        .form-group input[type="text"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color-dark);
            background-color: var(--dark-bg-primary);
            color: var(--dark-text-primary);
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .radio-group label,
        .checkbox-group label {
            font-weight: normal;
            display: block;
            margin-bottom: 5px;
        }
        .radio-group input,
        .checkbox-group input {
            margin-right: 10px;
        }
        .caveat-section {
            margin-left: 25px;
            margin-top: 5px;
        }
        .caveat-section input {
            width: calc(100% - 80px);
            display: inline-block;
        }
        .add-caveat-btn {
            font-size: 0.8em;
            padding: 4px 8px;
            margin-left: 10px;
            background-color: var(--utility-button-bg);
            display: none; /* Hidden by default */
        }
        .hidden {
            display: none;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--dark-text-primary);
            text-decoration: none;
            cursor: pointer;
        }

        @media screen and (max-width: 768px) {
            .container { width: 98%; padding: 15px; margin-top: 10px; }
            header h1 { font-size: 1.6em; }
            header p { font-size: 0.95em; }
            .controls { flex-direction: row; }
            .controls button, .controls label.button-like { 
                width: auto; 
                flex-grow: 0; 
                margin-bottom: 5px; 
            }
            @media (max-width: 600px) { 
                .controls { flex-direction: column; }
                .controls button, .controls label.button-like { width: 100%; margin-bottom: 10px; }
            }

            th, td { padding: 8px 4px; font-size: 0.7em; } 
            th:nth-child(1), td:nth-child(1) { width: 8%; }
            th:nth-child(2), td:nth-child(2) { width: 8%; }
            th:nth-child(3), td:nth-child(3) { width: 8%; }
            th:nth-child(4), td:nth-child(4) { width: 18%; }
            th:nth-child(5), td:nth-child(5) { width: 7%; }
            th:nth-child(6), td:nth-child(6) { width: 13%; }
            th:nth-child(7), td:nth-child(7) { width: 20%; }
            th:nth-child(8), td:nth-child(8) { width: 18%; }

            .modal-content { width: 90%; margin: 10% auto; padding: 20px; }
        }
         @media screen and (max-width: 480px) {
            header h1 { font-size: 1.4em; }
            .version-number { font-size: 0.75em; }
            .report-problem-link { font-size: 0.8em; }

            th, td { padding: 6px 3px; font-size: 0.60em; } 

            th:nth-child(3), td:nth-child(3) { display: none; } 
            th:nth-child(5), td:nth-child(5) { display: none; } 
            th:nth-child(1), td:nth-child(1) { width: 10%; } 
            th:nth-child(2), td:nth-child(2) { width: 10%; } 
            th:nth-child(4), td:nth-child(4) { width: 25%; } 
            th:nth-child(6), td:nth-child(6) { width: 15%; } 
            th:nth-child(7), td:nth-child(7) { width: 20%; } 
            th:nth-child(8), td:nth-child(8) { width: 20%; } 
         }

        /* Loader Styles */
        #loader {
            position: fixed;
            left: 50%;
            top: 50%;
            z-index: 1001;
            width: 120px;
            height: 120px;
            margin: -76px 0 0 -76px;
            border: 16px solid var(--dark-bg-tertiary);
            border-radius: 50%;
            border-top: 16px solid var(--accent-green);
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Email Generation Spinner */
        .email-gen-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--accent-green);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <div id="loader"></div>
    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" id="closeNavBtn">×</a>
        <a href="#" id="sideNavGuide">User Guide</a>
        <a href="#" id="sideNavExport">Export Progress</a>
        <label for="sideNavImportFile" class="sidenav-link">Import Progress</label>
        <input type="file" id="sideNavImportFile" accept=".json" style="display: none;">
        <a href="#" id="sideNavEditInfo">Edit My Info</a>
        <a href="#" id="sideNavReset">Reset All Data</a>
        <div class="toggle-container">
            <span class="toggle-label">AI Email Writing Assistance</span>
            <label class="switch">
                <input type="checkbox" id="llmToggle" checked>
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <button class="hamburger-btn floating-hamburger-btn" id="floatingNavBtn">☰</button>

    <div class="container">
        <header>
            <div>
                <h1>SB3 Call Tool</h1>
                <span class="version-number">v2.0 (IntelliDraft)</span>
                <p>Track your calls and emails to representatives, their responses, and your notes. Progress is saved automatically to your device and backed up to a secure cloud database.</p>
                <div class="report-problem-link">
                    <a href="mailto:hayden@delta8denton.com?subject=Problem Report - SB3 Call Tracker v1.1">Report Problems</a>
                </div>
            </div>
            <button class="hamburger-btn" id="openNavBtn">☰</button>
        </header>

        <div class="controls">
        </div>

        <div class="email-template-section hidden" id="emailTemplateSection">
            <label for="emailSubjectTemplate">Template Subject:</label>
            <input type="text" id="emailSubjectTemplate">
            <label for="emailBodyTemplate">Template Body:</label>
            <textarea id="emailBodyTemplate"></textarea>
            <small>Use placeholders: {repName}, {userName}, {userLocation}</small>
        </div>

        <div id="your-representatives-container" class="hidden"></div>
        <div id="dynamic-tables-container"></div>

         <div class="footer-actions">
            <!-- Save All Changes button removed due to auto-save implementation -->
        </div>
    </div>

    <button id="scrollTopBtn" title="Go to top">↑</button>

    <div id="onboardingModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" id="closeOnboardingModal">×</span>
            <h2>Create Your Communications Profile</h2>
            <p>This optional info helps generate more personalized, effective messages. Your answers are saved to your device and backed up securely.</p>

            <!-- Step 1: Basic Info -->
            <div id="modalStep1" class="modal-step active">
                <h3>Step 1: About You</h3>
                <div class="form-group">
                    <label for="onboardingUserName">Your Full Name (for email signature):</label>
                    <input type="text" id="onboardingUserName" placeholder="e.g., Jane Doe">
                </div>
                <div class="form-group">
                    <label for="onboardingUserLocation">Your City/Town (e.g., "Austin resident"):</label>
                    <input type="text" id="onboardingUserLocation" placeholder="e.g., Austin, TX or concerned Texan">
                </div>
                <div class="form-group">
                    <label for="onboardingZipCode">What is your Zip Code?</label>
                    <input type="text" id="onboardingZipCode" placeholder="e.g., 78701">
                </div>
                <div class="form-group">
                    <label>Do you work in the Hemp Industry?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="hempIndustry" value="yes"> Yes</label>
                        <label><input type="radio" name="hempIndustry" value="no"> No</label>
                    </div>
                </div>
                <div class="form-group hidden" id="occupationGroup">
                    <label for="onboardingOccupation">What do you do?</label>
                    <input type="text" id="onboardingOccupation" placeholder="e.g., Teacher, Engineer, etc.">
                </div>
            </div>

            <!-- Step 2: Tone & Personality -->
            <div id="modalStep2" class="modal-step">
                <h3>Step 2: Your Voice</h3>
                <div class="form-group">
                    <label for="primaryToneSelect">Select your Primary Tone:</label>
                    <select id="primaryToneSelect"></select>
                </div>
                <div class="form-group">
                    <label>Select up to two supporting Personality Elements:</label>
                    <div id="personalityElementsContainer" class="checkbox-group"></div>
                </div>
            </div>

            <!-- Step 3: Personal Impact -->
            <div id="modalStep3" class="modal-step">
                <h3>Step 3: Your Story</h3>
                <div class="form-group">
                    <label for="banImpactStatement">What specifically would a THC ban mean to you?</label>
                    <textarea id="banImpactStatement" placeholder="Share your personal story or perspective."></textarea>
                </div>
                <div class="form-group">
                    <label for="additionalComments">Do you have any personal points or comments you would like to ensure are conveyed?</label>
                    <textarea id="additionalComments" placeholder="Add any other key points."></textarea>
                </div>
            </div>

            <!-- Step 4: Regulations SUPPORT -->
            <div id="modalStep4" class="modal-step">
                <h3>Step 4: Regulation Preferences (SUPPORT)</h3>
                <div class="form-group">
                    <label>Select which regulations you SUPPORT:</label>
                    <div id="supportedRegulationsContainer" class="checkbox-group"></div>
                </div>
            </div>

            <!-- Step 5: Regulations OPPOSE -->
            <div id="modalStep5" class="modal-step">
                <h3>Step 5: Regulation Preferences (OPPOSE)</h3>
                <div class="form-group">
                    <label>Select which regulations you would NOT want to see:</label>
                    <div id="opposedRegulationsContainer" class="checkbox-group"></div>
                </div>
            </div>

            <div class="modal-navigation">
                <button id="modalPrevBtn" class="button-outline">Previous</button>
                <button id="modalNextBtn">Next</button>
                <button id="saveOnboardingInfo" class="hidden">Save Profile</button>
            </div>
        </div>
    </div>

    <div id="responseModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeResponseModal">×</span>
            <h3 id="responseModalTitle">Log Call Response</h3>
            <input type="hidden" id="currentRepIdForModal">
            <input type="hidden" id="currentListIdentifierForModal">
            <label for="modalResponseSelect">Response:</label>
            <select id="modalResponseSelect"></select>
            <label for="modalNotesTextarea">Notes (e.g., staffer name, key points discussed):</label>
            <textarea id="modalNotesTextarea" placeholder="Enter notes here..."></textarea>
            <button id="saveResponseModal">Save Response</button>
            <button id="cancelResponseModal" class="button-outline">Cancel</button>
        </div>
    </div>

    <div id="emailGenerationModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeEmailGenerationModal">×</span>
            <h3 id="emailGenModalTitle">Your Personalized Email Draft</h3>
            <div id="emailGenSpinner" class="hidden" style="text-align: center;">
                <div class="email-gen-spinner"></div>
                <p>Generating your personalized draft...</p>
            </div>
            <div id="emailGenContent" class="hidden">
                <div class="form-group">
                    <label for="generatedSubject">Subject:</label>
                    <input type="text" id="generatedSubject">
                </div>
                <div class="form-group">
                    <label for="generatedBody">Body:</label>
                    <textarea id="generatedBody" style="min-height: 250px;"></textarea>
                </div>
                <div class="modal-navigation">
                    <button id="approveAndSendEmail" class="button-primary">Approve & Send</button>
                    <button id="cancelEmailGeneration" class="button-outline">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="guideModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeGuideModal">×</span>
            <h2>SB3 Call Tracker - Easy Mobile Guide (v1.1 - Firebase Beta)</h2>
            <p>This tool helps you contact lawmakers. Your progress is saved automatically to this device and backed up to a secure cloud database (Firebase) linked to this device only.</p>
            <h4>1. First Time Opening? (Quick Setup):</h4>
            <ul>
                <li>A "Welcome" box will pop up.</li>
                <li>Type in your <strong>Full Name</strong> and <strong>City/Town</strong>.</li>
                <li>Tap "Save and Continue." This info is saved to your device and backed up.</li>
                <li><em>Need to change it later? Tap "Edit My Info."</em></li>
            </ul>
            <h4>2. Sending Emails:</h4>
            <ul>
                <li>Email templates are provided. You can edit them on the main screen.</li>
                <li>Changes to templates are saved automatically.</li>
            </ul>
            <h4>3. Contacting Lawmakers:</h4>
            <ul>
                <li><strong>To Call:</strong> Tap the phone number. After, check "Called." A box appears to log the response and notes. Tap "Save Response."</li>
                <li><strong>To Email:</strong> Tap the email address. Your email app opens. After sending, the "Emailed" box is checked automatically.</li>
                <li>All these actions are saved automatically.</li>
            </ul>
            <h4>4. Your Progress:</h4>
            <ul>
                <li><strong>Auto-Save:</strong> All changes (checkboxes, notes, templates, user info) are saved automatically to your device and backed up. The "Save All Changes" button has been removed.</li>
                <li><strong>Export/Import:</strong> Still available for manual backups or transferring to a *new* device if needed (though Firebase aims to make this less necessary for the same device).</li>
                <li><strong>Reset All Data:</strong> Clears data from *this device's local storage and its Firebase backup*. Use with caution!</li>
            </ul>
            <button id="dismissGuideModal" class="button-outline" style="margin-top: 20px;">Dismiss</button>
        </div>
    </div>

    <script>
        // Global error handler
        window.onerror = function(message, source, lineno, colno, error) {
            const errorDetails = `CRITICAL SCRIPT ERROR:\nMessage: ${message}\nSource: ${source}\nLine: ${lineno}\nColumn: ${colno}\nError: ${error ? JSON.stringify(error) : 'N/A'}`;
            alert(errorDetails);
            console.error("GLOBAL ERROR:", message, source, lineno, colno, error);
            return true;
        };

        try {
            document.addEventListener('DOMContentLoaded', function() {
                console.log("DOMContentLoaded event fired.");

                // --- Constants and Config ---
                const firebaseConfig = {
                    apiKey: "AIzaSyAm-QMDte5ytPN7Z8Cz7VaDe7hUVGsTE-8",
                    authDomain: "sb3calltool.firebaseapp.com",
                    projectId: "sb3calltool",
                    storageBucket: "sb3calltool.firebasestorage.app",
                    messagingSenderId: "834566220861",
                    appId: "1:834566220861:web:6475e1ddf50c00e54b0e54",
                    measurementId: "G-BC4Z144B00",
                    databaseURL: "https://sb3calltool-default-rtdb.firebaseio.com"
                };

                const TONE_AND_PERSONALITY_DATA = {
                  "primary_tones": [{"code":"PROF_FORMAL","name":"Professional‑Formal","how_it_feels":"Polite, businesslike, courteous","best_for":"First contact; complex policy issues"}, {"code":"FRIEND_PRO","name":"Friendly‑Professional","how_it_feels":"Warm but business‑appropriate","best_for":"Community matters; local projects"}, {"code":"POLICY_ANALYTICAL","name":"Policy‑Analytical","how_it_feels":"Data‑driven, objective","best_for":"Budget, economic, or technical topics"}, {"code":"PERSONAL_NARR","name":"Personal Narrative","how_it_feels":"Brief personal story, heartfelt","best_for":"Health, education, human‑impact issues"}, {"code":"SOLUTION_ORIENT","name":"Solution‑Oriented","how_it_feels":"Constructive, next‑step focused","best_for":"Suggesting specific legislation or amendments"}, {"code":"CIVIC_PATRIOTIC","name":"Civic Duty / Patriotic","how_it_feels":"Shared values and service","best_for":"Voting rights, veterans’ issues"}, {"code":"INSPIRATIONAL","name":"Inspirational / Hopeful","how_it_feels":"Uplifting, forward‑looking","best_for":"Climate, youth, visionary initiatives"}, {"code":"URGENT_RESPECT","name":"Urgent‑Yet‑Respectful","how_it_feels":"Time‑sensitive without aggression","best_for":"Imminent votes; impending deadlines"}, {"code":"BIPARTISAN","name":"Bipartisan‑Bridge‑Building","how_it_feels":"Common‑ground, non‑partisan","best_for":"Cross‑aisle support"}],
                  "personality_elements": [{"code":"EMPATHETIC","name":"Empathetic","short_descriptor":"Expresses understanding","adds":"Human connection"}, {"code":"CONCISE","name":"Concise","short_descriptor":"Brief, no tangents","adds":"Clarity & time respect"}, {"code":"DETAILED","name":"Detailed / Source‑Citing","short_descriptor":"References bills or data","adds":"Credibility"}, {"code":"STORY_DRIVEN","name":"Story‑Driven","short_descriptor":"Uses one vivid anecdote","adds":"Emotional resonance"}, {"code":"CONFIDENT","name":"Confident","short_descriptor":"Steady conviction","adds":"Persuasiveness"}, {"code":"HUMBLE","name":"Humble / Collaborative","short_descriptor":"Acknowledges limits","adds":"Approachability"}, {"code":"OPTIMISTIC","name":"Optimistic","short_descriptor":"Highlights gains","adds":"Positive framing"}, {"code":"CONCERNED","name":"Concerned / Cautious","short_descriptor":"Polite worry or risk","adds":"Gravity"}, {"code":"FORWARD_THINK","name":"Forward‑Thinking","short_descriptor":"Long‑term benefits","adds":"Strategic view"}, {"code":"GRATITUDE","name":"Gratitude‑Focused","short_descriptor":"Thanks legislator","adds":"Goodwill"}, {"code":"COMMUNITY_VOICE","name":"Constituent‑Community Voice","short_descriptor":"Inclusive “we”, local refs","adds":"Grass‑roots solidarity"}, {"code":"DATA_SAVVY","name":"Data‑Savvy","short_descriptor":"Links to charts or facts","adds":"Depth for evidence‑minded"}, {"code":"SOLUTION_SEEK","name":"Solution‑Seeking","short_descriptor":"Invites feedback","adds":"Two‑way dialogue"}]
                };

                const REGULATION_OPTIONS = ["Age & Access Control – No sales to minors; retail areas must be 21+ only and display clear danger/warning signs.", "Location Limits – Stores or kiosks may not operate near schools, churches, parks, playgrounds, or similar child‑focused venues.", "Packaging & Marketing – Containers must be child‑resistant, tamper‑evident, resealable, and not designed to appeal to children.", "Product Purity – THC items cannot be combined with other psychoactive substances (alcohol, tobacco, kratom, etc.).", "Testing & Tracking – Mandatory testing at every production stage; seed‑to‑sale manifests/lab reports must be accurate (forgery is a felony).", "Facility & Operator Permits – Growers, processors, and retailers need state permits, follow food‑safety rules, and pay fees that fund enforcement by TABC and partner agencies.", "Local Control – Cities and counties may ban or restrict THC retail outlets.", "Sales Window & Quantity Caps – Transactions allowed only 10 a.m.–9 p.m., never on Sundays; per‑product THC limits and purchase limits per customer apply.", "Labeling – Packages must show a surgeon‑general–style warning, full ingredient list, THC content, and a scannable QR/barcode linking to test results.", "Public‑Use Ban – Public consumption, use on retail premises, and open containers in vehicles are criminal offenses.", "Enforcement Powers – Attorney General, DAs, and county attorneys may pursue violations under the Deceptive Trade Practices Act.", "Taxes & Funding – Excise taxes plus dedicated state funds must cover oversight, with extra resources earmarked for law‑enforcement operations."];

                // --- Firebase Initialization ---
                firebase.initializeApp(firebaseConfig);
                firebase.analytics();
                const auth = firebase.auth();
                const db = firebase.database();
                const functions = firebase.functions();
                const firestore = firebase.firestore();
                
                // Connect to emulators
                if (window.location.hostname === "127.0.0.1") {
                    console.log("Connecting to local emulators.");
                    db.useEmulator("127.0.0.1", 9000);
                    functions.useEmulator("127.0.0.1", 5001);
                }

                let currentUser = null;
                let deviceId = localStorage.getItem('sb3CallToolDeviceId');
                if (!deviceId) {
                    deviceId = 'device-' + Math.random().toString(36).substr(2, 16) + Date.now().toString(36);
                    localStorage.setItem('sb3CallToolDeviceId', deviceId);
                }

                // --- State Variables ---
                let contactLists = new Map();
                let userProfile = {};
                let currentModalStep = 1;

                // --- DOM Element Caching ---
                const dynamicTablesContainer = document.getElementById('dynamic-tables-container');
                
                // Sidenav & Controls
                const openNavBtn = document.getElementById('openNavBtn');
                const floatingNavBtn = document.getElementById('floatingNavBtn');
                const closeNavBtn = document.getElementById('closeNavBtn');
                const sideNavGuideBtn = document.getElementById('sideNavGuide');
                const sideNavExportBtn = document.getElementById('sideNavExport');
                const sideNavImportInput = document.getElementById('sideNavImportFile');
                const sideNavEditInfoBtn = document.getElementById('sideNavEditInfo');
                const sideNavResetBtn = document.getElementById('sideNavReset');
                const llmToggle = document.getElementById('llmToggle');
                const scrollTopBtn = document.getElementById('scrollTopBtn');

                // Onboarding Modal Elements
                const onboardingModal = document.getElementById('onboardingModal');
                const closeOnboardingModalBtn = document.getElementById('closeOnboardingModal');
                const emailTemplateSection = document.getElementById('emailTemplateSection');
                const emailSubjectTemplateInput = document.getElementById('emailSubjectTemplate');
                const emailBodyTemplateInput = document.getElementById('emailBodyTemplate');
                const onboardingUserNameInput = document.getElementById('onboardingUserName');
                const onboardingUserLocationInput = document.getElementById('onboardingUserLocation');
                const onboardingZipCodeInput = document.getElementById('onboardingZipCode');
                const occupationGroup = document.getElementById('occupationGroup');
                const onboardingOccupationInput = document.getElementById('onboardingOccupation');
                const primaryToneSelect = document.getElementById('primaryToneSelect');
                const personalityElementsContainer = document.getElementById('personalityElementsContainer');
                const banImpactStatementInput = document.getElementById('banImpactStatement');
                const additionalCommentsInput = document.getElementById('additionalComments');
                const supportedRegulationsContainer = document.getElementById('supportedRegulationsContainer');
                const opposedRegulationsContainer = document.getElementById('opposedRegulationsContainer');
                const modalPrevBtn = document.getElementById('modalPrevBtn');
                const modalNextBtn = document.getElementById('modalNextBtn');
                const saveOnboardingInfoBtn = document.getElementById('saveOnboardingInfo');

                // Other Modals
                const responseModal = document.getElementById('responseModal');
                const guideModal = document.getElementById('guideModal');

                // --- Main Logic ---
                
                async function initializeApp() {
                    // Synchronous setup parts
                    populateToneAndPersonality();
                    populateRegulations();
                    setupModalListeners();
                    // Asynchronous part that should be awaited
                    await loadEmailTemplate();

                    // The main async logic wrapped in a promise
                    return new Promise((resolve, reject) => {
                        // Use onAuthStateChanged, but only for the initial check.
                        const unsubscribe = auth.onAuthStateChanged(async user => {
                            unsubscribe(); // Unsubscribe to avoid re-running this on auth changes.
                            try {
                                if (user) {
                                    currentUser = user;
                                } else {
                                    // If no user, sign in anonymously.
                                    const userCredential = await auth.signInAnonymously();
                                    currentUser = userCredential.user;
                                }

                                // Now that we have a user, ensure deviceId is correct.
                                if (deviceId !== currentUser.uid) {
                                    deviceId = currentUser.uid;
                                    localStorage.setItem('sb3CallToolDeviceId', deviceId);
                                }

                                // Load all necessary data.
                                await loadContactLists();
                                await loadDataFromAllSources();
                                await displayYourReps();

                                // Render the UI.
                                renderAllTables();
                                document.getElementById('loader').style.display = 'none';

                                resolve(); // Signal that initialization is complete.
                            } catch (error) {
                                // If anything fails, reject the promise.
                                console.error("Error during app initialization:", error);
                                alert("A critical error occurred during startup. Please refresh the page.");
                                reject(error);
                            }
                        });
                    });
                }

                function setupModalListeners() {
                    sideNavEditInfoBtn.addEventListener('click', () => {
                        populateOnboardingForm();
                        onboardingModal.style.display = 'block';
                        currentModalStep = 1;
                        updateModalStepVisibility();
                        closeNav();
                    });

                    sideNavGuideBtn.addEventListener('click', () => {
                        guideModal.style.display = 'block';
                        closeNav();
                    });

                    closeOnboardingModalBtn.onclick = () => onboardingModal.style.display = 'none';
                    
                    document.querySelectorAll('input[name="hempIndustry"]').forEach(radio => {
                        radio.addEventListener('change', (e) => {
                            occupationGroup.classList.toggle('hidden', e.target.value !== 'no');
                        });
                    });

                    modalNextBtn.addEventListener('click', () => navigateModal(1));
                    modalPrevBtn.addEventListener('click', () => navigateModal(-1));
                    saveOnboardingInfoBtn.addEventListener('click', saveAndCloseOnboarding);

                    llmToggle.addEventListener('change', () => {
                        emailTemplateSection.classList.toggle('hidden', llmToggle.checked);
                    });

                    // Sidenav listeners
                    openNavBtn.addEventListener('click', openNav);
                    floatingNavBtn.addEventListener('click', openNav);
                    closeNavBtn.addEventListener('click', closeNav);

                    // Scroll-to-top listener
                    window.onscroll = function() {scrollFunction()};
                    scrollTopBtn.addEventListener('click', topFunction);

                    // Wire up sidenav buttons to original functions
                    sideNavExportBtn.addEventListener('click', exportDataHandler);
                    sideNavImportInput.addEventListener('change', importDataHandler);
                    sideNavResetBtn.addEventListener('click', resetDataHandler);
                }

                function openNav() {
                    document.getElementById("mySidenav").style.width = "250px";
                }

                function closeNav() {
                    document.getElementById("mySidenav").style.width = "0";
                }

                function scrollFunction() {
                    const shouldShow = document.body.scrollTop > 20 || document.documentElement.scrollTop > 20;
                    scrollTopBtn.style.display = shouldShow ? "block" : "none";
                    floatingNavBtn.style.display = shouldShow ? "block" : "none";
                }

                function topFunction() {
                    document.body.scrollTop = 0; // For Safari
                    document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
                }

                async function loadEmailTemplate() {
                    try {
                        const response = await fetch('email_template.json');
                        const template = await response.json();
                        emailSubjectTemplateInput.value = template.subject;
                        emailBodyTemplateInput.value = template.body;
                    } catch (error) {
                        console.error("Error loading email template:", error);
                        emailSubjectTemplateInput.value = "Regarding THC Regulation";
                        emailBodyTemplateInput.value = "Dear Representative {repName},\n\n...";
                    }
                }

                function navigateModal(direction) {
                    currentModalStep += direction;
                    updateModalStepVisibility();
                }

                function updateModalStepVisibility() {
                    document.querySelectorAll('.modal-step').forEach((step, index) => {
                        step.classList.toggle('active', (index + 1) === currentModalStep);
                    });
                    modalPrevBtn.classList.toggle('hidden', currentModalStep === 1);
                    modalNextBtn.classList.toggle('hidden', currentModalStep === 5);
                    saveOnboardingInfoBtn.classList.toggle('hidden', currentModalStep !== 5);
                }

                function saveAndCloseOnboarding() {
                    // Gather data from form
                    const supportedRegulations = [];
                    document.querySelectorAll('#supportedRegulationsContainer input[type="checkbox"]:checked').forEach(cb => {
                        const caveatInput = document.getElementById(`caveat-sup-${cb.dataset.index}`);
                        supportedRegulations.push({
                            regulation: cb.value,
                            caveat: caveatInput ? caveatInput.value.trim() : ''
                        });
                    });

                    const opposedRegulations = [];
                    document.querySelectorAll('#opposedRegulationsContainer input[type="checkbox"]:checked').forEach(cb => {
                        const caveatInput = document.getElementById(`caveat-opp-${cb.dataset.index}`);
                        opposedRegulations.push({
                            regulation: cb.value,
                            caveat: caveatInput ? caveatInput.value.trim() : ''
                        });
                    });

                    const selectedPersonalityElements = Array.from(document.querySelectorAll('#personalityElementsContainer input[type="checkbox"]:checked')).map(cb => cb.value);

                    userProfile.userFullName = onboardingUserNameInput.value.trim();
                    userProfile.userLocation = onboardingUserLocationInput.value.trim();
                    userProfile.zipCode = onboardingZipCodeInput.value.trim();
                    userProfile.onboardingComplete = true;
                    userProfile.intelligentDraftingProfile = {
                        worksInHempIndustry: document.querySelector('input[name="hempIndustry"]:checked').value === 'yes',
                        occupation: document.querySelector('input[name="hempIndustry"]:checked').value === 'no' ? onboardingOccupationInput.value.trim() : null,
                        banImpactStatement: banImpactStatementInput.value.trim(),
                        additionalComments: additionalCommentsInput.value.trim(),
                        communicationTone: {
                            primaryTone: primaryToneSelect.value,
                            personalityElements: selectedPersonalityElements
                        },
                        supportedRegulations: supportedRegulations,
                        opposedRegulations: opposedRegulations
                    };
                    
                    onboardingModal.style.display = 'none';
                    alert('Your Communications Profile has been saved.');
                    saveDataToAllStorages();
                }

                function populateOnboardingForm() {
                    const profile = userProfile.intelligentDraftingProfile || {};
                    const tone = profile.communicationTone || {};

                    onboardingUserNameInput.value = userProfile.userFullName || '';
                    onboardingUserLocationInput.value = userProfile.userLocation || '';
                    onboardingZipCodeInput.value = userProfile.zipCode || '';
                    
                    const worksInHemp = profile.worksInHempIndustry;
                    const hempRadio = document.querySelector(`input[name="hempIndustry"][value="${worksInHemp ? 'yes' : 'no'}"]`);
                    if (hempRadio) {
                        hempRadio.checked = true;
                    }
                    occupationGroup.classList.toggle('hidden', worksInHemp !== false);
                    onboardingOccupationInput.value = profile.occupation || '';

                    primaryToneSelect.value = tone.primaryTone || 'PROF_FORMAL';
                    document.querySelectorAll('#personalityElementsContainer input[type="checkbox"]').forEach(cb => {
                        cb.checked = (tone.personalityElements || []).includes(cb.value);
                    });

                    banImpactStatementInput.value = profile.banImpactStatement || '';
                    additionalCommentsInput.value = profile.additionalComments || '';

                    populateRegulationCheckboxes(supportedRegulationsContainer, profile.supportedRegulations || [], 'sup');
                    populateRegulationCheckboxes(opposedRegulationsContainer, profile.opposedRegulations || [], 'opp');
                }
                
                function populateRegulationCheckboxes(container, savedData, prefix) {
                    container.querySelectorAll('input[type="checkbox"][data-prefix]').forEach(cb => {
                        const savedReg = savedData.find(r => r.regulation === cb.value);
                        const index = cb.dataset.index;
                        const caveatBtn = document.querySelector(`.add-caveat-btn[data-index="${index}"][data-prefix="${prefix}"]`);
                        const caveatSection = document.getElementById(`caveat-section-${prefix}-${index}`);
                        const caveatInput = document.getElementById(`caveat-${prefix}-${index}`);

                        cb.checked = !!savedReg;

                        if (cb.checked) {
                            caveatBtn.style.display = 'inline-block';
                        } else {
                            caveatBtn.style.display = 'none';
                        }

                        if (savedReg && savedReg.caveat) {
                            caveatSection.classList.remove('hidden');
                            caveatInput.value = savedReg.caveat;
                        } else {
                            caveatSection.classList.add('hidden');
                            caveatInput.value = '';
                        }
                    });
                }

                function populateToneAndPersonality() {
                    TONE_AND_PERSONALITY_DATA.primary_tones.forEach(tone => {
                        const option = document.createElement('option');
                        option.value = tone.code;
                        option.textContent = `${tone.name} (${tone.how_it_feels})`;
                        primaryToneSelect.appendChild(option);
                    });

                    personalityElementsContainer.innerHTML = '';
                    TONE_AND_PERSONALITY_DATA.personality_elements.forEach(p => {
                        const label = document.createElement('label');
                        label.innerHTML = `<input type="checkbox" value="${p.code}"> ${p.name} - <i>${p.short_descriptor}</i>`;
                        personalityElementsContainer.appendChild(label);
                    });
                }

                function populateRegulations() {
                    const createRegulationHTML = (container, prefix) => {
                        container.innerHTML = '';
                        REGULATION_OPTIONS.forEach((reg, index) => {
                            const div = document.createElement('div');
                            div.innerHTML = `
                                <label>
                                    <input type="checkbox" value="${reg}" data-index="${index}" data-prefix="${prefix}"> ${reg}
                                    <button type="button" class="add-caveat-btn" data-prefix="${prefix}" data-index="${index}">Add Caveat</button>
                                </label>
                                <div class="caveat-section hidden" id="caveat-section-${prefix}-${index}">
                                    <input type="text" id="caveat-${prefix}-${index}" placeholder="Your modification...">
                                </div>
                            `;
                            container.appendChild(div);
                        });
                    };
                    createRegulationHTML(supportedRegulationsContainer, 'sup');
                    createRegulationHTML(opposedRegulationsContainer, 'opp');
                    
                    // Add event listeners for showing/hiding caveat buttons and sections
                    document.querySelectorAll('.checkbox-group input[type="checkbox"][data-prefix]').forEach(checkbox => {
                        const index = checkbox.dataset.index;
                        const prefix = checkbox.dataset.prefix;
                        const caveatBtn = document.querySelector(`.add-caveat-btn[data-index="${index}"][data-prefix="${prefix}"]`);
                        const caveatSection = document.getElementById(`caveat-section-${prefix}-${index}`);
                        const caveatInput = document.getElementById(`caveat-${prefix}-${index}`);

                        checkbox.addEventListener('change', (e) => {
                            if (e.target.checked) {
                                caveatBtn.style.display = 'inline-block';
                            } else {
                                caveatBtn.style.display = 'none';
                                caveatSection.classList.add('hidden');
                                caveatInput.value = '';
                            }
                        });
                    });

                    document.querySelectorAll('.add-caveat-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            const section = document.getElementById(`caveat-section-${e.target.dataset.prefix}-${e.target.dataset.index}`);
                            section.classList.toggle('hidden');
                        });
                    });
                }

                async function loadContactLists() {
                    try {
                        const snapshot = await firestore.collection('contact_lists').get();
                        snapshot.forEach(doc => {
                            const listId = doc.id;
                            const listData = doc.data();
                            const match = listId.match(/^(\d+)_(.+)$/);
                            if (match) {
                                const priority = parseInt(match[1], 10);
                                const title = match[2].replace(/_/g, ' ');
                                contactLists.set(listId, { priority, title, reps: listData.reps });
                            }
                        });
                        // Sort the map by priority
                        contactLists = new Map([...contactLists.entries()].sort((a, b) => a[1].priority - b[1].priority));
                    } catch (error) {
                        console.error("Error loading contact lists from Firestore:", error);
                        alert("Failed to load contact lists from the database. Please check your internet connection and refresh.");
                        document.getElementById('loader').style.display = 'none';
                    }
                }

                async function loadDataFromAllSources() {
                    if (currentUser) {
                        const snapshot = await db.ref(`devices/${deviceId}/latest`).once('value');
                        const firebaseData = snapshot.val();
                        if (firebaseData) {
                            console.log("Loading data from Firebase.");
                            userProfile = firebaseData.userProfile || {};
                            contactLists.forEach((list, key) => {
                                list.reps = firebaseData.contactLists?.[key]?.reps || list.reps.map(rep => ({ ...rep, called: false, emailed: false, response: 'not_selected', notes: '' }));
                            });
                            localStorage.setItem('sb3UserData', JSON.stringify(firebaseData));
                            return;
                        }
                    }
                    
                    console.log("Loading data from Local Storage.");
                    const localData = JSON.parse(localStorage.getItem('sb3UserData') || '{}');
                    userProfile = localData.userProfile || { onboardingComplete: false };
                    contactLists.forEach((list, key) => {
                        list.reps = localData.contactLists?.[key]?.reps || list.reps.map(rep => ({ ...rep, called: false, emailed: false, response: 'not_selected', notes: '' }));
                    });

                    if (!userProfile.onboardingComplete) {
                        onboardingModal.style.display = 'block';
                        updateModalStepVisibility();
                    }
                }

                function saveDataToAllStorages() {
                    const dataToSave = {
                        userProfile: userProfile,
                        contactLists: Object.fromEntries(contactLists),
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    localStorage.setItem('sb3UserData', JSON.stringify(dataToSave));
                    console.log("Data saved to Local Storage.");

                    if (currentUser && deviceId) {
                        db.ref(`devices/${deviceId}/latest`).set(dataToSave)
                            .then(() => console.log("Data saved to Firebase (latest)."))
                            .catch(error => console.error("Error saving 'latest' data to Firebase:", error));
                        db.ref(`devices/${deviceId}/history`).push(dataToSave);
                    }
                }
                
                const responseOptions = ['', 'For', 'Against', 'Not Advised/Neutral', 'No Stance Yet', 'Left Voicemail', 'Other'];
                const modalResponseSelect = document.getElementById('modalResponseSelect');
                responseOptions.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/^$/, 'not_selected');
                    option.textContent = val || 'Select Response...';
                    modalResponseSelect.appendChild(option);
                });

                // --- Event Listeners for Modals and Buttons ---
                document.getElementById('closeResponseModal').onclick = () => responseModal.style.display = 'none';
                document.getElementById('cancelResponseModal').onclick = () => responseModal.style.display = 'none';
                document.getElementById('saveResponseModal').onclick = function() {
                    const repId = document.getElementById('currentRepIdForModal').value;
                    const listIdentifier = document.getElementById('currentListIdentifierForModal').value;
                    if (!repId || !listIdentifier) return;
                    const currentList = getRepresentativeListByIdentifier(listIdentifier);
                    const repIndex = currentList.findIndex(r => r.id === repId);
                    if (repIndex === -1) return;
                    currentList[repIndex].response = modalResponseSelect.value;
                    currentList[repIndex].notes = document.getElementById('modalNotesTextarea').value;
                    const table = document.getElementById(`repsTable-${listIdentifier}`);
                    if (table) {
                        const tableBody = table.getElementsByTagName('tbody')[0];
                        const row = tableBody.querySelector(`tr[data-id="${repId}"]`);
                        if (row) updateResponseSummaryCell(row.cells[row.cells.length - 1], currentList[repIndex]);
                    }
                    responseModal.style.display = 'none';
                    saveDataToAllStorages();
                };

                document.getElementById('closeGuideModal').onclick = () => guideModal.style.display = 'none';
                document.getElementById('dismissGuideModal').onclick = () => guideModal.style.display = 'none';

                window.onclick = function(event) {
                    if (event.target == responseModal) responseModal.style.display = 'none';
                    if (event.target == onboardingModal) onboardingModal.style.display = 'none';
                    if (event.target == guideModal) guideModal.style.display = 'none';
                };

                function exportDataHandler() {
                    saveDataToAllStorages(); 
                    const dataStr = JSON.stringify({
                        userProfile,
                        contactLists: Object.fromEntries(contactLists),
                        emailSubject: emailSubjectTemplateInput.value,
                        emailBody: emailBodyTemplateInput.value
                    }, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', 'sb3_call_tracker_progress.json');
                    linkElement.click();
                    linkElement.remove();
                    closeNav();
                }

                function importDataHandler(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            userProfile = importedData.userProfile || { onboardingComplete: false };
                            
                            // Re-hydrate the map from the imported object
                            if (importedData.contactLists) {
                                for (const key in importedData.contactLists) {
                                    if (contactLists.has(key)) {
                                        const existingList = contactLists.get(key);
                                        existingList.reps = importedData.contactLists[key].reps;
                                    }
                                }
                            }

                            emailSubjectTemplateInput.value = importedData.emailSubject || "";
                            emailBodyTemplateInput.value = importedData.emailBody || "";
                            
                            saveDataToAllStorages();
                            renderAllTables();
                            populateOnboardingForm();
                            alert('Progress imported successfully!');
                        } catch (error) {
                            alert('Error importing file.');
                            console.error('Import Error:', error);
                        }
                        sideNavImportInput.value = '';
                    };
                    reader.readAsText(file);
                    closeNav();
                }

                function resetDataHandler() {
                    if (confirm('Are you sure you want to reset all data? This will clear local storage and attempt to clear Firebase data for this device. This cannot be undone.')) {
                        localStorage.clear();
                        if (currentUser && deviceId) {
                            db.ref(`devices/${deviceId}`).remove();
                        }
                        deviceId = null;
                        localStorage.removeItem('sb3CallToolDeviceId');
                        window.location.reload();
                    }
                    closeNav();
                }

                async function displayYourReps() {
                    // TODO: Replace this with a proper lookup table or a different API
                    const container = document.getElementById('your-representatives-container');
                    if (!userProfile.zipCode) {
                        container.classList.add('hidden');
                        return;
                    }

                    const representatives = [
                        { id: 'placeholder-1', name: 'Placeholder Rep 1', party: 'N/A', phone: 'N/A', email: 'N/A', district: 'Placeholder District 1' },
                        { id: 'placeholder-2', name: 'Placeholder Rep 2', party: 'N/A', phone: 'N/A', email: 'N/A', district: 'Placeholder District 2' }
                    ];

                    if (representatives && representatives.length > 0) {
                        container.innerHTML = `
                                <h2 style="text-align: center; margin-top: 40px; color: var(--accent-green);">Your State Representatives</h2>
                                <div class="table-container">
                                    <table id="repsTable-your-reps">
                                        <thead>
                                            <tr>
                                                <th>Called</th>
                                                <th>Emailed</th>
                                                <th>District</th>
                                                <th>Representative</th>
                                                <th>Party</th>
                                                <th>Email</th>
                                                <th>Phone</th>
                                                <th>Response Summary</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>`;
                        
                        const tableBody = container.querySelector('tbody');
                        renderTable(tableBody, representatives, 'your-reps');
                        container.classList.remove('hidden');
                    } else {
                        container.classList.add('hidden');
                    }
                }

                function renderAllTables() {
                    dynamicTablesContainer.innerHTML = '';
                    contactLists.forEach((list, listIdentifier) => {
                        const tableContainer = document.createElement('div');
                        tableContainer.className = 'table-container';
                        tableContainer.innerHTML = `
                            <h2 style="text-align: center; margin-top: 40px; color: var(--accent-green);">${list.title}</h2>
                            <div class="table-container">
                                <table id="repsTable-${listIdentifier}">
                                    <thead>
                                        <tr>
                                            <th>Called</th>
                                            <th>Emailed</th>
                                            <th>District</th>
                                            <th>Representative</th>
                                            <th>Party</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Response Summary</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        `;
                        dynamicTablesContainer.appendChild(tableContainer);
                        const tableBody = tableContainer.querySelector('tbody');
                        renderTable(tableBody, list.reps, listIdentifier);
                    });
                }

                function renderTable(tableBodyElement, dataArray, listIdentifier) {
                    if (!tableBodyElement) return;
                    tableBodyElement.innerHTML = ''; 
                    dataArray.forEach((rep) => {
                        const row = tableBodyElement.insertRow();
                        row.setAttribute('data-id', rep.id);
                        row.setAttribute('data-list', listIdentifier);
                        const cellCalled = row.insertCell();
                        const calledCheckbox = document.createElement('input');
                        calledCheckbox.type = 'checkbox';
                        calledCheckbox.checked = !!rep.called;
                        calledCheckbox.dataset.repId = rep.id;
                        calledCheckbox.dataset.list = listIdentifier;
                        calledCheckbox.addEventListener('change', handleCalledChange);
                        cellCalled.appendChild(calledCheckbox);
                        const cellEmailed = row.insertCell();
                        const emailedCheckbox = document.createElement('input');
                        emailedCheckbox.type = 'checkbox';
                        emailedCheckbox.checked = !!rep.emailed;
                        emailedCheckbox.dataset.repId = rep.id;
                        emailedCheckbox.dataset.list = listIdentifier;
                        emailedCheckbox.addEventListener('change', handleEmailedChange);
                        cellEmailed.appendChild(emailedCheckbox);
                        row.insertCell().textContent = rep.district;
                        row.insertCell().textContent = rep.name || 'N/A';
                        row.insertCell().textContent = rep.party;
                        const cellEmail = row.insertCell();
                        const emailLink = document.createElement('a');
                        emailLink.href = "#"; 
                        emailLink.textContent = rep.email;
                        emailLink.dataset.email = rep.email;
                        emailLink.dataset.repName = rep.name || 'N/A';
                        emailLink.dataset.repId = rep.id;
                        emailLink.dataset.list = listIdentifier;
                        emailLink.classList.add('email-link');
                        emailLink.addEventListener('click', handleEmailClick);
                        cellEmail.appendChild(emailLink);
                        const cellPhone = row.insertCell();
                        const phoneLink = document.createElement('a');
                        phoneLink.href = `tel:${(rep.phone || '').replace(/\D/g, '')}`;
                        phoneLink.textContent = rep.phone || 'N/A';
                        cellPhone.appendChild(phoneLink);
                        const cellResponseSummary = row.insertCell();
                        cellResponseSummary.classList.add('response-summary-cell');
                        updateResponseSummaryCell(cellResponseSummary, rep);
                    });
                }

                function updateResponseSummaryCell(cell, rep) {
                    if (rep.called) { 
                        let summaryText = 'N/A';
                        const selectedOptionText = responseOptions.find(opt => opt.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/^$/, 'not_selected') === rep.response);
                        summaryText = selectedOptionText || (rep.response !== 'not_selected' ? String(rep.response).replace(/_/g, ' ') : 'No response logged');
                        let summary = `Response: ${summaryText}`;
                        if (rep.notes) summary += `<br>Notes: ${String(rep.notes).substring(0, 35)}${String(rep.notes).length > 35 ? '...' : ''}`;
                        cell.innerHTML = summary;
                    } else {
                        cell.innerHTML = '<i>Not called yet</i>';
                    }
                }
                
                function getRepresentativeListByIdentifier(listIdentifier) {
                    return contactLists.get(listIdentifier)?.reps || [];
                }

                function handleCalledChange(event) {
                    const repId = event.target.dataset.repId;
                    const listIdentifier = event.target.dataset.list;
                    const currentList = getRepresentativeListByIdentifier(listIdentifier);
                    const repIndex = currentList.findIndex(r => r.id === repId);
                    if (repIndex === -1) return;
                    const rep = currentList[repIndex];
                    rep.called = event.target.checked;
                    const row = event.target.closest('tr'); 
                    const summaryCell = row ? row.cells[row.cells.length -1] : null; 
                    if (rep.called) { 
                        document.getElementById('currentRepIdForModal').value = rep.id;
                        document.getElementById('currentListIdentifierForModal').value = listIdentifier;
                        document.getElementById('responseModalTitle').textContent = `Log Response: ${rep.name}`;
                        modalResponseSelect.value = rep.response || 'not_selected';
                        document.getElementById('modalNotesTextarea').value = rep.notes || '';
                        responseModal.style.display = 'block';
                    } else { 
                        rep.response = 'not_selected';
                        rep.notes = '';
                        if (summaryCell) updateResponseSummaryCell(summaryCell, rep);
                    }
                    saveDataToAllStorages();
                }

                function handleEmailedChange(event) {
                    const repId = event.target.dataset.repId;
                    const listIdentifier = event.target.dataset.list;
                    const currentList = getRepresentativeListByIdentifier(listIdentifier);
                    const repIndex = currentList.findIndex(r => r.id === repId);
                    if (repIndex !== -1) {
                        currentList[repIndex].emailed = event.target.checked;
                        saveDataToAllStorages();
                    }
                }
                
                async function handleEmailClick(event) {
                    event.preventDefault();
                    const targetLink = event.currentTarget;
                    const repId = targetLink.dataset.repId;
                    const listIdentifier = targetLink.dataset.list;
                    const currentList = getRepresentativeListByIdentifier(listIdentifier);
                    const rep = currentList.find(r => r.id === repId);

                    if (!userProfile.onboardingComplete) {
                        alert("Please complete your Communications Profile from 'Edit My Info' before generating emails.");
                        editMyInfoButton.click();
                        return;
                    }

                    const emailGenModal = document.getElementById('emailGenerationModal');
                    const spinner = document.getElementById('emailGenSpinner');
                    const content = document.getElementById('emailGenContent');
                    
                    emailGenModal.style.display = 'block';
                    spinner.classList.remove('hidden');
                    content.classList.add('hidden');

                    if (llmToggle.checked) {
                        try {
                            const generateEmail = functions.httpsCallable('generateEmail');
                            const result = await generateEmail({ userProfile, representative: rep });
                            
                            document.getElementById('generatedSubject').value = result.data.subject;
                            document.getElementById('generatedBody').value = result.data.body;

                            spinner.classList.add('hidden');
                            content.classList.remove('hidden');

                            document.getElementById('approveAndSendEmail').onclick = () => {
                                const finalSubject = document.getElementById('generatedSubject').value;
                                const finalBody = document.getElementById('generatedBody').value;

                                if (!userProfile.approvedEmails) {
                                    userProfile.approvedEmails = [];
                                }
                                userProfile.approvedEmails.push({
                                    repName: rep.name,
                                    subject: finalSubject,
                                    body: finalBody,
                                    timestamp: new Date().toISOString()
                                });

                                const repIndex = currentList.findIndex(r => r.id === repId);
                                if (repIndex !== -1) {
                                    currentList[repIndex].emailed = true;
                                    const row = targetLink.closest('tr');
                                    const emailedCheckboxInRow = row ? row.querySelector('td:nth-child(2) input[type="checkbox"]') : null;
                                    if (emailedCheckboxInRow) emailedCheckboxInRow.checked = true;
                                }
                                
                                saveDataToAllStorages();
                                
                                window.location.href = `mailto:${rep.email}?subject=${encodeURIComponent(finalSubject)}&body=${encodeURIComponent(finalBody)}`;
                                emailGenModal.style.display = 'none';
                            };

                        } catch (error) {
                            console.error("Error calling generateEmail function:", error);
                            alert("Failed to generate email. Please try again later.");
                            emailGenModal.style.display = 'none';
                        }
                    } else {
                        // Use the template
                        let subject = emailSubjectTemplateInput.value;
                        let body = emailBodyTemplateInput.value;

                        subject = subject.replace(/{repName}/g, rep.name)
                                       .replace(/{userName}/g, userProfile.userFullName || 'a concerned constituent')
                                       .replace(/{userLocation}/g, userProfile.userLocation || 'Texas');

                        body = body.replace(/{repName}/g, rep.name)
                                   .replace(/{userName}/g, userProfile.userFullName || 'a concerned constituent')
                                   .replace(/{userLocation}/g, userProfile.userLocation || 'Texas');

                        document.getElementById('generatedSubject').value = subject;
                        document.getElementById('generatedBody').value = body;

                        spinner.classList.add('hidden');
                        content.classList.remove('hidden');

                        document.getElementById('approveAndSendEmail').onclick = () => {
                            const finalSubject = document.getElementById('generatedSubject').value;
                            const finalBody = document.getElementById('generatedBody').value;

                            const repIndex = currentList.findIndex(r => r.id === repId);
                            if (repIndex !== -1) {
                                currentList[repIndex].emailed = true;
                                const row = targetLink.closest('tr');
                                const emailedCheckboxInRow = row ? row.querySelector('td:nth-child(2) input[type="checkbox"]') : null;
                                if (emailedCheckboxInRow) emailedCheckboxInRow.checked = true;
                            }
                            
                            saveDataToAllStorages();
                            
                            window.location.href = `mailto:${rep.email}?subject=${encodeURIComponent(finalSubject)}&body=${encodeURIComponent(finalBody)}`;
                            emailGenModal.style.display = 'none';
                        };
                    }
                }
                
                async function fetchAndProcessData(fileUrl, listIdentifier) {
                    try {
                        const response = await fetch(fileUrl);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${fileUrl}`);
                        const jsonData = await response.json();
                        return jsonData.map((rep, index) => ({
                            id: `${listIdentifier}-${index}-${rep.district}`, 
                            district: rep.district, name: rep.representative_name, phone: rep.phone_number,
                            party: rep.party, email: rep.email, list: listIdentifier 
                        }));
                    } catch (error) {
                        console.error(`Error fetching initial data for ${listIdentifier} from ${fileUrl}:`, error);
                        return [];
                    }
                }

                initializeApp().catch(e => {
                    alert("CRITICAL ERROR during app initialization: " + e.message);
                    console.error("CRITICAL ERROR during app initialization:", e);
                });
            });
        } catch (e) {
            alert("CRITICAL ERROR SETTING UP DOMContentLoaded: " + e.message);
            console.error("CRITICAL ERROR SETTING UP DOMContentLoaded:", e);
        }
    </script>
</body>
</html>
